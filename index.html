// ========================================
// GUIDE D'INT√âGRATION FIREBASE
// ========================================

// √âTAPE 1 : Configuration Firebase
// ---------------------------------
// 1. Allez sur https://console.firebase.google.com/
// 2. Cr√©ez un nouveau projet ou s√©lectionnez-en un existant
// 3. Allez dans "Project Settings" (‚öôÔ∏è) > "Your apps" > "Web app" (</>)
// 4. Enregistrez votre app et copiez la configuration

// √âTAPE 2 : Ajouter Firebase dans votre HTML
// -------------------------------------------
// Ajoutez ces scripts AVANT la balise </body> dans votre HTML :

/*
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
*/

// √âTAPE 3 : Configuration Firebase
// ---------------------------------

// Remplacez par VOTRE configuration Firebase
const firebaseConfig = {
  apiKey: "VOTRE_API_KEY",
  authDomain: "votre-projet.firebaseapp.com",
  projectId: "votre-projet-id",
  storageBucket: "votre-projet.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};

// Initialiser Firebase
let firebaseApp, auth, db, storage;
let currentUser = null;
let syncEnabled = false;

function initFirebase() {
    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        
        console.log('‚úÖ Firebase initialis√© avec succ√®s');
        
        // √âcouter les changements d'authentification
        auth.onAuthStateChanged(function(user) {
            if (user) {
                currentUser = user;
                syncEnabled = true;
                console.log('‚úÖ Utilisateur connect√©:', user.email);
                afficherBoutonSync(true);
                // Synchroniser automatiquement au d√©marrage
                synchroniserVersCloud();
            } else {
                currentUser = null;
                syncEnabled = false;
                console.log('‚ÑπÔ∏è Aucun utilisateur connect√©');
                afficherBoutonSync(false);
            }
        });
        
        return true;
    } catch (error) {
        console.error('‚ùå Erreur initialisation Firebase:', error);
        return false;
    }
}

// ========================================
// SYST√àME D'AUTHENTIFICATION
// ========================================

// Connexion avec Email/Password
async function connexionEmailPassword(email, password) {
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('‚úÖ Connexion r√©ussie');
        alert('‚úÖ Connexion r√©ussie ! Vos donn√©es vont √™tre synchronis√©es.');
        return userCredential.user;
    } catch (error) {
        console.error('‚ùå Erreur connexion:', error);
        let message = 'Erreur de connexion';
        
        switch(error.code) {
            case 'auth/user-not-found':
                message = 'Aucun compte trouv√© avec cet email';
                break;
            case 'auth/wrong-password':
                message = 'Mot de passe incorrect';
                break;
            case 'auth/invalid-email':
                message = 'Email invalide';
                break;
            case 'auth/user-disabled':
                message = 'Ce compte a √©t√© d√©sactiv√©';
                break;
            default:
                message = error.message;
        }
        
        alert('‚ùå ' + message);
        return null;
    }
}

// Inscription avec Email/Password
async function inscriptionEmailPassword(email, password) {
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log('‚úÖ Inscription r√©ussie');
        alert('‚úÖ Compte cr√©√© avec succ√®s ! Bienvenue !');
        return userCredential.user;
    } catch (error) {
        console.error('‚ùå Erreur inscription:', error);
        let message = 'Erreur d\'inscription';
        
        switch(error.code) {
            case 'auth/email-already-in-use':
                message = 'Cet email est d√©j√† utilis√©';
                break;
            case 'auth/invalid-email':
                message = 'Email invalide';
                break;
            case 'auth/weak-password':
                message = 'Le mot de passe doit contenir au moins 6 caract√®res';
                break;
            default:
                message = error.message;
        }
        
        alert('‚ùå ' + message);
        return null;
    }
}

// Connexion Google
async function connexionGoogle() {
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        console.log('‚úÖ Connexion Google r√©ussie');
        alert('‚úÖ Connexion Google r√©ussie !');
        return result.user;
    } catch (error) {
        console.error('‚ùå Erreur connexion Google:', error);
        alert('‚ùå Erreur de connexion Google: ' + error.message);
        return null;
    }
}

// D√©connexion
async function deconnexion() {
    try {
        await auth.signOut();
        console.log('‚úÖ D√©connexion r√©ussie');
        alert('‚úÖ D√©connexion r√©ussie');
    } catch (error) {
        console.error('‚ùå Erreur d√©connexion:', error);
        alert('‚ùå Erreur de d√©connexion');
    }
}

// R√©initialiser mot de passe
async function resetMotDePasse(email) {
    try {
        await auth.sendPasswordResetEmail(email);
        alert('‚úÖ Email de r√©initialisation envoy√© ! V√©rifiez votre bo√Æte mail.');
    } catch (error) {
        console.error('‚ùå Erreur reset password:', error);
        alert('‚ùå Erreur: ' + error.message);
    }
}

// ========================================
// SYNCHRONISATION DES DONN√âES
// ========================================

// Synchroniser VERS le cloud (Upload)
async function synchroniserVersCloud() {
    if (!currentUser) {
        alert('‚ö†Ô∏è Vous devez √™tre connect√© pour synchroniser');
        return false;
    }

    try {
        console.log('üîÑ D√©but synchronisation vers cloud...');
        
        const userId = currentUser.uid;
        const timestamp = new Date().toISOString();

        // Pr√©parer toutes les donn√©es
        const donneesASync = {
            userData: userData,
            pesees: pesees,
            produitsSauvegardes: produitsSauvegardes,
            produitsPerso: produitsPerso,
            produitsFrigo: produitsFrigo,
            repasSauvegardes: repasSauvegardes,
            recettesFavorites: recettesFavorites,
            corrections: corrections,
            lastSync: timestamp
        };

        // Sauvegarder dans Firestore
        await db.collection('utilisateurs').doc(userId).set(donneesASync, { merge: true });

        console.log('‚úÖ Synchronisation r√©ussie');
        localStorage.setItem('lastCloudSync', timestamp);
        
        // Notification de succ√®s
        afficherNotificationSync('‚úÖ Donn√©es synchronis√©es !');
        
        return true;
    } catch (error) {
        console.error('‚ùå Erreur synchronisation:', error);
        alert('‚ùå Erreur de synchronisation: ' + error.message);
        return false;
    }
}

// Synchroniser DEPUIS le cloud (Download)
async function synchroniserDepuisCloud() {
    if (!currentUser) {
        alert('‚ö†Ô∏è Vous devez √™tre connect√©');
        return false;
    }

    try {
        console.log('üîÑ R√©cup√©ration des donn√©es du cloud...');
        
        const userId = currentUser.uid;
        const doc = await db.collection('utilisateurs').doc(userId).get();

        if (!doc.exists) {
            console.log('‚ÑπÔ∏è Aucune donn√©e dans le cloud, premi√®re synchronisation');
            // Premi√®re connexion, envoyer les donn√©es locales
            await synchroniserVersCloud();
            return true;
        }

        const cloudData = doc.data();
        
        // Demander confirmation avant d'√©craser les donn√©es locales
        const confirmer = confirm(
            '‚ö†Ô∏è ATTENTION\n\n' +
            'Cette action va REMPLACER vos donn√©es locales par celles du cloud.\n\n' +
            'Derni√®re sync cloud: ' + (cloudData.lastSync ? new Date(cloudData.lastSync).toLocaleString('fr-FR') : 'Inconnue') + '\n\n' +
            'Voulez-vous continuer ?'
        );

        if (!confirmer) {
            return false;
        }

        // Restaurer les donn√©es
        userData = cloudData.userData || {};
        pesees = cloudData.pesees || [];
        produitsSauvegardes = cloudData.produitsSauvegardes || [];
        produitsPerso = cloudData.produitsPerso || [];
        produitsFrigo = cloudData.produitsFrigo || [];
        repasSauvegardes = cloudData.repasSauvegardes || [];
        recettesFavorites = cloudData.recettesFavorites || [];
        corrections = cloudData.corrections || [];

        // Sauvegarder localement
        localStorage.setItem('userData', JSON.stringify(userData));
        localStorage.setItem('pesees', JSON.stringify(pesees));
        localStorage.setItem('produits', JSON.stringify(produitsSauvegardes));
        localStorage.setItem('produitsPerso', JSON.stringify(produitsPerso));
        localStorage.setItem('produitsFrigo', JSON.stringify(produitsFrigo));
        localStorage.setItem('repas', JSON.stringify(repasSauvegardes));
        localStorage.setItem('recettesFavorites', JSON.stringify(recettesFavorites));
        localStorage.setItem('corrections', JSON.stringify(corrections));

        console.log('‚úÖ Donn√©es restaur√©es depuis le cloud');
        
        afficherNotificationSync('‚úÖ Donn√©es r√©cup√©r√©es du cloud !');
        
        // Rafra√Æchir l'interface
        location.reload();
        
        return true;
    } catch (error) {
        console.error('‚ùå Erreur r√©cup√©ration:', error);
        alert('‚ùå Erreur: ' + error.message);
        return false;
    }
}

// Synchronisation automatique
async function syncAutoVersCloud() {
    if (syncEnabled && currentUser) {
        const lastSync = localStorage.getItem('lastCloudSync');
        const now = new Date().getTime();
        const lastSyncTime = lastSync ? new Date(lastSync).getTime() : 0;
        
        // Synchroniser si plus de 5 minutes depuis la derni√®re sync
        if (now - lastSyncTime > 5 * 60 * 1000) {
            console.log('üîÑ Synchronisation automatique...');
            await synchroniserVersCloud();
        }
    }
}

// Lancer sync auto toutes les 5 minutes
setInterval(syncAutoVersCloud, 5 * 60 * 1000);

// ========================================
// UPLOAD D'IMAGES VERS FIREBASE STORAGE
// ========================================

async function uploadImageProduit(file, produitId) {
    if (!currentUser) {
        alert('‚ö†Ô∏è Vous devez √™tre connect√©');
        return null;
    }

    try {
        const userId = currentUser.uid;
        const storageRef = storage.ref();
        const imageRef = storageRef.child(`images/${userId}/${produitId}.jpg`);
        
        console.log('üì§ Upload image...');
        
        // Upload
        const snapshot = await imageRef.put(file);
        
        // R√©cup√©rer l'URL
        const downloadURL = await snapshot.ref.getDownloadURL();
        
        console.log('‚úÖ Image upload√©e:', downloadURL);
        return downloadURL;
    } catch (error) {
        console.error('‚ùå Erreur upload image:', error);
        alert('‚ùå Erreur upload image');
        return null;
    }
}

// ========================================
// INTERFACE UTILISATEUR
// ========================================

function afficherBoutonSync(connecte) {
    // Supprimer bouton existant s'il y en a un
    const existant = document.getElementById('syncButton');
    if (existant) existant.remove();

    // Cr√©er le bouton de sync
    const bouton = document.createElement('button');
    bouton.id = 'syncButton';
    bouton.style.cssText = `
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: ${connecte ? 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
        color: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        z-index: 9998;
        transition: all 0.3s;
    `;
    bouton.innerHTML = connecte ? '‚òÅÔ∏è' : 'üîí';
    bouton.title = connecte ? 'Synchroniser avec le cloud' : 'Se connecter';
    
    bouton.onmouseover = function() {
        this.style.transform = 'scale(1.1)';
    };
    bouton.onmouseout = function() {
        this.style.transform = 'scale(1)';
    };
    
    bouton.onclick = function() {
        if (connecte) {
            ouvrirMenuSync();
        } else {
            ouvrirModalConnexion();
        }
    };
    
    document.body.appendChild(bouton);
}

function ouvrirModalConnexion() {
    const modal = document.createElement('div');
    modal.id = 'modalConnexion';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10001;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 400px; width: 100%;">
            <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">‚òÅÔ∏è Connexion Cloud</h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Email</label>
                <input type="email" id="emailConnexion" placeholder="votre@email.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Mot de passe</label>
                <input type="password" id="passwordConnexion" placeholder="******" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
            </div>
            
            <button onclick="handleConnexion()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                üîì Se connecter
            </button>
            
            <button onclick="handleInscription()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                ‚ú® Cr√©er un compte
            </button>
            
            <button onclick="handleConnexionGoogle()" style="width: 100%; padding: 15px; background: white; color: #333; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width: 20px; vertical-align: middle; margin-right: 8px;">
                Continuer avec Google
            </button>
            
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" onclick="handleResetPassword()" style="color: #667eea; font-size: 14px; text-decoration: none;">Mot de passe oubli√© ?</a>
            </div>
            
            <button onclick="fermerModalConnexion()" style="width: 100%; padding: 12px; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; margin-top: 20px;">
                Fermer
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function fermerModalConnexion() {
    const modal = document.getElementById('modalConnexion');
    if (modal) modal.remove();
}

async function handleConnexion() {
    const email = document.getElementById('emailConnexion').value;
    const password = document.getElementById('passwordConnexion').value;
    
    if (!email || !password) {
        alert('‚ö†Ô∏è Veuillez remplir tous les champs');
        return;
    }
    
    const user = await connexionEmailPassword(email, password);
    if (user) {
        fermerModalConnexion();
    }
}

async function handleInscription() {
    const email = document.getElementById('emailConnexion').value;
    const password = document.getElementById('passwordConnexion').value;
    
    if (!email || !password) {
        alert('‚ö†Ô∏è Veuillez remplir tous les champs');
        return;
    }
    
    if (password.length < 6) {
        alert('‚ö†Ô∏è Le mot de passe doit contenir au moins 6 caract√®res');
        return;
    }
    
    const user = await inscriptionEmailPassword(email, password);
    if (user) {
        fermerModalConnexion();
    }
}

async function handleConnexionGoogle() {
    const user = await connexionGoogle();
    if (user) {
        fermerModalConnexion();
    }
}

async function handleResetPassword() {
    const email = prompt('Entrez votre email pour r√©initialiser le mot de passe :');
    if (email) {
        await resetMotDePasse(email);
    }
}

function ouvrirMenuSync() {
    const modal = document.createElement('div');
    modal.id = 'modalSync';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10001;
        padding: 20px;
    `;
    
    const lastSync = localStorage.getItem('lastCloudSync');
    const lastSyncDate = lastSync ? new Date(lastSync).toLocaleString('fr-FR') : 'Jamais';
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 30px; max-width: 450px; width: 100%;">
            <h2 style="color: #4caf50; margin-bottom: 20px; text-align: center;">‚òÅÔ∏è Synchronisation Cloud</h2>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="color: #2e7d32; margin: 0; font-size: 14px;">
                    ‚úÖ Connect√© en tant que:<br>
                    <strong>${currentUser.email}</strong>
                </p>
                <p style="color: #666; margin: 10px 0 0 0; font-size: 12px;">
                    Derni√®re sync: ${lastSyncDate}
                </p>
            </div>
            
            <button onclick="handleSyncVersCloud()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                üì§ Envoyer mes donn√©es vers le cloud
            </button>
            
            <button onclick="handleSyncDepuisCloud()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                üì• R√©cup√©rer les donn√©es du cloud
            </button>
            
            <button onclick="handleDeconnexion()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff4757 0%, #e84118 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;">
                üîí Se d√©connecter
            </button>
            
            <button onclick="fermerMenuSync()" style="width: 100%; padding: 12px; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-size: 14px; cursor: pointer; margin-top: 20px;">
                Fermer
            </button>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <p style="color: #856404; margin: 0; font-size: 12px; line-height: 1.6;">
                    üí° <strong>Info :</strong> Vos donn√©es sont automatiquement synchronis√©es toutes les 5 minutes quand vous √™tes connect√©.
                </p>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function fermerMenuSync() {
    const modal = document.getElementById('modalSync');
    if (modal) modal.remove();
}

async function handleSyncVersCloud() {
    const success = await synchroniserVersCloud();
    if (success) {
        fermerMenuSync();
    }
}

async function handleSyncDepuisCloud() {
    await synchroniserDepuisCloud();
    fermerMenuSync();
}

async function handleDeconnexion() {
    if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
        await deconnexion();
        fermerMenuSync();
    }
}

function afficherNotificationSync(message) {
    const notif = document.createElement('div');
    notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        z-index: 10002;
        font-weight: 600;
        animation: slideInRight 0.3s;
    `;
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transition = 'opacity 0.3s';
        setTimeout(() => notif.remove(), 300);
    }, 3000);
}

// ========================================
// INITIALISATION AU CHARGEMENT
// ========================================

// Appeler cette fonction au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initFirebase();
});

// ========================================
// R√àGLES DE S√âCURIT√â FIRESTORE
// ========================================

/*
Copiez ces r√®gles dans Firebase Console > Firestore Database > Rules :

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // R√®gle pour les utilisateurs
    match /utilisateurs/{userId} {
      // Un utilisateur peut lire et √©crire uniquement ses propres donn√©es
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
*/

// ========================================
// R√àGLES DE S√âCURIT√â STORAGE
// ========================================

/*
Copiez ces r√®gles dans Firebase Console > Storage > Rules :

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /images/{userId}/{allPaths=**} {
      // Un utilisateur peut lire et √©crire uniquement ses propres images
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
*/
