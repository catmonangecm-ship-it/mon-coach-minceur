<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Coach Minceur - Le Secret du Poids</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            background: #f0f0f0;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab:hover {
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .result-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .result-box.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        .result-box h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .weight-entry {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .weight-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .weight-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weight-item .date {
            font-weight: 600;
            color: #667eea;
        }

        .weight-item .weight {
            font-size: 1.2em;
            font-weight: bold;
        }

        .weight-item .delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        canvas {
            max-width: 100%;
            margin-top: 20px;
        }

        .conseil-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .conseil-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .conseil-card p {
            color: #555;
            line-height: 1.6;
        }

        .motivation-box {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .motivation-box .quote {
            font-size: 1.3em;
            font-style: italic;
            color: #333;
            margin-bottom: 10px;
        }

        .motivation-box .author {
            color: #666;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .menu-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .menu-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .menu-card ul {
            list-style: none;
            padding-left: 0;
        }

        .menu-card li {
            padding: 5px 0;
            color: #555;
        }

        .menu-card li:before {
            content: "‚úì ";
            color: #4caf50;
            font-weight: bold;
        }

        /* Styles sp√©cifiques au scanner */
        #scannerContainer {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }

        #interactive {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }

        #interactive video {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        #interactive canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .drawingBuffer {
            display: none;
        }

        /* Guide visuel pour le scan */
        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 100px;
            border: 3px solid #4caf50;
            border-radius: 10px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .scan-guide::after {
            content: "Placez le code-barres ici";
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }

            .weight-entry {
                grid-template-columns: 1fr;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 8px 25px rgba(255, 0, 110, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 12px 35px rgba(255, 0, 110, 0.6);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 8px 25px rgba(255, 0, 110, 0.4);
            }
        }

        /* Animations pour les c√©l√©brations */
        @keyframes firework {
            0% { 
                transform: translate(0, 0) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(var(--x), var(--y)) scale(1);
                opacity: 1;
            }
            100% { 
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes slideInRight {
            0% {
                transform: translateX(100px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .firework {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: firework 1.5s ease-out forwards;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 9999;
            animation: confetti-fall 3s linear forwards;
        }

        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .celebration-modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: bounce 0.5s ease-out;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        /* Modal de correction */
        .correction-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            padding: 20px;
        }

        .correction-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .debug-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="background: linear-gradient(135deg, #ff006e 0%, #ff6ec7 100%); padding: 15px 30px; border-radius: 25px; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(255, 0, 110, 0.4); animation: pulse 2s infinite; display: inline-block;">
                <h3 style="color: white; font-size: 1.8em; text-shadow: 3px 3px 6px rgba(0,0,0,0.3); letter-spacing: 2px; margin: 0;">
                    üê± CATJER LA CHATTE QUI RUGIT EN CUISINE üê±
                </h3>
            </div>
            <h1>üí™ Mon Coach Minceur</h1>
            <p>Votre programme personnalis√© pour atteindre vos objectifs</p>
            
            <a href="https://t.me/+votre_lien_telegram" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #0088cc 0%, #00b4ff 100%); color: white; padding: 15px 35px; border-radius: 30px; text-decoration: none; font-size: 1.1em; font-weight: bold; margin-top: 20px; box-shadow: 0 5px 20px rgba(0, 136, 204, 0.4); transition: all 0.3s; animation: pulse 2s infinite;">
                üì± Rejoins notre communaut√© Telegram
            </a>

            <!-- Navigation Rapide Intelligente -->
            <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; margin-top: 25px;">
                <div style="color: white; font-weight: 600; margin-bottom: 12px; font-size: 1.1em;">‚ö° Actions Rapides</div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="actionRapide('scanner')" style="background: rgba(255,255,255,0.95); color: #667eea; border: none; padding: 10px 18px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: all 0.2s; box-shadow: 0 3px 10px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.2)'">
                        üì∑ Scanner un Produit
                    </button>
                    <button onclick="actionRapide('calculateur')" style="background: rgba(255,255,255,0.95); color: #4caf50; border: none; padding: 10px 18px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: all 0.2s; box-shadow: 0 3px 10px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.2)'">
                        üßÆ Calculer mes Calories
                    </button>
                    <button onclick="actionRapide('frigo')" style="background: rgba(255,255,255,0.95); color: #ff6b6b; border: none; padding: 10px 18px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: all 0.2s; box-shadow: 0 3px 10px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.2)'">
                        üç≥ G√©n√©rer une Recette
                    </button>
                    <button onclick="actionRapide('coach')" style="background: rgba(255,255,255,0.95); color: #f5576c; border: none; padding: 10px 18px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: all 0.2s; box-shadow: 0 3px 10px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.2)'">
                        ü§ñ Mes Suggestions
                    </button>
                    <button onclick="actionRapide('progression')" style="background: rgba(255,255,255,0.95); color: #764ba2; border: none; padding: 10px 18px; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 0.95em; transition: all 0.2s; box-shadow: 0 3px 10px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0,0,0,0.2)'">
                        üìà Ma Progression
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('profil')">üìä Mon Profil</button>
                <button class="tab" onclick="showTab('suivi')">üìà Suivi du Poids</button>
                <button class="tab" onclick="showTab('calculateur')">üßÆ Calculateur Calories</button>
                <button class="tab" onclick="showTab('scanner')">üì∑ Scanner Produit</button>
                <button class="tab" onclick="showTab('frigo')">üç≥ Frigo & Recettes</button>
                <button class="tab" onclick="showTab('baseperso')">üìù Ma Base Perso</button>
                <button class="tab" onclick="showTab('coachai')">ü§ñ Coach IA</button>
                <button class="tab" onclick="showTab('calendrier')">üìÖ Calendrier Saisonnier</button>
                <button class="tab" onclick="showTab('conseils')">ü•ó Conseils Nutrition</button>
                <button class="tab" onclick="showTab('motivation')">üí™ Motivation</button>
                <button class="tab" onclick="showTab('menus')">üçΩÔ∏è Menus Types</button>
                <button class="tab" onclick="showTab('calories')">üìñ Base Calories</button>
            </div>

            <!-- Onglet Profil -->
            <div id="profil" class="tab-content active">
                <h2>Cr√©ez votre profil personnalis√©</h2>
                
                <div class="form-group">
                    <label>Nom / Pr√©nom</label>
                    <input type="text" id="nom" placeholder="Entrez votre nom">
                </div>

                <div class="form-group">
                    <label>Sexe</label>
                    <select id="sexe">
                        <option value="femme">Femme</option>
                        <option value="homme">Homme</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>√Çge (ann√©es)</label>
                    <input type="number" id="age" placeholder="25" min="10" max="100">
                </div>

                <div class="form-group">
                    <label>Taille (cm)</label>
                    <input type="number" id="taille" placeholder="170" min="100" max="250">
                </div>

                <div class="form-group">
                    <label>Poids actuel (kg)</label>
                    <input type="number" id="poids" placeholder="70" step="0.1" min="30" max="300">
                </div>

                <div class="form-group">
                    <label>Poids objectif (kg)</label>
                    <input type="number" id="objectif" placeholder="65" step="0.1" min="30" max="300">
                </div>

                <div class="form-group">
                    <label>Niveau d'activit√©</label>
                    <select id="activite">
                        <option value="1.2">S√©dentaire (peu ou pas d'exercice)</option>
                        <option value="1.375">L√©g√®rement actif (exercice 1-3 jours/semaine)</option>
                        <option value="1.55">Mod√©r√©ment actif (exercice 3-5 jours/semaine)</option>
                        <option value="1.725">Tr√®s actif (exercice 6-7 jours/semaine)</option>
                        <option value="1.9">Extr√™mement actif (exercice intense quotidien)</option>
                    </select>
                </div>

                <button class="btn" onclick="calculerProfil()">Calculer mon programme</button>

                <div id="resultatProfil" class="result-box">
                    <h3>Votre bilan personnalis√©</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="value" id="imcValue">-</div>
                            <div class="label">IMC</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="poidsIdealValue">-</div>
                            <div class="label">Poids id√©al (kg)</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="aPerdrValue">-</div>
                            <div class="label">√Ä perdre (kg)</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="caloriesValue">-</div>
                            <div class="label">Calories/jour</div>
                        </div>
                    </div>
                    <div id="imcCategorie" style="margin-top: 15px; font-size: 1.1em;"></div>
                    <div id="dureeProgramme" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- Onglet Suivi -->
            <div id="suivi" class="tab-content">
                <h2>Suivez votre progression</h2>
                
                <div class="weight-entry">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Date</label>
                        <input type="date" id="datePesee">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Poids (kg)</label>
                        <input type="number" id="poidsPesee" step="0.1" placeholder="70.5">
                    </div>
                    <button class="btn" onclick="ajouterPesee()" style="margin-top: 0;">Ajouter</button>
                </div>

                <div id="progressionActuelle"></div>

                <canvas id="graphiquePoids" width="400" height="200"></canvas>

                <div class="weight-history">
                    <h3 style="margin-bottom: 15px;">Historique des pes√©es</h3>
                    <div id="listePesees"></div>
                </div>
            </div>

            <!-- Onglet Calculateur de Calories -->
            <div id="calculateur" class="tab-content">
                <h2>Calculateur de Calories</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 10px;">
                        üî¢ Calculez automatiquement les calories de vos aliments
                    </p>
                    <p style="text-align: center; color: #555; font-size: 0.95em;">
                        Tapez le nom d'un aliment, entrez la quantit√© en grammes, et obtenez instantan√©ment les informations nutritionnelles !
                    </p>
                </div>

                <!-- Recherche et ajout d'aliment -->
                <div style="background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üîç Rechercher un aliment</h3>
                    
                    <div class="form-group">
                        <label>Nom de l'aliment</label>
                        <input type="text" id="searchAliment" placeholder="Ex: poulet, pomme, riz..." oninput="rechercherAliment()">
                        <div id="suggestionsAliments" style="background: white; border: 1px solid #e0e0e0; border-radius: 5px; margin-top: 5px; max-height: 200px; overflow-y: auto; display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label>Quantit√© (grammes)</label>
                        <input type="number" id="quantiteAliment" placeholder="100" min="1" step="1">
                    </div>

                    <button class="btn" onclick="ajouterAlimentCalcul()">‚ûï Ajouter √† mon repas</button>
                </div>

                <!-- R√©sum√© du repas actuel -->
                <div id="repasActuel" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">üçΩÔ∏è Votre repas actuel</h3>
                    
                    <div id="listeAlimentsRepas" style="margin-bottom: 15px;"></div>

                    <div class="stats" style="margin-top: 15px;">
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalCalories">0</div>
                            <div class="label">Calories totales (kcal)</div>
                        </div>
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalProteines">0</div>
                            <div class="label">Prot√©ines (g)</div>
                        </div>
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalGlucides">0</div>
                            <div class="label">Glucides (g)</div>
                        </div>
                        <div class="stat-card" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="value" id="totalLipides">0</div>
                            <div class="label">Lipides (g)</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn" onclick="sauvegarderRepas()" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">üíæ Sauvegarder ce repas</button>
                        <button class="btn" onclick="reinitialiserRepas()" style="flex: 1; background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);">üóëÔ∏è Vider</button>
                    </div>
                </div>

                <!-- Historique des repas sauvegard√©s -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìÖ Historique de mes repas</h3>
                    
                    <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                        <p style="color: #333; font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">
                            Calories du jour : <span id="caloriesJour">0</span> kcal
                        </p>
                        <p id="objectifCaloriesMsg" style="color: #666; font-size: 0.9em; display: none;">
                            Objectif : <span id="objectifCaloriesValue">0</span> kcal
                        </p>
                        <div class="progress-bar" id="progressCaloriesJour" style="margin-top: 10px; display: none;">
                            <div class="progress-fill" id="progressCaloriesFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="historiqueRepas"></div>
                </div>
            </div>

            <!-- Onglet Frigo & Recettes -->
            <div id="frigo" class="tab-content">
                <h2>üç≥ Mon Frigo Intelligent & G√©n√©rateur de Recettes</h2>
                
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <h3 style="font-size: 1.5em; margin-bottom: 10px;">üî• Fonctionnalit√© R√©volutionnaire !</h3>
                    <p style="font-size: 1.1em; opacity: 0.95;">Scannez les produits de votre frigo et obtenez des recettes personnalis√©es avec calcul automatique des calories !</p>
                </div>

                <!-- Section Scanner Frigo -->
                <div style="background: white; border: 3px solid #ff6b6b; border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                    <h3 style="color: #ff6b6b; margin-bottom: 15px;">üì∑ Scanner les produits de mon frigo</h3>
                    <p style="color: #666; margin-bottom: 20px;">Scannez ou saisissez les codes-barres des produits que vous avez chez vous</p>

                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <input type="text" id="codebarreFrigo" placeholder="Code-barres (13 chiffres)" style="flex: 1; min-width: 200px;" maxlength="13">
                        <button class="btn" onclick="ajouterProduitFrigo()" style="width: auto; margin: 0; padding: 12px 25px;">
                            ‚ûï Ajouter au frigo
                        </button>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404; font-size: 0.9em; margin: 0; line-height: 1.6;">
                            ‚ö†Ô∏è <strong>Note :</strong> Sur mobile, le scanner cam√©ra peut ne pas fonctionner sur tous les navigateurs. <strong>La saisie manuelle est plus fiable !</strong> Si la cam√©ra ne s'ouvre pas, autorisez l'acc√®s dans les param√®tres.
                        </p>
                    </div>

                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn" id="startScanFrigoBtn" onclick="demarrerScannerFrigo()" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);">
                            üì∑ Scanner avec la cam√©ra
                        </button>
                        <button class="btn" id="stopScanFrigoBtn" onclick="arreterScannerFrigo()" style="display: none; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                            ‚èπÔ∏è Arr√™ter le scanner
                        </button>
                    </div>

                    <div id="erreurCameraFrigo" style="display: none; background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #c62828; margin-bottom: 10px;">üö´ Acc√®s cam√©ra impossible</h4>
                        <p style="color: #c62828; margin-bottom: 15px; line-height: 1.6;">
                            Le navigateur n'a pas pu acc√©der √† la cam√©ra. Voici comment r√©soudre :
                        </p>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h5 style="color: #667eea; margin-bottom: 10px;">üì± Sur Chrome/Firefox Mobile :</h5>
                            <ol style="line-height: 1.8; margin-left: 20px; color: #555; font-size: 0.95em;">
                                <li>Cliquez sur le <strong>üîí cadenas</strong> ou <strong>‚ìò</strong> dans la barre d'adresse</li>
                                <li>Trouvez <strong>"Cam√©ra"</strong> ou <strong>"Appareil photo"</strong></li>
                                <li>S√©lectionnez <strong>"Autoriser"</strong></li>
                                <li><strong>Rechargez la page</strong> (F5) et r√©essayez</li>
                            </ol>
                        </div>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                            <p style="color: #1565c0; font-weight: bold; margin-bottom: 8px;">üí° Solution alternative (recommand√©e) :</p>
                            <p style="color: #1565c0; margin: 0; line-height: 1.6;">
                                Utilisez la <strong>saisie manuelle</strong> du code-barres ci-dessus ‚¨ÜÔ∏è<br>
                                C'est rapide, fiable et fonctionne √† 100% sur mobile !
                            </p>
                        </div>
                    </div>

                    <div id="scannerFrigoContainer" style="max-width: 640px; margin: 20px auto; position: relative; background: #000; border-radius: 10px; overflow: hidden; display: none;">
                        <div id="interactiveFrigo"></div>
                    </div>

                    <div id="loadingFrigo" style="display: none; text-align: center; padding: 30px;">
                        <div style="font-size: 2.5em; animation: spin 1s linear infinite;">‚åõ</div>
                        <p style="color: #ff6b6b; font-size: 1.1em; margin-top: 10px;">Recherche du produit...</p>
                    </div>
                </div>

                <!-- Mon Frigo Virtuel -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin: 0;">üßä Mon Frigo Virtuel (<span id="compteurFrigo">0</span> produits)</h3>
                        <button class="btn" onclick="viderFrigo()" style="width: auto; margin: 0; padding: 10px 20px; background: linear-gradient(135deg, #ff4757 0%, #e84118 100%);">
                            üóëÔ∏è Vider le frigo
                        </button>
                    </div>
                    
                    <div id="listeProduitsFrigo"></div>
                </div>

                <!-- G√©n√©rateur de Recettes -->
                <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                    <h3 style="color: #ff6b6b; margin-bottom: 15px;">‚ú® G√©n√©rateur Magique de Recettes</h3>
                    <p style="color: #555; margin-bottom: 20px; font-size: 1.05em;">
                        Notre IA va analyser les produits de votre frigo et cr√©er des recettes personnalis√©es avec le calcul exact des calories !
                    </p>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <select id="typeRecette" style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #ff6b6b; border-radius: 8px; font-size: 16px;">
                            <option value="">Type de recette (tous)</option>
                            <option value="petit-dejeuner">üåÖ Petit-d√©jeuner</option>
                            <option value="dejeuner">‚òÄÔ∏è D√©jeuner</option>
                            <option value="diner">üåô D√Æner</option>
                            <option value="collation">üçé Collation</option>
                            <option value="dessert">üç∞ Dessert</option>
                        </select>

                        <select id="difficulteRecette" style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #ff6b6b; border-radius: 8px; font-size: 16px;">
                            <option value="">Difficult√© (toutes)</option>
                            <option value="facile">üòä Facile (< 20 min)</option>
                            <option value="moyen">üë®‚Äçüç≥ Moyen (20-40 min)</option>
                            <option value="difficile">‚≠ê Difficile (> 40 min)</option>
                        </select>
                    </div>

                    <button class="btn" onclick="genererRecettes()" style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); font-size: 1.1em;">
                        üé≤ G√©n√©rer des recettes magiques !
                    </button>
                </div>

                <!-- Recettes G√©n√©r√©es -->
                <div id="recettesGenerees" style="display: none;"></div>

                <!-- Historique des Recettes Utilis√©es -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìö Mes recettes favorites</h3>
                    <div id="recettesFavorites"></div>
                </div>
            </div>

            <!-- Onglet Ma Base Perso -->
            <div id="baseperso" class="tab-content">
                <h2>Ma Base de Donn√©es Personnelle</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 10px;">
                        üìù Cr√©ez votre propre base de produits avec codes-barres
                    </p>
                    <p style="text-align: center; color: #555; font-size: 0.95em;">
                        Ajoutez des produits qui ne sont pas dans OpenFoodFacts et retrouvez-les instantan√©ment lors du scan !
                    </p>
                </div>

                <!-- Formulaire d'ajout de produit personnalis√© -->
                <div style="background: white; border: 3px solid #667eea; border-radius: 10px; padding: 25px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">‚ûï Ajouter un nouveau produit</h3>
                    
                    <div class="form-group">
                        <label>üì∑ Photo du produit</label>
                        <input type="file" id="photoProduitPerso" accept="image/*" capture="environment" style="padding: 10px;">
                        <div id="previewPhotoPerso" style="margin-top: 10px; display: none;">
                            <img id="imgPreviewPerso" src="" style="max-width: 200px; border-radius: 8px; border: 2px solid #e0e0e0;">
                            <button onclick="retirerPhotoPerso()" style="display: block; margin-top: 8px; padding: 5px 10px; background: #ff4757; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Retirer la photo</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üì¶ Nom du produit *</label>
                        <input type="text" id="nomProduitPerso" placeholder="Ex: Mon yaourt maison, Pizza du restaurant..." required>
                    </div>

                    <div class="form-group">
                        <label>üè∑Ô∏è Marque (optionnel)</label>
                        <input type="text" id="marqueProduitPerso" placeholder="Ex: Marque maison">
                    </div>

                    <div class="form-group">
                        <label>üìä Code-barres (13 chiffres) *</label>
                        <input type="text" id="codebarreProduitPerso" placeholder="3017620422003" maxlength="13" pattern="[0-9]{13}">
                        <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            üí° Si le produit n'a pas de code-barres, vous pouvez en g√©n√©rer un fictif (ex: 9999999999901)
                        </p>
                    </div>

                    <div class="form-group">
                        <label>‚öñÔ∏è Quantit√© (optionnel)</label>
                        <input type="text" id="quantiteProduitPerso" placeholder="Ex: 500g, 1L">
                    </div>

                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìä Valeurs nutritionnelles pour 100g *</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üî• Calories (kcal)</label>
                                <input type="number" id="caloriesProduitPerso" placeholder="250" min="0" step="1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üí™ Prot√©ines (g)</label>
                                <input type="number" id="proteinesProduitPerso" placeholder="10" min="0" step="0.1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üçû Glucides (g)</label>
                                <input type="number" id="glucidesProduitPerso" placeholder="30" min="0" step="0.1" required>
                            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label>üßà Lipides (g)</label>
                                <input type="number" id="lipidesProduitPerso" placeholder="5" min="0" step="0.1" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìù Notes (optionnel)</label>
                        <textarea id="notesProduitPerso" placeholder="Ex: Recette maison, achet√© au march√©..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; min-height: 80px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"></textarea>
                    </div>

                    <button class="btn" onclick="ajouterProduitPerso()">üíæ Enregistrer ce produit</button>
                </div>

                <!-- Liste des produits personnalis√©s -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìö Mes produits personnalis√©s (<span id="compteurProduitsPerso">0</span>)</h3>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <p style="color: #856404; font-size: 0.95em; margin: 0;">
                            üí° <strong>Astuce :</strong> Quand vous scannerez un code-barres, l'application cherchera d'abord dans votre base personnelle avant d'interroger OpenFoodFacts !
                        </p>
                    </div>

                    <div id="listeProduitsPerso"></div>
                </div>
            </div>

            <!-- Onglet Scanner -->
            <div id="scanner" class="tab-content">
                <h2>Scanner un produit alimentaire</h2>
                
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="text-align: center; color: #333; font-size: 1.1em; margin-bottom: 15px;">
                        üì± Trouvez les informations nutritionnelles de vos produits
                    </p>
                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <p style="color: #1565c0; font-weight: bold; margin-bottom: 10px;">üí° Deux m√©thodes disponibles :</p>
                        <ul style="color: #555; font-size: 0.9em; line-height: 1.8; margin-left: 20px;">
                            <li><strong>Saisie manuelle</strong> - Rapide et fiable ‚úÖ</li>
                            <li><strong>Scanner cam√©ra</strong> - Scannez directement le code-barres</li>
                        </ul>
                    </div>
                </div>

                <!-- M√©thode 1: Saisie manuelle -->
                <div style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); border-radius: 10px; border: 3px solid #667eea;">
                    <h3 style="margin-bottom: 15px; color: #667eea; text-align: center;">‚å®Ô∏è M√©thode 1 : Saisie manuelle</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 0.95em;">
                        ‚ú® <strong>Recommand√©e</strong> - Plus rapide et fiable !
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="manualBarcode" placeholder="Saisissez les 13 chiffres du code-barres" style="flex: 1; padding: 15px; border: 3px solid #667eea; border-radius: 12px; font-size: 18px; min-width: 250px; font-weight: 500;">
                        <button class="btn" onclick="rechercherCodeBarre()" style="width: auto; margin: 0; padding: 15px 35px; font-size: 18px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">üîç Rechercher</button>
                    </div>
                    <p style="margin-top: 12px; color: #666; font-size: 0.9em; text-align: center;">
                        üí° Le code-barres se trouve au dos du produit (13 chiffres)<br>
                        Exemple : 3017620422003
                    </p>
                </div>

                <!-- M√©thode 2: Scanner cam√©ra -->
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #fff9e6 0%, #ffe6f0 100%); border-radius: 10px; border: 2px solid #ffc107;">
                    <h3 style="margin-bottom: 15px; color: #f57c00; text-align: center;">üì∑ M√©thode 2 : Scanner avec la cam√©ra</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 15px; font-size: 0.9em;">
                        Scannez directement le code-barres du produit
                    </p>

                    <div style="text-align: center; margin-bottom: 15px;">
                        <button class="btn" id="startScanBtn" onclick="demarrerScanner()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                            üì∑ Activer le scanner
                        </button>
                        <button class="btn" id="stopScanBtn" onclick="arreterScanner()" style="display: none; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                            ‚èπÔ∏è Arr√™ter le scanner
                        </button>
                    </div>

                    <div id="scannerContainer" style="max-width: 640px; margin: 0 auto; position: relative; background: #000; border-radius: 10px; overflow: hidden;">
                        <div id="scanPlaceholder" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 60px 20px; text-align: center;">
                            <div style="font-size: 4em; margin-bottom: 15px;">üì∑</div>
                            <p style="color: white; font-size: 1.1em; line-height: 1.6;">
                                Cliquez sur "Activer le scanner" pour utiliser votre cam√©ra<br>
                                <span style="font-size: 0.9em; opacity: 0.9;">Assurez-vous d'autoriser l'acc√®s √† la cam√©ra</span>
                            </p>
                        </div>
                        <div id="interactive" style="display: none; position: relative;">
                            <div class="scan-guide"></div>
                        </div>
                    </div>

                    <!-- Informations de d√©bogage (masqu√©es par d√©faut) -->
                    <div id="debugInfo" class="debug-info"></div>
                    <button onclick="toggleDebug()" style="margin-top: 10px; padding: 8px 15px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        üîß Afficher/Masquer infos de d√©bogage
                    </button>
                </div>

                <!-- Loading -->
                <div id="loadingScanner" style="display: none; text-align: center; padding: 40px;">
                    <div style="font-size: 3em; animation: spin 1s linear infinite;">‚åõ</div>
                    <p style="color: #667eea; font-size: 1.2em; margin-top: 10px;">Recherche en cours...</p>
                </div>

                <!-- R√©sultat du scan -->
                <div id="resultatScanner" style="display: none;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üì¶ Informations du produit</h3>
                    
                    <div style="background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 20px; align-items: start; flex-wrap: wrap;">
                            <img id="productImage" src="" alt="Produit" style="width: 150px; height: 150px; object-fit: contain; border-radius: 8px; background: #f8f9fa;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4 id="productName" style="color: #333; margin-bottom: 10px; font-size: 1.3em;"></h4>
                                <p id="productBrand" style="color: #667eea; font-weight: 600; margin-bottom: 5px;"></p>
                                <p id="productQuantity" style="color: #666; margin-bottom: 10px;"></p>
                                <p id="productBarcode" style="color: #999; font-size: 0.9em;"></p>
                            </div>
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="value" id="productCalories">-</div>
                            <div class="label">Calories (kcal/100g)</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="value" id="productProteines">-</div>
                            <div class="label">Prot√©ines (g/100g)</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="value" id="productGlucides">-</div>
                            <div class="label">Glucides (g/100g)</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="value" id="productLipides">-</div>
                            <div class="label">Lipides (g/100g)</div>
                        </div>
                    </div>

                    <div id="nutriscoreContainer" style="margin-top: 20px; text-align: center; display: none;">
                        <h4 style="margin-bottom: 10px;">Score nutritionnel</h4>
                        <img id="nutriscoreImage" src="" alt="Nutri-Score" style="max-width: 200px;">
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                        <button class="btn" onclick="ajouterProduitScanneAuCalculateur()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                            üßÆ Ajouter au Calculateur
                        </button>
                        <button class="btn" onclick="sauvegarderProduit()" style="flex: 1; min-width: 200px;">
                            üíæ Sauvegarder ce produit
                        </button>
                    </div>
                </div>

                <!-- Erreurs -->
                <div id="erreurScanner" style="display: none; background: #ffebee; color: #c62828; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">‚ùå Produit non trouv√©</h4>
                    <p>Ce code-barres n'a pas √©t√© trouv√© dans notre base de donn√©es. Essayez avec un autre produit ou v√©rifiez le code saisi.</p>
                </div>

                <div id="erreurPermission" style="display: none; background: #fff3cd; border: 2px solid #ffc107; color: #856404; padding: 25px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="margin-bottom: 15px; font-size: 1.2em;">üö´ Acc√®s cam√©ra refus√©</h4>
                    <p style="margin-bottom: 15px; line-height: 1.6;">Le navigateur a bloqu√© l'acc√®s √† la cam√©ra. Voici comment le r√©soudre :</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="color: #667eea; margin-bottom: 10px;">üì± Sur mobile :</h5>
                        <ol style="line-height: 2; margin-left: 20px;">
                            <li>Allez dans les <strong>param√®tres</strong> de votre navigateur</li>
                            <li>Cherchez <strong>Autorisations</strong> ou <strong>Permissions</strong></li>
                            <li>Trouvez <strong>Appareil photo / Cam√©ra</strong></li>
                            <li>Activez l'autorisation pour ce site</li>
                            <li>Rechargez la page et r√©essayez</li>
                        </ol>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <p style="color: #1565c0; font-weight: bold; margin-bottom: 10px;">üí° Solution alternative :</p>
                        <p>Utilisez la saisie manuelle du code-barres ci-dessus - c'est tout aussi efficace !</p>
                    </div>
                </div>

                <!-- Historique des produits -->
                <div id="historiqueProduits" style="margin-top: 40px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìö Mes produits scann√©s</h3>
                    <div id="listeProduits"></div>
                </div>
            </div>

            <!-- Onglet Coach IA -->
            <div id="coachai" class="tab-content">
                <h2>ü§ñ Votre Coach Personnel Intelligent</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <h3 style="font-size: 1.5em; margin-bottom: 10px;">üëã Bonjour <span id="nomCoachIA">Champion</span> !</h3>
                    <p style="font-size: 1.1em; opacity: 0.95;">Votre coach personnel analyse vos donn√©es pour vous accompagner vers votre objectif</p>
                </div>

                <!-- Tableau de bord personnalis√© -->
                <div id="tableauBordIA" style="margin-bottom: 25px;"></div>

                <!-- Suggestions de collations intelligentes -->
                <div id="suggestionsCollations" style="margin-bottom: 25px;"></div>

                <!-- Conseils personnalis√©s du jour -->
                <div id="conseilsPersonnalises" style="margin-bottom: 25px;"></div>

                <!-- Motivation adapt√©e -->
                <div id="motivationAdaptee" style="margin-bottom: 25px;"></div>

                <!-- Analyse de la semaine -->
                <div id="analyseSemaine" style="margin-bottom: 25px;"></div>

                <!-- Actions recommand√©es -->
                <div id="actionsRecommandees" style="margin-bottom: 25px;"></div>

                <button class="btn" onclick="actualiserCoachIA()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                    üîÑ Actualiser mes recommandations
                </button>
            </div>

            <!-- Onglet Calendrier Saisonnier -->
            <div id="calendrier" class="tab-content">
                <h2>üìÖ Calendrier des Fruits & L√©gumes de Saison</h2>
                
                <div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <h3 style="font-size: 1.5em; margin-bottom: 10px;">üå± Mangez de Saison !</h3>
                    <p style="font-size: 1.1em; opacity: 0.95; line-height: 1.6;">
                        Les fruits et l√©gumes de saison sont plus savoureux, moins chers et meilleurs pour l'environnement !<br>
                        D√©couvrez ce que la nature vous offre chaque mois.
                    </p>
                </div>

                <!-- S√©lection Mois/Saison -->
                <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #56ab2f; margin-bottom: 20px;">üìÜ Choisissez une p√©riode</h3>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="afficherMoisActuel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); flex: 1; min-width: 150px;">
                            üóìÔ∏è Mois Actuel
                        </button>
                        <button class="btn" onclick="afficherSaisonActuelle()" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); flex: 1; min-width: 150px;">
                            üçÇ Saison Actuelle
                        </button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Ou s√©lectionnez un mois :</label>
                        <select id="selectMois" onchange="afficherMois(this.value)" style="width: 100%; padding: 12px; border: 2px solid #56ab2f; border-radius: 8px; font-size: 16px;">
                            <option value="1">Janvier ‚ùÑÔ∏è</option>
                            <option value="2">F√©vrier ‚ùÑÔ∏è</option>
                            <option value="3">Mars üå∏</option>
                            <option value="4">Avril üå∏</option>
                            <option value="5">Mai üå∏</option>
                            <option value="6">Juin ‚òÄÔ∏è</option>
                            <option value="7">Juillet ‚òÄÔ∏è</option>
                            <option value="8">Ao√ªt ‚òÄÔ∏è</option>
                            <option value="9">Septembre üçÇ</option>
                            <option value="10">Octobre üçÇ</option>
                            <option value="11">Novembre üçÇ</option>
                            <option value="12">D√©cembre ‚ùÑÔ∏è</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Ou choisissez une saison :</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                            <button onclick="afficherSaison('printemps')" style="padding: 15px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: #333; transition: transform 0.2s;">
                                üå∏ Printemps
                            </button>
                            <button onclick="afficherSaison('ete')" style="padding: 15px; background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: #333; transition: transform 0.2s;">
                                ‚òÄÔ∏è √ât√©
                            </button>
                            <button onclick="afficherSaison('automne')" style="padding: 15px; background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%); border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: white; transition: transform 0.2s;">
                                üçÇ Automne
                            </button>
                            <button onclick="afficherSaison('hiver')" style="padding: 15px; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); border: none; border-radius: 10px; cursor: pointer; font-weight: 600; color: white; transition: transform 0.2s;">
                                ‚ùÑÔ∏è Hiver
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Affichage des r√©sultats -->
                <div id="resultatCalendrier"></div>

                <!-- Conseils saisonniers -->
                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); border-radius: 15px; padding: 25px; margin-top: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üí° Pourquoi manger de saison ?</h3>
                    <div style="display: grid; gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #4caf50;">
                            <div style="font-weight: bold; color: #4caf50; margin-bottom: 5px;">üåø Plus de nutriments</div>
                            <div style="color: #666; font-size: 0.95em;">Les fruits et l√©gumes cueillis √† maturit√© contiennent plus de vitamines et min√©raux</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #2196f3;">
                            <div style="font-weight: bold; color: #2196f3; margin-bottom: 5px;">üí∞ Moins cher</div>
                            <div style="color: #666; font-size: 0.95em;">En saison, les produits sont abondants donc moins chers au march√©</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800;">
                            <div style="font-weight: bold; color: #ff9800; margin-bottom: 5px;">üòã Meilleur go√ªt</div>
                            <div style="color: #666; font-size: 0.95em;">Les produits de saison m√ªrissent naturellement et ont plus de saveur</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #8bc34a;">
                            <div style="font-weight: bold; color: #8bc34a; margin-bottom: 5px;">üåç √âcologique</div>
                            <div style="color: #666; font-size: 0.95em;">Moins de transport, moins de serres chauff√©es = moins d'√©missions de CO2</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Conseils -->
            <div id="conseils" class="tab-content">
                <h2>Conseils Nutrition & Bien-√™tre</h2>
                
                <div class="conseil-card">
                    <h4>ü•ó R√®gle n¬∞1 : L'√©quilibre alimentaire</h4>
                    <p>Privil√©giez une alimentation vari√©e et √©quilibr√©e. Chaque repas devrait contenir des prot√©ines, des glucides complexes, des l√©gumes et de bonnes graisses. Ne sautez jamais de repas !</p>
                </div>

                <div class="conseil-card">
                    <h4>üíß R√®gle n¬∞2 : L'hydratation</h4>
                    <p>Buvez au moins 1,5 √† 2 litres d'eau par jour. L'eau aide √† √©liminer les toxines, favorise la digestion et peut r√©duire la sensation de faim. Commencez votre journ√©e avec un grand verre d'eau.</p>
                </div>

                <div class="conseil-card">
                    <h4>‚è∞ R√®gle n¬∞3 : Les horaires r√©guliers</h4>
                    <p>Mangez √† heures fixes pour r√©guler votre m√©tabolisme. Id√©alement : petit-d√©jeuner avant 9h, d√©jeuner entre 12h et 13h, d√Æner avant 20h. √âvitez de grignoter entre les repas.</p>
                </div>

                <div class="conseil-card">
                    <h4>ü•¶ R√®gle n¬∞4 : L√©gumes √† volont√©</h4>
                    <p>Les l√©gumes sont vos meilleurs alli√©s ! Riches en fibres, vitamines et min√©raux, ils vous rassasient sans apporter beaucoup de calories. Visez 5 portions de fruits et l√©gumes par jour.</p>
                </div>

                <div class="conseil-card">
                    <h4>üèÉ‚Äç‚ôÄÔ∏è R√®gle n¬∞5 : L'activit√© physique</h4>
                    <p>Bougez au moins 30 minutes par jour ! Marche, v√©lo, natation, danse... Choisissez une activit√© qui vous pla√Æt. L'exercice booste votre m√©tabolisme et am√©liore votre bien-√™tre.</p>
                </div>

                <div class="conseil-card">
                    <h4>üò¥ R√®gle n¬∞6 : Le sommeil</h4>
                    <p>Dormez 7 √† 8 heures par nuit. Le manque de sommeil perturbe les hormones de la faim et augmente les envies de sucre. Un bon sommeil est essentiel pour perdre du poids durablement.</p>
                </div>

                <div class="conseil-card">
                    <h4>üç´ R√®gle n¬∞7 : Les plaisirs autoris√©s</h4>
                    <p>Autorisez-vous un petit plaisir de temps en temps pour √©viter les frustrations. L'important est la r√©gularit√©, pas la perfection. Un carr√© de chocolat noir 70% peut √™tre votre alli√© !</p>
                </div>

                <div class="conseil-card">
                    <h4>üì± R√®gle n¬∞8 : La pleine conscience</h4>
                    <p>Mangez lentement, en pleine conscience, sans √©cran. Prenez le temps de savourer chaque bouch√©e. Cela favorise la sati√©t√© et am√©liore votre rapport √† la nourriture.</p>
                </div>
            </div>

            <!-- Onglet Motivation -->
            <div id="motivation" class="tab-content">
                <h2>Votre dose de motivation quotidienne</h2>
                
                <div class="motivation-box">
                    <div class="quote" id="citationJour"></div>
                    <div class="author" id="auteurCitation"></div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Vos objectifs de la semaine</h3>
                    
                    <div class="conseil-card">
                        <h4>Lundi : D√©marrage en douceur</h4>
                        <p>Commencez la semaine du bon pied ! Buvez un grand verre d'eau au r√©veil et prenez un petit-d√©jeuner complet. Fixez-vous 3 objectifs pour la semaine.</p>
                    </div>

                    <div class="conseil-card">
                        <h4>Mardi : Jour des prot√©ines</h4>
                        <p>Assurez-vous d'avoir des prot√©ines √† chaque repas aujourd'hui. Elles vous aideront √† vous sentir rassasi√© plus longtemps et √† maintenir votre masse musculaire.</p>
                    </div>

                    <div class="conseil-card">
                        <h4>Mercredi : Challenge activit√©</h4>
                        <p>Aujourd'hui, faites 10 000 pas ! Prenez les escaliers, descendez un arr√™t avant en transport, faites une promenade apr√®s le d√©jeuner. Bougez !</p>
                    </div>

                    <div class="conseil-card">
                        <h4>Jeudi : Jour v√©g√©tarien</h4>
                        <p>Testez un repas 100% v√©g√©tarien aujourd'hui. D√©couvrez de nouvelles recettes √† base de l√©gumineuses, tofu ou l√©gumes. Votre corps et la plan√®te vous remercieront !</p>
                    </div>

                    <div class="conseil-card">
                        <h4>Vendredi : Pr√©paration weekend</h4>
                        <p>Pr√©parez vos repas du weekend pour √©viter les tentations. Faites vos courses avec une liste et ne partez jamais le ventre vide au supermarch√©.</p>
                    </div>

                    <div class="conseil-card">
                        <h4>Weekend : √âquilibre et plaisir</h4>
                        <p>Le weekend, c'est le moment de vous faire plaisir intelligemment. Sortez, bougez, profitez mais gardez vos bonnes habitudes. L'√©quilibre est la cl√© !</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Base Calories -->
            <div id="calories" class="tab-content">
                <h2>Base de donn√©es nutritionnelle compl√®te</h2>
                
                <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 15px; margin: 20px 0;">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 1.8em;">üçé D√©couvrez les calories de tous les aliments</h3>
                    <p style="color: #555; font-size: 1.1em; margin-bottom: 25px; line-height: 1.6;">
                        Acc√©dez √† une base de donn√©es compl√®te de plus de 150 aliments avec leurs informations nutritionnelles d√©taill√©es : calories, prot√©ines, glucides et lipides pour 100g.
                    </p>
                    <a href="https://base-calorie.vercel.app/" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border-radius: 30px; text-decoration: none; font-size: 1.2em; font-weight: bold; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;">
                        üîç Ouvrir la base de donn√©es
                    </a>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">‚ú® Fonctionnalit√©s de la base de donn√©es</h3>
                    
                    <div class="menu-grid">
                        <div class="menu-card">
                            <h4>üîé Recherche rapide</h4>
                            <ul>
                                <li>Trouvez n'importe quel aliment instantan√©ment</li>
                                <li>R√©sultats en temps r√©el</li>
                            </ul>
                        </div>

                        <div class="menu-card">
                            <h4>üè∑Ô∏è Filtres par cat√©gorie</h4>
                            <ul>
                                <li>Fruits, l√©gumes, viandes, poissons</li>
                                <li>C√©r√©ales, produits laitiers, noix</li>
                                <li>Plus de 12 cat√©gories disponibles</li>
                            </ul>
                        </div>

                        <div class="menu-card">
                            <h4>üìä Informations compl√®tes</h4>
                            <ul>
                                <li>Calories par 100g</li>
                                <li>Prot√©ines, glucides, lipides</li>
                                <li>Indicateurs visuels clairs</li>
                            </ul>
                        </div>

                        <div class="menu-card">
                            <h4>üìà Tri intelligent</h4>
                            <ul>
                                <li>Triez par calories</li>
                                <li>Triez par prot√©ines</li>
                                <li>Comparez facilement les aliments</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üí° Astuce nutrition</h4>
                    <p style="color: #856404; line-height: 1.6;">
                        Utilisez la base de donn√©es pour composer vos repas √©quilibr√©s. Un repas id√©al contient environ 500-600 calories avec un bon √©quilibre entre prot√©ines (30%), glucides (40%) et lipides (30%). Les aliments √† moins de 100 calories pour 100g sont parfaits pour les grosses portions !
                    </p>
                </div>

                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 10px;">
                    <h4 style="color: #333; margin-bottom: 10px;">üéØ Exemples de portions</h4>
                    <ul style="color: #555; line-height: 1.8;">
                        <li><strong>100g de poulet</strong> = environ la taille de la paume de votre main</li>
                        <li><strong>100g de p√¢tes cuites</strong> = environ 1 tasse</li>
                        <li><strong>100g de l√©gumes</strong> = environ 1 grosse poign√©e</li>
                        <li><strong>30g de fromage</strong> = environ la taille de 2 dominos</li>
                        <li><strong>Une portion de fruit</strong> = 1 fruit moyen (150-200g)</li>
                    </ul>
                </div>
            </div>

            <!-- Onglet Menus -->
            <div id="menus" class="tab-content">
                <h2>Exemples de menus √©quilibr√©s</h2>
                
                <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h3 style="color: white; margin-bottom: 15px; font-size: 1.8em;">üìÖ Planificateur de Repas + Suivi Calories</h3>
                    <p style="color: white; font-size: 1.1em; margin-bottom: 25px; line-height: 1.6; opacity: 0.95;">
                        üî• Application compl√®te pour planifier vos repas de la semaine et suivre vos calories quotidiennes automatiquement ! Avec 20 recettes fran√ßaises et macros d√©taill√©es.
                    </p>
                    <a href="https://planificateur-de-repas-calories.vercel.app/" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px 40px; border-radius: 30px; text-decoration: none; font-size: 1.2em; font-weight: bold; box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4); transition: all 0.3s;">
                        üìä Planifier mes repas et calories
                    </a>
                </div>
                
                <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 1.8em;">üçΩÔ∏è D√©couvrez nos recettes compl√®tes</h3>
                    <p style="color: #555; font-size: 1.1em; margin-bottom: 25px; line-height: 1.6;">
                        Acc√©dez √† plus de 30 recettes √©quilibr√©es avec viandes, charcuteries et l√©gumes. Chaque recette contient les instructions d√©taill√©es, temps de pr√©paration et informations nutritionnelles.
                    </p>
                    <a href="https://recette-mon-cadeau.vercel.app/" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border-radius: 30px; text-decoration: none; font-size: 1.2em; font-weight: bold; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; margin-right: 15px;">
                        üë®‚Äçüç≥ Voir toutes les recettes
                    </a>
                </div>

                <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 1.8em;">üìñ Cr√©ez votre carnet personnel</h3>
                    <p style="color: #555; font-size: 1.1em; margin-bottom: 25px; line-height: 1.6;">
                        Cr√©ez et sauvegardez vos propres recettes avec photos, ingr√©dients, instructions et informations nutritionnelles. Exportez et partagez vos cr√©ations !
                    </p>
                    <a href="https://mon-carnet-recette.vercel.app/" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border-radius: 30px; text-decoration: none; font-size: 1.2em; font-weight: bold; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;">
                        üìù Mon carnet de recettes
                    </a>
                </div>

                <h3 style="color: #667eea; margin-bottom: 15px;">üìã Exemples de menus quotidiens</h3>
                
                <div class="menu-grid">
                    <div class="menu-card">
                        <h4>Petit-d√©jeuner 1</h4>
                        <ul>
                            <li>Porridge d'avoine au lait</li>
                            <li>Fruits rouges frais</li>
                            <li>1 cuill√®re de miel</li>
                            <li>Th√© vert ou caf√© sans sucre</li>
                        </ul>
                    </div>

                    <div class="menu-card">
                        <h4>Petit-d√©jeuner 2</h4>
                        <ul>
                            <li>2 tranches de pain complet</li>
                            <li>1 avocat √©cras√©</li>
                            <li>1 ≈ìuf poch√©</li>
                            <li>Jus d'orange frais</li>
                        </ul>
                    </div>

                    <div class="menu-card">
                        <h4>D√©jeuner 1</h4>
                        <ul>
                            <li>Salade verte mixte</li>
                            <li>Poulet grill√© (150g)</li>
                            <li>Quinoa aux l√©gumes</li>
                            <li>1 yaourt nature</li>
                        </ul>
                    </div>

                    <div class="menu-card">
                        <h4>D√©jeuner 2</h4>
                        <ul>
                            <li>Saumon au four (120g)</li>
                            <li>Brocolis vapeur</li>
                            <li>Riz basmati complet</li>
                            <li>Compote sans sucre ajout√©</li>
                        </ul>
                    </div>

                    <div class="menu-card">
                        <h4>D√Æner 1</h4>
                        <ul>
                            <li>Soupe de l√©gumes maison</li>
                            <li>Omelette aux champignons</li>
                            <li>Salade verte</li>
                            <li>Fruit de saison</li>
                        </ul>
                    </div>

                    <div class="menu-card">
                        <h4>D√Æner 2</h4>
                        <ul>
                            <li>Poisson blanc vapeur</li>
                            <li>Haricots verts</li>
                            <li>Patate douce r√¥tie</li>
                            <li>Fromage blanc 0%</li>
                        </ul>
                    </div>

                    <div class="menu-card">
                        <h4>Collation 1</h4>
                        <ul>
                            <li>1 pomme</li>
                            <li>Poign√©e d'amandes (15-20)</li>
                            <li>Th√© vert</li>
                        </ul>
                    </div>

                    <div class="menu-card">
                        <h4>Collation 2</h4>
                        <ul>
                            <li>Yaourt grec nature</li>
                            <li>Fruits rouges</li>
                            <li>1 cuill√®re de graines de chia</li>
                        </ul>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üí° Astuce du chef</h4>
                    <p style="color: #856404;">Pr√©parez vos repas √† l'avance le dimanche pour toute la semaine. Utilisez des contenants herm√©tiques et variez les menus pour ne pas vous lasser. La pr√©paration est la cl√© du succ√®s !</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de c√©l√©bration -->
    <div id="celebrationOverlay" class="celebration-overlay">
        <div class="celebration-modal">
            <div id="celebrationContent"></div>
        </div>
    </div>

    <!-- Modal de correction -->
    <div id="correctionModal" class="correction-modal">
        <div class="correction-content">
            <h2 style="color: #ff6b6b; margin-bottom: 20px;">üîß Signaler une erreur</h2>
            <p style="color: #666; margin-bottom: 20px;">Vous avez remarqu√© une erreur ? Aidez-nous √† l'am√©liorer !</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Type d'erreur</label>
                <select id="typeErreur" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                    <option value="">S√©lectionnez le type</option>
                    <option value="calcul">‚ùå Erreur de calcul (calories, macros)</option>
                    <option value="produit">üì¶ Informations produit incorrectes</option>
                    <option value="recette">üç≥ Erreur dans une recette</option>
                    <option value="scan">üì∑ Probl√®me de scan</option>
                    <option value="progression">üìà Erreur de progression</option>
                    <option value="autre">üí¨ Autre</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">O√π se trouve l'erreur ?</label>
                <input type="text" id="lieuErreur" placeholder="Ex: Onglet Calculateur, Recette Poulet..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Description de l'erreur</label>
                <textarea id="descriptionErreur" placeholder="D√©crivez l'erreur en d√©tail..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; min-height: 120px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Correction sugg√©r√©e (optionnel)</label>
                <textarea id="correctionSuggeree" placeholder="Comment devrait-ce √™tre corrig√© ?" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; min-height: 80px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="fermerModalCorrection()" style="flex: 1; padding: 12px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600;">
                    Annuler
                </button>
                <button onclick="envoyerCorrection()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600;">
                    ‚úÖ Envoyer
                </button>
            </div>

            <div id="historiqueCorrectionsSummary" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <h4 style="color: #667eea; margin-bottom: 10px;">üìã Mes signalements (<span id="compteurCorrections">0</span>)</h4>
                <p style="color: #999; font-size: 0.9em;">Vos signalements sont stock√©s localement</p>
            </div>
        </div>
    </div>

    <script>
        // Citations motivantes
        const citations = [
            { texte: "Le succ√®s, c'est la somme de petits efforts r√©p√©t√©s jour apr√®s jour.", auteur: "Robert Collier" },
            { texte: "Votre corps peut tout faire, c'est votre esprit qu'il faut convaincre.", auteur: "Anonyme" },
            { texte: "La motivation vous fait d√©marrer, l'habitude vous fait continuer.", auteur: "Jim Ryun" },
            { texte: "Prenez soin de votre corps, c'est le seul endroit o√π vous √™tes oblig√© de vivre.", auteur: "Jim Rohn" },
            { texte: "Le secret pour avancer est de commencer.", auteur: "Mark Twain" },
            { texte: "Ne vous comparez qu'√† la personne que vous √©tiez hier.", auteur: "Jordan Peterson" },
            { texte: "Vous n'avez pas √† √™tre extr√™me, juste constant.", auteur: "Anonyme" },
            { texte: "Chaque expert a √©t√© un jour un d√©butant.", auteur: "Robin Sharma" }
        ];

        // Donn√©es utilisateur
        let userData = JSON.parse(localStorage.getItem('userData')) || {};
        let pesees = JSON.parse(localStorage.getItem('pesees')) || [];
        let produitsSauvegardes = JSON.parse(localStorage.getItem('produits')) || [];
        let produitsPerso = JSON.parse(localStorage.getItem('produitsPerso')) || [];
        let produitsFrigo = JSON.parse(localStorage.getItem('produitsFrigo')) || [];
        let recettesFavorites = JSON.parse(localStorage.getItem('recettesFavorites')) || [];
        let corrections = JSON.parse(localStorage.getItem('corrections')) || [];
        let repasActuel = [];
        let repasSauvegardes = JSON.parse(localStorage.getItem('repas')) || [];
        let scannerActif = false;
        let scannerFrigoActif = false;
        let dernierProduit = null;
        let dernierCodeDetecte = null;
        let dernierCodeDetecteFrigo = null;
        let timeoutDetection = null;
        let timeoutDetectionFrigo = null;
        let photoPersoBase64 = null;
        let objectifAtteintAffiche = localStorage.getItem('objectifAtteintAffiche') === 'true';

        // Base de donn√©es d'aliments (calories pour 100g)
        const baseAliments = [
            // Viandes et poissons
            { nom: "Poulet", categorie: "Viande", calories: 165, proteines: 31, glucides: 0, lipides: 3.6 },
            { nom: "B≈ìuf", categorie: "Viande", calories: 250, proteines: 26, glucides: 0, lipides: 17 },
            { nom: "Porc", categorie: "Viande", calories: 242, proteines: 27, glucides: 0, lipides: 14 },
            { nom: "Dinde", categorie: "Viande", calories: 135, proteines: 29, glucides: 0, lipides: 1.5 },
            { nom: "Jambon blanc", categorie: "Charcuterie", calories: 145, proteines: 21, glucides: 1, lipides: 6 },
            { nom: "Saumon", categorie: "Poisson", calories: 208, proteines: 20, glucides: 0, lipides: 13 },
            { nom: "Thon", categorie: "Poisson", calories: 130, proteines: 29, glucides: 0, lipides: 1 },
            { nom: "Cabillaud", categorie: "Poisson", calories: 82, proteines: 18, glucides: 0, lipides: 0.7 },
            { nom: "Sardine", categorie: "Poisson", calories: 208, proteines: 25, glucides: 0, lipides: 11 },
            { nom: "Crevette", categorie: "Fruits de mer", calories: 99, proteines: 24, glucides: 0, lipides: 0.3 },
            
            // ≈íufs et produits laitiers
            { nom: "≈íuf", categorie: "≈íuf", calories: 155, proteines: 13, glucides: 1.1, lipides: 11 },
            { nom: "Lait entier", categorie: "Laitier", calories: 61, proteines: 3.2, glucides: 4.8, lipides: 3.3 },
            { nom: "Lait demi-√©cr√©m√©", categorie: "Laitier", calories: 46, proteines: 3.3, glucides: 4.8, lipides: 1.5 },
            { nom: "Yaourt nature", categorie: "Laitier", calories: 59, proteines: 3.5, glucides: 4, lipides: 3.3 },
            { nom: "Fromage blanc 0%", categorie: "Laitier", calories: 44, proteines: 7.5, glucides: 4, lipides: 0.2 },
            { nom: "Fromage blanc 20%", categorie: "Laitier", calories: 75, proteines: 7, glucides: 3, lipides: 3 },
            { nom: "Emmental", categorie: "Fromage", calories: 382, proteines: 28, glucides: 1.6, lipides: 29 },
            { nom: "Mozzarella", categorie: "Fromage", calories: 280, proteines: 28, glucides: 2.2, lipides: 17 },
            { nom: "Camembert", categorie: "Fromage", calories: 299, proteines: 20, glucides: 0.5, lipides: 24 },
            
            // F√©culents et c√©r√©ales
            { nom: "Riz blanc cuit", categorie: "F√©culent", calories: 130, proteines: 2.7, glucides: 28, lipides: 0.3 },
            { nom: "Riz complet cuit", categorie: "F√©culent", calories: 112, proteines: 2.6, glucides: 24, lipides: 0.9 },
            { nom: "P√¢tes cuites", categorie: "F√©culent", calories: 131, proteines: 5, glucides: 25, lipides: 1.1 },
            { nom: "P√¢tes compl√®tes cuites", categorie: "F√©culent", calories: 124, proteines: 5.3, glucides: 23.5, lipides: 1.4 },
            { nom: "Quinoa cuit", categorie: "F√©culent", calories: 120, proteines: 4.4, glucides: 21, lipides: 1.9 },
            { nom: "Pain blanc", categorie: "Pain", calories: 265, proteines: 9, glucides: 49, lipides: 3.2 },
            { nom: "Pain complet", categorie: "Pain", calories: 247, proteines: 13, glucides: 41, lipides: 3.5 },
            { nom: "Pain de mie", categorie: "Pain", calories: 266, proteines: 8.9, glucides: 49, lipides: 3.3 },
            { nom: "Pomme de terre cuite", categorie: "F√©culent", calories: 77, proteines: 2, glucides: 17, lipides: 0.1 },
            { nom: "Patate douce cuite", categorie: "F√©culent", calories: 90, proteines: 2, glucides: 21, lipides: 0.2 },
            { nom: "Flocons d'avoine", categorie: "C√©r√©ale", calories: 389, proteines: 17, glucides: 66, lipides: 7 },
            { nom: "Muesli", categorie: "C√©r√©ale", calories: 364, proteines: 9.7, glucides: 66, lipides: 5.7 },
            { nom: "Corn flakes", categorie: "C√©r√©ale", calories: 357, proteines: 7.5, glucides: 84, lipides: 0.9 },
            
            // L√©gumineuses
            { nom: "Lentilles cuites", categorie: "L√©gumineuse", calories: 116, proteines: 9, glucides: 20, lipides: 0.4 },
            { nom: "Pois chiches cuits", categorie: "L√©gumineuse", calories: 164, proteines: 8.9, glucides: 27, lipides: 2.6 },
            { nom: "Haricots rouges cuits", categorie: "L√©gumineuse", calories: 127, proteines: 8.7, glucides: 23, lipides: 0.5 },
            { nom: "Haricots blancs cuits", categorie: "L√©gumineuse", calories: 139, proteines: 9.7, glucides: 25, lipides: 0.5 },
            
            // L√©gumes
            { nom: "Tomate", categorie: "L√©gume", calories: 18, proteines: 0.9, glucides: 3.9, lipides: 0.2 },
            { nom: "Carotte", categorie: "L√©gume", calories: 41, proteines: 0.9, glucides: 10, lipides: 0.2 },
            { nom: "Brocoli", categorie: "L√©gume", calories: 34, proteines: 2.8, glucides: 7, lipides: 0.4 },
            { nom: "Courgette", categorie: "L√©gume", calories: 17, proteines: 1.2, glucides: 3.1, lipides: 0.3 },
            { nom: "Concombre", categorie: "L√©gume", calories: 15, proteines: 0.7, glucides: 3.6, lipides: 0.1 },
            { nom: "Salade verte", categorie: "L√©gume", calories: 15, proteines: 1.4, glucides: 2.9, lipides: 0.2 },
            { nom: "√âpinards", categorie: "L√©gume", calories: 23, proteines: 2.9, glucides: 3.6, lipides: 0.4 },
            { nom: "Haricots verts", categorie: "L√©gume", calories: 31, proteines: 1.8, glucides: 7, lipides: 0.2 },
            { nom: "Poivron", categorie: "L√©gume", calories: 31, proteines: 1, glucides: 6, lipides: 0.3 },
            { nom: "Champignon", categorie: "L√©gume", calories: 22, proteines: 3.1, glucides: 3.3, lipides: 0.3 },
            { nom: "Oignon", categorie: "L√©gume", calories: 40, proteines: 1.1, glucides: 9.3, lipides: 0.1 },
            { nom: "Aubergine", categorie: "L√©gume", calories: 25, proteines: 1, glucides: 6, lipides: 0.2 },
            { nom: "Chou-fleur", categorie: "L√©gume", calories: 25, proteines: 1.9, glucides: 5, lipides: 0.3 },
            
            // Fruits
            { nom: "Pomme", categorie: "Fruit", calories: 52, proteines: 0.3, glucides: 14, lipides: 0.2 },
            { nom: "Banane", categorie: "Fruit", calories: 89, proteines: 1.1, glucides: 23, lipides: 0.3 },
            { nom: "Orange", categorie: "Fruit", calories: 47, proteines: 0.9, glucides: 12, lipides: 0.1 },
            { nom: "Fraise", categorie: "Fruit", calories: 32, proteines: 0.7, glucides: 7.7, lipides: 0.3 },
            { nom: "Kiwi", categorie: "Fruit", calories: 61, proteines: 1.1, glucides: 15, lipides: 0.5 },
            { nom: "Raisin", categorie: "Fruit", calories: 69, proteines: 0.7, glucides: 18, lipides: 0.2 },
            { nom: "Poire", categorie: "Fruit", calories: 57, proteines: 0.4, glucides: 15, lipides: 0.1 },
            { nom: "P√™che", categorie: "Fruit", calories: 39, proteines: 0.9, glucides: 10, lipides: 0.3 },
            { nom: "Abricot", categorie: "Fruit", calories: 48, proteines: 1.4, glucides: 11, lipides: 0.4 },
            { nom: "Ananas", categorie: "Fruit", calories: 50, proteines: 0.5, glucides: 13, lipides: 0.1 },
            { nom: "Melon", categorie: "Fruit", calories: 34, proteines: 0.8, glucides: 8, lipides: 0.2 },
            { nom: "Past√®que", categorie: "Fruit", calories: 30, proteines: 0.6, glucides: 7.6, lipides: 0.2 },
            { nom: "Avocat", categorie: "Fruit", calories: 160, proteines: 2, glucides: 8.5, lipides: 15 },
            
            // Noix et graines
            { nom: "Amande", categorie: "Noix", calories: 579, proteines: 21, glucides: 22, lipides: 50 },
            { nom: "Noix", categorie: "Noix", calories: 654, proteines: 15, glucides: 14, lipides: 65 },
            { nom: "Noisette", categorie: "Noix", calories: 628, proteines: 15, glucides: 17, lipides: 61 },
            { nom: "Pistache", categorie: "Noix", calories: 560, proteines: 20, glucides: 28, lipides: 45 },
            { nom: "Cacahu√®te", categorie: "Noix", calories: 567, proteines: 26, glucides: 16, lipides: 49 },
            { nom: "Graines de chia", categorie: "Graine", calories: 486, proteines: 17, glucides: 42, lipides: 31 },
            { nom: "Graines de lin", categorie: "Graine", calories: 534, proteines: 18, glucides: 29, lipides: 42 },
            
            // Mati√®res grasses
            { nom: "Huile d'olive", categorie: "Mati√®re grasse", calories: 884, proteines: 0, glucides: 0, lipides: 100 },
            { nom: "Beurre", categorie: "Mati√®re grasse", calories: 717, proteines: 0.9, glucides: 0.1, lipides: 81 },
            { nom: "Margarine", categorie: "Mati√®re grasse", calories: 717, proteines: 0.2, glucides: 0.8, lipides: 80 },
            { nom: "Cr√®me fra√Æche", categorie: "Mati√®re grasse", calories: 300, proteines: 2.2, glucides: 3.3, lipides: 30 },
            
            // Produits sucr√©s
            { nom: "Chocolat noir", categorie: "Sucr√©", calories: 546, proteines: 6.1, glucides: 61, lipides: 32 },
            { nom: "Chocolat au lait", categorie: "Sucr√©", calories: 535, proteines: 7.6, glucides: 59, lipides: 30 },
            { nom: "Miel", categorie: "Sucr√©", calories: 304, proteines: 0.3, glucides: 82, lipides: 0 },
            { nom: "Confiture", categorie: "Sucr√©", calories: 278, proteines: 0.4, glucides: 70, lipides: 0.1 },
            { nom: "Sucre", categorie: "Sucr√©", calories: 387, proteines: 0, glucides: 100, lipides: 0 },
            
            // Boissons
            { nom: "Jus d'orange", categorie: "Boisson", calories: 45, proteines: 0.7, glucides: 10, lipides: 0.2 },
            { nom: "Coca-Cola", categorie: "Boisson", calories: 42, proteines: 0, glucides: 10.6, lipides: 0 },
            { nom: "Caf√© (sans sucre)", categorie: "Boisson", calories: 2, proteines: 0.1, glucides: 0, lipides: 0 },
            { nom: "Th√© (sans sucre)", categorie: "Boisson", calories: 1, proteines: 0, glucides: 0.3, lipides: 0 }
        ];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            chargerProfil();
            afficherCitationAleatoire();
            afficherPesees();
            afficherHistoriqueProduits();
            afficherHistoriqueRepas();
            afficherProduitsPerso();
            afficherProduitsFrigo();
            afficherRecettesFavorites();
            actualiserCoachIA();
            document.getElementById('datePesee').valueAsDate = new Date();
            
            // Event listener pour la touche Entr√©e
            document.getElementById('manualBarcode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    rechercherCodeBarre();
                }
            });

            // Event listener pour la touche Entr√©e sur le frigo
            const inputFrigo = document.getElementById('codebarreFrigo');
            if (inputFrigo) {
                inputFrigo.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        ajouterProduitFrigo();
                    }
                });
            }

            // Fermer les suggestions si clic en dehors
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#searchAliment') && !e.target.closest('#suggestionsAliments')) {
                    document.getElementById('suggestionsAliments').style.display = 'none';
                }
            });

            addDebugLog('Application initialis√©e');

            // V√©rifier si objectif d√©j√† atteint au chargement
            verifierObjectifAtteint();

            // Initialiser le calendrier avec le mois actuel
            afficherMoisActuel();

            // V√©rifier et afficher des suggestions contextuelles
            verifierEtAfficherSuggestion();

            // Cr√©er le bouton flottant de signalement
            const btnSignalement = document.createElement('button');
            btnSignalement.innerHTML = 'üîß';
            btnSignalement.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                color: white;
                border: none;
                font-size: 24px;
                cursor: pointer;
                box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
                z-index: 9998;
                transition: all 0.3s;
            `;
            btnSignalement.onmouseover = function() {
                this.style.transform = 'scale(1.1)';
                this.style.boxShadow = '0 8px 30px rgba(255, 107, 107, 0.6)';
            };
            btnSignalement.onmouseout = function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '0 5px 20px rgba(255, 107, 107, 0.4)';
            };
            btnSignalement.onclick = ouvrirModalCorrection;
            btnSignalement.title = 'Signaler une erreur';
            document.body.appendChild(btnSignalement);
        });

        function showTab(tabName) {
            // Arr√™ter le scanner si on quitte l'onglet scanner
            if (scannerActif && tabName !== 'scanner') {
                addDebugLog('Changement d\'onglet - arr√™t du scanner');
                arreterScanner();
            }

            // Arr√™ter le scanner frigo si on quitte l'onglet frigo
            if (scannerFrigoActif && tabName !== 'frigo') {
                arreterScannerFrigo();
            }

            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Afficher le contenu s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            
            // Trouver et activer l'onglet correspondant
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick').includes(tabName)) {
                    tab.classList.add('active');
                }
            });

            // Actions sp√©cifiques selon l'onglet
            if (tabName === 'suivi') {
                dessinerGraphique();
            } else if (tabName === 'coachai') {
                actualiserCoachIA();
            } else if (tabName === 'calculateur') {
                calculerCaloriesJour();
            } else if (tabName === 'frigo') {
                afficherProduitsFrigo();
                afficherRecettesFavorites();
            }

            // Scroll en haut de la page
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========== FONCTIONS DE PROFIL ET SUIVI ==========

        function calculerProfil() {
            const nom = document.getElementById('nom').value;
            const sexe = document.getElementById('sexe').value;
            const age = parseFloat(document.getElementById('age').value);
            const taille = parseFloat(document.getElementById('taille').value);
            const poids = parseFloat(document.getElementById('poids').value);
            const objectif = parseFloat(document.getElementById('objectif').value);
            const activite = parseFloat(document.getElementById('activite').value);

            if (!nom || !age || !taille || !poids || !objectif) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            // Calcul IMC
            const imc = (poids / ((taille / 100) ** 2)).toFixed(1);
            
            // Calcul poids id√©al (formule de Lorentz)
            let poidsIdeal;
            if (sexe === 'homme') {
                poidsIdeal = (taille - 100 - ((taille - 150) / 4)).toFixed(1);
            } else {
                poidsIdeal = (taille - 100 - ((taille - 150) / 2.5)).toFixed(1);
            }

            // Poids √† perdre
            const aPerdre = Math.max(0, poids - objectif).toFixed(1);

            // Calcul calories (formule de Harris-Benedict)
            let bmr;
            if (sexe === 'homme') {
                bmr = 88.362 + (13.397 * poids) + (4.799 * taille) - (5.677 * age);
            } else {
                bmr = 447.593 + (9.247 * poids) + (3.098 * taille) - (4.330 * age);
            }
            const calories = Math.round((bmr * activite) - 500);

            // Cat√©gorie IMC
            let categorieIMC;
            if (imc < 18.5) {
                categorieIMC = "Insuffisance pond√©rale";
            } else if (imc < 25) {
                categorieIMC = "Poids normal - F√©licitations ! üéâ";
            } else if (imc < 30) {
                categorieIMC = "Surpoids - Vous √™tes sur la bonne voie ! üí™";
            } else {
                categorieIMC = "Ob√©sit√© - Courage, chaque pas compte ! üåü";
            }

            // Dur√©e estim√©e
            const semaines = Math.ceil(aPerdre / 0.5);
            const mois = (semaines / 4.33).toFixed(1);

            // Affichage
            document.getElementById('imcValue').textContent = imc;
            document.getElementById('poidsIdealValue').textContent = poidsIdeal;
            document.getElementById('aPerdrValue').textContent = aPerdre;
            document.getElementById('caloriesValue').textContent = calories;
            document.getElementById('imcCategorie').innerHTML = `<strong>Cat√©gorie :</strong> ${categorieIMC}`;
            document.getElementById('dureeProgramme').innerHTML = `<strong>Dur√©e estim√©e :</strong> ${semaines} semaines (environ ${mois} mois) pour atteindre votre objectif de mani√®re saine.`;

            document.getElementById('resultatProfil').classList.add('show');

            // Sauvegarder
            userData = { nom, sexe, age, taille, poids, objectif, activite, imc, poidsIdeal, calories };
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        function chargerProfil() {
            if (Object.keys(userData).length > 0) {
                document.getElementById('nom').value = userData.nom || '';
                document.getElementById('sexe').value = userData.sexe || 'femme';
                document.getElementById('age').value = userData.age || '';
                document.getElementById('taille').value = userData.taille || '';
                document.getElementById('poids').value = userData.poids || '';
                document.getElementById('objectif').value = userData.objectif || '';
                document.getElementById('activite').value = userData.activite || '1.2';
            }
        }

        function ajouterPesee() {
            const date = document.getElementById('datePesee').value;
            const poids = parseFloat(document.getElementById('poidsPesee').value);

            if (!date || !poids) {
                alert('Veuillez remplir la date et le poids');
                return;
            }

            const index = pesees.findIndex(p => p.date === date);
            if (index !== -1) {
                if (confirm('Une pes√©e existe d√©j√† pour cette date. Voulez-vous la remplacer ?')) {
                    pesees[index] = { date, poids };
                } else {
                    return;
                }
            } else {
                pesees.push({ date, poids });
            }

            pesees.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('pesees', JSON.stringify(pesees));
            afficherPesees();
            dessinerGraphique();

            document.getElementById('poidsPesee').value = '';
            document.getElementById('datePesee').valueAsDate = new Date();

            // V√©rifier si objectif atteint
            verifierObjectifAtteint();

            // Proposer de voir les conseils personnalis√©s
            setTimeout(() => {
                if (pesees.length >= 2) {
                    if (confirm('‚úÖ Pes√©e enregistr√©e !\n\nüí° Voulez-vous voir votre progression et vos conseils personnalis√©s ?')) {
                        showTab('coachai');
                        document.querySelector('.tab[onclick*="coachai"]').classList.add('active');
                    }
                }
            }, 300);
        }

        function afficherPesees() {
            const liste = document.getElementById('listePesees');
            liste.innerHTML = '';

            if (pesees.length === 0) {
                liste.innerHTML = '<p style="text-align: center; color: #999;">Aucune pes√©e enregistr√©e</p>';
                return;
            }

            afficherProgression();

            [...pesees].reverse().forEach((pesee, index) => {
                const realIndex = pesees.length - 1 - index;
                const div = document.createElement('div');
                div.className = 'weight-item';
                
                const dateFormatee = new Date(pesee.date + 'T00:00:00').toLocaleDateString('fr-FR', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                div.innerHTML = `
                    <span class="date">${dateFormatee}</span>
                    <span class="weight">${pesee.poids} kg</span>
                    <button class="delete" onclick="supprimerPesee(${realIndex})">Supprimer</button>
                `;
                liste.appendChild(div);
            });
        }

        function afficherProgression() {
            const progressionDiv = document.getElementById('progressionActuelle');
            
            if (pesees.length === 0 || !userData.objectif) {
                progressionDiv.innerHTML = '';
                return;
            }

            const poidsActuel = pesees[pesees.length - 1].poids;
            const poidsDepart = pesees[0].poids;
            const objectif = userData.objectif;

            const totalAPerdre = poidsDepart - objectif;
            const dejaPerdu = poidsDepart - poidsActuel;
            const resteAPerdre = poidsActuel - objectif;

            const pourcentage = Math.min(100, Math.max(0, (dejaPerdu / totalAPerdre) * 100));

            progressionDiv.innerHTML = `
                <div style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="color: white; margin-bottom: 10px;">üìä Votre progression</h3>
                    <div style="display: flex; justify-content: space-between; color: white; margin-bottom: 10px;">
                        <span>D√©part: ${poidsDepart} kg</span>
                        <span>Actuel: ${poidsActuel} kg</span>
                        <span>Objectif: ${objectif} kg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${pourcentage}%">${pourcentage.toFixed(1)}%</div>
                    </div>
                    <div style="color: white; margin-top: 10px; text-align: center;">
                        <strong>Perdu: ${dejaPerdu.toFixed(1)} kg</strong> sur ${totalAPerdre.toFixed(1)} kg
                        ${resteAPerdre > 0 ? ` - Encore ${resteAPerdre.toFixed(1)} kg √† perdre !` : ' - Objectif atteint ! üéâ'}
                    </div>
                </div>
            `;
        }

        function supprimerPesee(index) {
            if (confirm('Voulez-vous vraiment supprimer cette pes√©e ?')) {
                pesees.splice(index, 1);
                localStorage.setItem('pesees', JSON.stringify(pesees));
                afficherPesees();
                dessinerGraphique();
            }
        }

        function dessinerGraphique() {
            const canvas = document.getElementById('graphiquePoids');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth;
            canvas.height = 300;

            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            if (pesees.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donn√©e √† afficher', width / 2, height / 2);
                return;
            }

            const padding = 50;
            const graphWidth = width - 2 * padding;
            const graphHeight = height - 2 * padding;

            const poids = pesees.map(p => p.poids);
            const minPoids = Math.min(...poids, userData.objectif || Infinity) - 2;
            const maxPoids = Math.max(...poids) + 2;
            const rangePoids = maxPoids - minPoids;

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            if (userData.objectif) {
                const yObjectif = height - padding - ((userData.objectif - minPoids) / rangePoids) * graphHeight;
                ctx.strokeStyle = '#ff4757';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(padding, yObjectif);
                ctx.lineTo(width - padding, yObjectif);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.fillStyle = '#ff4757';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(`Objectif: ${userData.objectif} kg`, width - padding + 5, yObjectif + 5);
            }

            ctx.strokeStyle = '#667eea';
            ctx.fillStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();

            pesees.forEach((pesee, index) => {
                const x = padding + (index / (pesees.length - 1 || 1)) * graphWidth;
                const y = height - padding - ((pesee.poids - minPoids) / rangePoids) * graphHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                ctx.fillRect(x - 4, y - 4, 8, 8);

                ctx.fillStyle = '#333';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${pesee.poids}`, x, y - 10);

                if (pesees.length <= 10 || index % Math.ceil(pesees.length / 10) === 0 || index === pesees.length - 1) {
                    const dateFormatee = new Date(pesee.date + 'T00:00:00').toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit'
                    });
                    ctx.save();
                    ctx.translate(x, height - padding + 15);
                    ctx.rotate(-Math.PI / 4);
                    ctx.fillText(dateFormatee, 0, 0);
                    ctx.restore();
                }

                ctx.fillStyle = '#667eea';
            });

            ctx.stroke();

            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const poids = minPoids + (rangePoids * i / 5);
                const y = height - padding - (i * graphHeight / 5);
                ctx.fillText(poids.toFixed(1) + ' kg', padding - 10, y + 4);
            }
        }

        function afficherCitationAleatoire() {
            const citation = citations[Math.floor(Math.random() * citations.length)];
            document.getElementById('citationJour').textContent = `"${citation.texte}"`;
            document.getElementById('auteurCitation').textContent = `- ${citation.auteur}`;
        }

        // ========== FONCTIONS CALCULATEUR DE CALORIES ==========

        function rechercherAliment() {
            const recherche = document.getElementById('searchAliment').value.toLowerCase();
            const suggestions = document.getElementById('suggestionsAliments');

            if (recherche.length < 2) {
                suggestions.style.display = 'none';
                return;
            }

            const resultats = baseAliments.filter(aliment => 
                aliment.nom.toLowerCase().includes(recherche)
            ).slice(0, 10);

            if (resultats.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestions.innerHTML = resultats.map(aliment => `
                <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                    <div onclick="selectionnerAliment('${aliment.nom}')" style="flex: 1; cursor: pointer;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 3px;">${aliment.nom}</div>
                        <div style="font-size: 0.85em; color: #666;">
                            ${aliment.calories} kcal ‚Ä¢ ${aliment.proteines}g prot ‚Ä¢ ${aliment.glucides}g gluc ‚Ä¢ ${aliment.lipides}g lip
                            <span style="color: #667eea; margin-left: 8px;">(100g)</span>
                        </div>
                    </div>
                    <button onclick="ajouterAlimentRapide('${aliment.nom}'); event.stopPropagation();" 
                            style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; white-space: nowrap; transition: transform 0.2s;"
                            onmouseover="this.style.transform='scale(1.05)'"
                            onmouseout="this.style.transform='scale(1)'">
                        ‚ûï 100g
                    </button>
                </div>
            `).join('');

            // Ajouter l'effet hover
            suggestions.querySelectorAll('div[onclick]').forEach(div => {
                div.addEventListener('mouseenter', function() {
                    this.style.background = '#f8f9fa';
                });
                div.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                });
            });

            suggestions.style.display = 'block';
        }

        function selectionnerAliment(nom) {
            document.getElementById('searchAliment').value = nom;
            document.getElementById('suggestionsAliments').style.display = 'none';
            document.getElementById('quantiteAliment').focus();
        }

        function ajouterAlimentCalcul() {
            const nomAliment = document.getElementById('searchAliment').value;
            const quantite = parseFloat(document.getElementById('quantiteAliment').value);

            if (!nomAliment) {
                alert('Veuillez saisir un aliment');
                return;
            }

            if (!quantite || quantite <= 0) {
                alert('Veuillez saisir une quantit√© valide en grammes');
                return;
            }

            // Chercher l'aliment dans la base
            const aliment = baseAliments.find(a => a.nom.toLowerCase() === nomAliment.toLowerCase());

            if (!aliment) {
                alert('Aliment non trouv√© dans la base de donn√©es. Veuillez utiliser les suggestions.');
                return;
            }

            // Calculer les valeurs pour la quantit√© saisie
            const facteur = quantite / 100;
            const alimentCalcule = {
                nom: aliment.nom,
                quantite: quantite,
                calories: Math.round(aliment.calories * facteur * 10) / 10,
                proteines: Math.round(aliment.proteines * facteur * 10) / 10,
                glucides: Math.round(aliment.glucides * facteur * 10) / 10,
                lipides: Math.round(aliment.lipides * facteur * 10) / 10
            };

            repasActuel.push(alimentCalcule);
            afficherRepasActuel();

            // R√©initialiser le formulaire
            document.getElementById('searchAliment').value = '';
            document.getElementById('quantiteAliment').value = '';
            document.getElementById('searchAliment').focus();
        }

        function afficherRepasActuel() {
            if (repasActuel.length === 0) {
                document.getElementById('repasActuel').style.display = 'none';
                return;
            }

            document.getElementById('repasActuel').style.display = 'block';

            const liste = document.getElementById('listeAlimentsRepas');
            liste.innerHTML = repasActuel.map((aliment, index) => `
                <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">
                            ${aliment.nom} (${aliment.quantite}g)
                        </div>
                        <div style="font-size: 0.9em; opacity: 0.9;">
                            ${aliment.calories} kcal ‚Ä¢ 
                            ${aliment.proteines}g prot ‚Ä¢ 
                            ${aliment.glucides}g gluc ‚Ä¢ 
                            ${aliment.lipides}g lip
                        </div>
                    </div>
                    <button onclick="retirerAliment(${index})" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 18px;">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');

            // Calculer les totaux
            const totaux = repasActuel.reduce((acc, aliment) => ({
                calories: acc.calories + aliment.calories,
                proteines: acc.proteines + aliment.proteines,
                glucides: acc.glucides + aliment.glucides,
                lipides: acc.lipides + aliment.lipides
            }), { calories: 0, proteines: 0, glucides: 0, lipides: 0 });

            document.getElementById('totalCalories').textContent = Math.round(totaux.calories);
            document.getElementById('totalProteines').textContent = Math.round(totaux.proteines * 10) / 10;
            document.getElementById('totalGlucides').textContent = Math.round(totaux.glucides * 10) / 10;
            document.getElementById('totalLipides').textContent = Math.round(totaux.lipides * 10) / 10;
        }

        function retirerAliment(index) {
            repasActuel.splice(index, 1);
            afficherRepasActuel();
        }

        function reinitialiserRepas() {
            if (repasActuel.length === 0) return;
            
            if (confirm('Voulez-vous vraiment vider ce repas ?')) {
                repasActuel = [];
                afficherRepasActuel();
            }
        }

        function sauvegarderRepas() {
            if (repasActuel.length === 0) {
                alert('Ajoutez des aliments avant de sauvegarder');
                return;
            }

            const nomRepas = prompt('Donnez un nom √† ce repas (ex: Petit-d√©jeuner, D√©jeuner, Collation...)', '');
            
            if (!nomRepas) return;

            const totaux = repasActuel.reduce((acc, aliment) => ({
                calories: acc.calories + aliment.calories,
                proteines: acc.proteines + aliment.proteines,
                glucides: acc.glucides + aliment.glucides,
                lipides: acc.lipides + aliment.lipides
            }), { calories: 0, proteines: 0, glucides: 0, lipides: 0 });

            const repas = {
                id: Date.now(),
                nom: nomRepas,
                date: new Date().toISOString(),
                aliments: [...repasActuel],
                totaux: {
                    calories: Math.round(totaux.calories),
                    proteines: Math.round(totaux.proteines * 10) / 10,
                    glucides: Math.round(totaux.glucides * 10) / 10,
                    lipides: Math.round(totaux.lipides * 10) / 10
                }
            };

            repasSauvegardes.unshift(repas);
            localStorage.setItem('repas', JSON.stringify(repasSauvegardes));

            afficherHistoriqueRepas();
            repasActuel = [];
            afficherRepasActuel();

            // Synchroniser les donn√©es
            synchroniserDonnees();

            alert('‚úÖ Repas sauvegard√© avec succ√®s !');
            
            // Afficher une notification de suggestion
            setTimeout(() => {
                if (confirm('üí° Voulez-vous voir les suggestions de collations adapt√©es √† vos calories ?')) {
                    actionRapide('coach');
                }
            }, 500);
        }

        function afficherHistoriqueRepas() {
            const historique = document.getElementById('historiqueRepas');

            if (repasSauvegardes.length === 0) {
                historique.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucun repas sauvegard√©</p>';
                calculerCaloriesJour();
                return;
            }

            historique.innerHTML = repasSauvegardes.map((repas, index) => {
                const date = new Date(repas.date);
                const dateFormatee = date.toLocaleDateString('fr-FR', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const heureFormatee = date.toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="weight-item" style="flex-direction: column; align-items: stretch; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; color: #667eea; font-size: 1.2em; margin-bottom: 5px;">
                                    ${repas.nom}
                                </div>
                                <div style="color: #999; font-size: 0.9em;">
                                    ${dateFormatee} √† ${heureFormatee}
                                </div>
                            </div>
                            <button class="delete" onclick="supprimerRepas(${index})">Supprimer</button>
                        </div>

                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.calories}</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">kcal</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.proteines}g</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">prot√©ines</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.glucides}g</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">glucides</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${repas.totaux.lipides}g</div>
                                    <div style="font-size: 0.85em; opacity: 0.9;">lipides</div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">D√©tail des aliments :</div>
                            ${repas.aliments.map(aliment => `
                                <div style="padding: 6px 0; border-bottom: 1px solid #e0e0e0; font-size: 0.95em; color: #555;">
                                    ‚Ä¢ ${aliment.nom} (${aliment.quantite}g) - ${Math.round(aliment.calories)} kcal
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            calculerCaloriesJour();
        }

        function supprimerRepas(index) {
            if (confirm('Voulez-vous vraiment supprimer ce repas ?')) {
                repasSauvegardes.splice(index, 1);
                localStorage.setItem('repas', JSON.stringify(repasSauvegardes));
                afficherHistoriqueRepas();
            }
        }

        function calculerCaloriesJour() {
            const aujourdhui = new Date().toDateString();
            
            const repasAujourdhui = repasSauvegardes.filter(repas => {
                const dateRepas = new Date(repas.date).toDateString();
                return dateRepas === aujourdhui;
            });

            const caloriesJour = repasAujourdhui.reduce((total, repas) => total + repas.totaux.calories, 0);
            
            document.getElementById('caloriesJour').textContent = Math.round(caloriesJour);

            // Afficher l'objectif si d√©fini
            if (userData.calories) {
                const objectif = userData.calories;
                const pourcentage = Math.min(100, (caloriesJour / objectif) * 100);
                
                document.getElementById('objectifCaloriesMsg').style.display = 'block';
                document.getElementById('objectifCaloriesValue').textContent = objectif;
                document.getElementById('progressCaloriesJour').style.display = 'block';
                
                const progressFill = document.getElementById('progressCaloriesFill');
                progressFill.style.width = pourcentage + '%';
                
                let couleur;
                if (pourcentage < 80) {
                    couleur = 'linear-gradient(90deg, #4caf50 0%, #45a049 100%)';
                } else if (pourcentage < 100) {
                    couleur = 'linear-gradient(90deg, #ffc107 0%, #ff9800 100%)';
                } else {
                    couleur = 'linear-gradient(90deg, #ff4757 0%, #e84118 100%)';
                }
                
                progressFill.style.background = couleur;
                progressFill.textContent = Math.round(pourcentage) + '%';
            } else {
                document.getElementById('objectifCaloriesMsg').style.display = 'none';
                document.getElementById('progressCaloriesJour').style.display = 'none';
            }
        }

        // ========== FIN FONCTIONS CALCULATEUR DE CALORIES ==========

        // ========== FONCTIONS BASE DE DONN√âES PERSONNELLE ==========

        // Gestion de la photo
        document.addEventListener('DOMContentLoaded', function() {
            const inputPhoto = document.getElementById('photoProduitPerso');
            if (inputPhoto) {
                inputPhoto.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) { // 5MB max
                            alert('La photo est trop volumineuse. Maximum 5MB.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(event) {
                            photoPersoBase64 = event.target.result;
                            document.getElementById('imgPreviewPerso').src = photoPersoBase64;
                            document.getElementById('previewPhotoPerso').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        function retirerPhotoPerso() {
            photoPersoBase64 = null;
            document.getElementById('photoProduitPerso').value = '';
            document.getElementById('previewPhotoPerso').style.display = 'none';
        }

        function ajouterProduitPerso() {
            const nom = document.getElementById('nomProduitPerso').value.trim();
            const marque = document.getElementById('marqueProduitPerso').value.trim();
            const codebarre = document.getElementById('codebarreProduitPerso').value.trim();
            const quantite = document.getElementById('quantiteProduitPerso').value.trim();
            const calories = parseFloat(document.getElementById('caloriesProduitPerso').value);
            const proteines = parseFloat(document.getElementById('proteinesProduitPerso').value);
            const glucides = parseFloat(document.getElementById('glucidesProduitPerso').value);
            const lipides = parseFloat(document.getElementById('lipidesProduitPerso').value);
            const notes = document.getElementById('notesProduitPerso').value.trim();

            // Validations
            if (!nom) {
                alert('‚ö†Ô∏è Le nom du produit est obligatoire');
                return;
            }

            if (!codebarre) {
                alert('‚ö†Ô∏è Le code-barres est obligatoire');
                return;
            }

            if (!/^\d{13}$/.test(codebarre)) {
                alert('‚ö†Ô∏è Le code-barres doit contenir exactement 13 chiffres');
                return;
            }

            if (isNaN(calories) || isNaN(proteines) || isNaN(glucides) || isNaN(lipides)) {
                alert('‚ö†Ô∏è Toutes les valeurs nutritionnelles doivent √™tre remplies');
                return;
            }

            if (calories < 0 || proteines < 0 || glucides < 0 || lipides < 0) {
                alert('‚ö†Ô∏è Les valeurs nutritionnelles ne peuvent pas √™tre n√©gatives');
                return;
            }

            // V√©rifier si le code-barres existe d√©j√†
            const indexExistant = produitsPerso.findIndex(p => p.barcode === codebarre);
            if (indexExistant !== -1) {
                if (!confirm('‚ö†Ô∏è Un produit avec ce code-barres existe d√©j√†. Voulez-vous le remplacer ?')) {
                    return;
                }
                produitsPerso.splice(indexExistant, 1);
            }

            // Cr√©er le produit
            const produit = {
                id: Date.now(),
                barcode: codebarre,
                nom: nom,
                marque: marque || 'Produit personnel',
                quantite: quantite,
                image: photoPersoBase64,
                calories: calories,
                proteines: proteines,
                glucides: glucides,
                lipides: lipides,
                notes: notes,
                dateAjout: new Date().toISOString(),
                source: 'personnel'
            };

            // Ajouter le produit
            produitsPerso.unshift(produit);
            localStorage.setItem('produitsPerso', JSON.stringify(produitsPerso));

            // Afficher la liste
            afficherProduitsPerso();

            // R√©initialiser le formulaire
            document.getElementById('nomProduitPerso').value = '';
            document.getElementById('marqueProduitPerso').value = '';
            document.getElementById('codebarreProduitPerso').value = '';
            document.getElementById('quantiteProduitPerso').value = '';
            document.getElementById('caloriesProduitPerso').value = '';
            document.getElementById('proteinesProduitPerso').value = '';
            document.getElementById('glucidesProduitPerso').value = '';
            document.getElementById('lipidesProduitPerso').value = '';
            document.getElementById('notesProduitPerso').value = '';
            retirerPhotoPerso();

            alert('‚úÖ Produit ajout√© avec succ√®s √† votre base personnelle !');
            
            // Scroll vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function afficherProduitsPerso() {
            const liste = document.getElementById('listeProduitsPerso');
            const compteur = document.getElementById('compteurProduitsPerso');

            compteur.textContent = produitsPerso.length;

            if (produitsPerso.length === 0) {
                liste.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìù</div>
                        <p style="color: #999; font-size: 1.1em;">Aucun produit personnalis√©</p>
                        <p style="color: #666; font-size: 0.95em; margin-top: 10px;">Ajoutez vos produits ci-dessus pour les retrouver facilement lors du scan !</p>
                    </div>
                `;
                return;
            }

            liste.innerHTML = produitsPerso.map((produit, index) => {
                const dateAjout = new Date(produit.dateAjout).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });

                return `
                    <div class="weight-item" style="flex-direction: column; align-items: stretch; margin-bottom: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div style="display: flex; gap: 15px; align-items: start; margin-bottom: 12px;">
                            ${produit.image ? `
                                <img src="${produit.image}" alt="${produit.nom}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #667eea;">
                            ` : `
                                <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2.5em;">
                                    üì¶
                                </div>
                            `}
                            
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-weight: bold; color: #333; font-size: 1.15em; margin-bottom: 3px;">
                                            ${produit.nom}
                                        </div>
                                        <div style="color: #667eea; font-size: 0.9em; margin-bottom: 3px;">
                                            ${produit.marque}
                                        </div>
                                        ${produit.quantite ? `
                                            <div style="color: #666; font-size: 0.85em;">
                                                üìè ${produit.quantite}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button class="delete" onclick="supprimerProduitPerso(${index})" style="flex-shrink: 0;">Supprimer</button>
                                </div>
                                
                                <div style="background: white; padding: 8px 10px; border-radius: 6px; margin-bottom: 5px;">
                                    <div style="font-size: 0.85em; color: #666; margin-bottom: 3px;">
                                        üìä Code-barres: <strong style="color: #333;">${produit.barcode}</strong>
                                    </div>
                                    <div style="font-size: 0.8em; color: #999;">
                                        üìÖ Ajout√© le ${dateAjout}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #667eea; font-size: 1.2em;">${Math.round(produit.calories)}</div>
                                <div style="font-size: 0.75em; color: #666;">kcal/100g</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #f5576c; font-size: 1.2em;">${produit.proteines.toFixed(1)}g</div>
                                <div style="font-size: 0.75em; color: #666;">prot√©ines</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #00f2fe; font-size: 1.2em;">${produit.glucides.toFixed(1)}g</div>
                                <div style="font-size: 0.75em; color: #666;">glucides</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: #38f9d7; font-size: 1.2em;">${produit.lipides.toFixed(1)}g</div>
                                <div style="font-size: 0.75em; color: #666;">lipides</div>
                            </div>
                        </div>

                        ${produit.notes ? `
                            <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 3px solid #ffc107; margin-bottom: 10px;">
                                <div style="font-size: 0.85em; color: #856404; line-height: 1.4;">
                                    üí≠ ${produit.notes}
                                </div>
                            </div>
                        ` : ''}

                        <button onclick="ajouterProduitPersoAuCalculateur(${index})" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;">
                            üßÆ Ajouter au Calculateur
                        </button>
                    </div>
                `;
            }).join('');
        }

        function supprimerProduitPerso(index) {
            const produit = produitsPerso[index];
            
            if (confirm(`Voulez-vous vraiment supprimer "${produit.nom}" de votre base personnelle ?`)) {
                produitsPerso.splice(index, 1);
                localStorage.setItem('produitsPerso', JSON.stringify(produitsPerso));
                afficherProduitsPerso();
            }
        }

        function rechercherDansBasePerso(barcode) {
            return produitsPerso.find(p => p.barcode === barcode);
        }

        // ========== FIN FONCTIONS BASE DE DONN√âES PERSONNELLE ==========

        // ========== FONCTIONS COACH IA ==========

        function actualiserCoachIA() {
            afficherTableauBordIA();
            suggererCollations();
            genererConseilsPersonnalises();
            genererMotivationAdaptee();
            analyserSemaine();
            genererActionsRecommandees();
            verifierObjectifAtteint();
        }

        function afficherTableauBordIA() {
            const tableau = document.getElementById('tableauBordIA');
            const nom = userData.nom || 'Champion';
            document.getElementById('nomCoachIA').textContent = nom;

            // Calculer les donn√©es
            const aujourdhui = new Date().toDateString();
            const repasAujourdhui = repasSauvegardes.filter(r => new Date(r.date).toDateString() === aujourdhui);
            const caloriesJour = repasAujourdhui.reduce((total, r) => total + r.totaux.calories, 0);
            const objectifCal = userData.calories || 2000;
            const pourcentageObjectif = (caloriesJour / objectifCal * 100).toFixed(0);
            
            const poidsActuel = pesees.length > 0 ? pesees[pesees.length - 1].poids : userData.poids;
            const objectifPoids = userData.objectif;
            const progression = objectifPoids ? ((userData.poids - poidsActuel) / (userData.poids - objectifPoids) * 100).toFixed(0) : 0;

            let couleurCal = '#4caf50';
            if (pourcentageObjectif > 110) couleurCal = '#ff4757';
            else if (pourcentageObjectif > 100) couleurCal = '#ff9800';

            tableau.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Votre tableau de bord du jour</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: linear-gradient(135deg, ${couleurCal} 0%, ${couleurCal}dd 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Calories aujourd'hui</div>
                            <div style="font-size: 2em; font-weight: bold;">${Math.round(caloriesJour)}</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">sur ${objectifCal} kcal (${pourcentageObjectif}%)</div>
                        </div>

                        ${poidsActuel && objectifPoids ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Progression poids</div>
                            <div style="font-size: 2em; font-weight: bold;">${progression}%</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">${poidsActuel} kg ‚Üí ${objectifPoids} kg</div>
                        </div>
                        ` : ''}

                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Repas enregistr√©s</div>
                            <div style="font-size: 2em; font-weight: bold;">${repasAujourdhui.length}</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">aujourd'hui</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Pes√©es enregistr√©es</div>
                            <div style="font-size: 2em; font-weight: bold;">${pesees.length}</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">depuis le d√©but</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function suggererCollations() {
            const container = document.getElementById('suggestionsCollations');
            const objectifCal = userData.calories || 2000;
            
            const aujourdhui = new Date().toDateString();
            const repasAujourdhui = repasSauvegardes.filter(r => new Date(r.date).toDateString() === aujourdhui);
            const caloriesJour = repasAujourdhui.reduce((total, r) => total + r.totaux.calories, 0);
            const caloriesRestantes = objectifCal - caloriesJour;

            if (caloriesRestantes <= 0) {
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); padding: 20px; border-radius: 15px;">
                        <h3 style="color: #c62828; margin-bottom: 15px;">üö´ Objectif calorique atteint</h3>
                        <p style="color: #c62828; font-size: 1.05em; line-height: 1.6;">
                            Vous avez consomm√© <strong>${Math.round(caloriesJour)} kcal</strong> aujourd'hui, soit ${Math.round(caloriesJour - objectifCal)} kcal de plus que votre objectif.<br><br>
                            üí° <strong>Conseil :</strong> Privil√©giez une activit√© physique l√©g√®re et buvez beaucoup d'eau. Demain est un nouveau jour !
                        </p>
                    </div>
                `;
                return;
            }

            // D√©finir les collations avec leurs valeurs
            const collations = [
                { nom: "1 pomme moyenne", calories: 95, proteines: 0.5, glucides: 25, lipides: 0.3, emoji: "üçé" },
                { nom: "1 banane", calories: 105, proteines: 1.3, glucides: 27, lipides: 0.4, emoji: "üçå" },
                { nom: "Yaourt nature 0% (125g)", calories: 55, proteines: 9.4, glucides: 5, lipides: 0.3, emoji: "ü•õ" },
                { nom: "Poign√©e d'amandes (20g)", calories: 116, proteines: 4.2, glucides: 4.4, lipides: 10, emoji: "ü•ú" },
                { nom: "2 carr√©s chocolat noir 70%", calories: 109, proteines: 1.2, glucides: 12, lipides: 6.4, emoji: "üç´" },
                { nom: "Barre prot√©in√©e", calories: 150, proteines: 10, glucides: 15, lipides: 5, emoji: "üç´" },
                { nom: "Fromage blanc 0% (100g)", calories: 44, proteines: 7.5, glucides: 4, lipides: 0.2, emoji: "ü•õ" },
                { nom: "1 orange", calories: 62, proteines: 1.2, glucides: 15, lipides: 0.2, emoji: "üçä" },
                { nom: "Carotte + houmous (100g)", calories: 120, proteines: 4, glucides: 15, lipides: 5, emoji: "ü•ï" },
                { nom: "Smoothie vert maison", calories: 100, proteines: 2, glucides: 20, lipides: 1, emoji: "ü•§" },
                { nom: "10 noix", calories: 131, proteines: 3, glucides: 2.8, lipides: 13, emoji: "üå∞" },
                { nom: "≈íuf dur", calories: 78, proteines: 6.5, glucides: 0.6, lipides: 5.5, emoji: "ü•ö" }
            ];

            // Filtrer les collations selon les calories restantes
            let collationsAdaptees = [];
            
            if (caloriesRestantes < 100) {
                collationsAdaptees = collations.filter(c => c.calories <= 80);
            } else if (caloriesRestantes < 200) {
                collationsAdaptees = collations.filter(c => c.calories <= 150);
            } else if (caloriesRestantes < 300) {
                collationsAdaptees = collations.filter(c => c.calories <= 200);
            } else {
                collationsAdaptees = collations.filter(c => c.calories <= 300);
            }

            // S√©lectionner 3 collations al√©atoires
            const suggestions = [];
            const collationsCopie = [...collationsAdaptees];
            for (let i = 0; i < Math.min(3, collationsCopie.length); i++) {
                const index = Math.floor(Math.random() * collationsCopie.length);
                suggestions.push(collationsCopie[index]);
                collationsCopie.splice(index, 1);
            }

            let messageMotivation = '';
            if (caloriesRestantes < 100) {
                messageMotivation = "Vous √™tes presque √† votre objectif ! Une petite collation l√©g√®re suffit.";
            } else if (caloriesRestantes < 200) {
                messageMotivation = "Vous g√©rez parfaitement votre apport calorique ! Voici quelques id√©es de collations.";
            } else if (caloriesRestantes < 400) {
                messageMotivation = "Excellent √©quilibre ! Vous pouvez vous permettre une bonne collation.";
            } else {
                messageMotivation = "Il vous reste de la marge ! Profitez-en pour faire un bon encas √©quilibr√©.";
            }

            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 15px;">
                    <h3 style="color: #333; margin-bottom: 10px;">üçé Suggestions de collations personnalis√©es</h3>
                    <p style="color: #555; font-size: 1.05em; margin-bottom: 5px;">
                        <strong>Il vous reste ${Math.round(caloriesRestantes)} kcal</strong> pour aujourd'hui
                    </p>
                    <p style="color: #667eea; font-size: 0.95em; margin-bottom: 20px;">
                        ${messageMotivation}
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        ${suggestions.map(collation => `
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                                <div style="font-size: 2em; margin-bottom: 8px;">${collation.emoji}</div>
                                <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 1.05em;">
                                    ${collation.nom}
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.85em; color: #666;">
                                    <div>üî• ${collation.calories} kcal</div>
                                    <div>üí™ ${collation.proteines}g prot</div>
                                    <div>üçû ${collation.glucides}g gluc</div>
                                    <div>üßà ${collation.lipides}g lip</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${caloriesRestantes > 500 ? `
                        <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <p style="color: #ff6b6b; font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Attention</p>
                            <p style="color: #555; font-size: 0.9em;">
                                Vous avez encore beaucoup de calories disponibles. Pensez √† bien manger vos repas principaux pour √©viter les fringales en soir√©e !
                            </p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function genererConseilsPersonnalises() {
            const container = document.getElementById('conseilsPersonnalises');
            const aujourdhui = new Date().toDateString();
            const repasAujourdhui = repasSauvegardes.filter(r => new Date(r.date).toDateString() === aujourdhui);
            
            let conseils = [];

            // Conseil bas√© sur le nombre de repas
            if (repasAujourdhui.length === 0) {
                conseils.push({
                    titre: "üìù Commencez √† enregistrer vos repas",
                    texte: "N'oubliez pas d'enregistrer ce que vous mangez pour un meilleur suivi ! Utilisez le Calculateur ou le Scanner.",
                    type: "action"
                });
            } else if (repasAujourdhui.length === 1) {
                conseils.push({
                    titre: "üçΩÔ∏è Fractionnez vos repas",
                    texte: "Vous n'avez enregistr√© qu'un seul repas aujourd'hui. Pensez √† fractionner en 3-4 repas pour mieux r√©guler votre m√©tabolisme.",
                    type: "nutrition"
                });
            } else if (repasAujourdhui.length >= 5) {
                conseils.push({
                    titre: "‚ö†Ô∏è Attention au grignotage",
                    texte: "Vous avez enregistr√© beaucoup de repas aujourd'hui. Assurez-vous de ne pas grignoter entre les repas principaux.",
                    type: "alerte"
                });
            }

            // Conseil bas√© sur l'hydratation
            const joursSemaine = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
            const jour = joursSemaine[new Date().getDay()];
            
            conseils.push({
                titre: "üíß Hydratation du " + jour,
                texte: "Avez-vous bu vos 1.5L d'eau aujourd'hui ? L'hydratation est essentielle pour la perte de poids et le bien-√™tre g√©n√©ral.",
                type: "rappel"
            });

            // Conseil bas√© sur le poids
            if (pesees.length >= 2) {
                const dernierePesee = pesees[pesees.length - 1];
                const avantDernierePesee = pesees[pesees.length - 2];
                const evolution = dernierePesee.poids - avantDernierePesee.poids;

                if (evolution < -0.5) {
                    conseils.push({
                        titre: "üéâ Excellente progression !",
                        texte: `Vous avez perdu ${Math.abs(evolution).toFixed(1)} kg depuis votre derni√®re pes√©e ! Continuez comme √ßa, vous √™tes sur la bonne voie.`,
                        type: "succes"
                    });
                } else if (evolution > 0.5) {
                    conseils.push({
                        titre: "üí™ Restez motiv√© !",
                        texte: `Petite prise de poids d√©tect√©e (+${evolution.toFixed(1)} kg). C'est normal, le poids fluctue ! Concentrez-vous sur vos habitudes √† long terme.`,
                        type: "motivation"
                    });
                }
            } else if (pesees.length === 0) {
                conseils.push({
                    titre: "‚öñÔ∏è Premi√®re pes√©e",
                    texte: "Pensez √† vous peser r√©guli√®rement (1 fois par semaine id√©alement) pour suivre votre progression !",
                    type: "action"
                });
            }

            // Conseil activit√© physique
            conseils.push({
                titre: "üèÉ‚Äç‚ôÄÔ∏è Activit√© du jour",
                texte: "Avez-vous fait vos 30 minutes d'activit√© aujourd'hui ? Une simple marche rapide suffit !",
                type: "rappel"
            });

            // S√©lectionner 3 conseils maximum
            const conseilsAffiches = conseils.slice(0, 3);

            const couleurs = {
                action: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                nutrition: 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)',
                alerte: 'linear-gradient(135deg, #ff9800 0%, #ff5722 100%)',
                rappel: 'linear-gradient(135deg, #00bcd4 0%, #03a9f4 100%)',
                succes: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                motivation: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'
            };

            container.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üí° Vos conseils personnalis√©s du jour</h3>
                    
                    <div style="display: grid; gap: 15px;">
                        ${conseilsAffiches.map(conseil => `
                            <div style="background: ${couleurs[conseil.type]}; color: white; padding: 15px; border-radius: 10px;">
                                <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">${conseil.titre}</div>
                                <div style="font-size: 0.95em; line-height: 1.5; opacity: 0.95;">${conseil.texte}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function genererMotivationAdaptee() {
            const container = document.getElementById('motivationAdaptee');
            
            // Calculer la progression
            let pourcentageProgression = 0;
            let message = '';
            let emoji = 'üåü';
            
            if (pesees.length >= 2 && userData.objectif) {
                const poidsDepart = pesees[0].poids;
                const poidsActuel = pesees[pesees.length - 1].poids;
                const objectif = userData.objectif;
                const totalAPerdre = poidsDepart - objectif;
                const dejaPerdu = poidsDepart - poidsActuel;
                pourcentageProgression = (dejaPerdu / totalAPerdre * 100);

                if (pourcentageProgression >= 100) {
                    emoji = 'üèÜ';
                    message = "INCROYABLE ! Vous avez atteint votre objectif ! Vous √™tes une vraie source d'inspiration. Maintenant, maintenez ces excellentes habitudes !";
                } else if (pourcentageProgression >= 75) {
                    emoji = 'üî•';
                    message = "FANTASTIQUE ! Vous avez parcouru 75% du chemin ! La ligne d'arriv√©e est en vue, ne l√¢chez rien maintenant !";
                } else if (pourcentageProgression >= 50) {
                    emoji = 'üí™';
                    message = "BRAVO ! Vous avez d√©pass√© la moiti√© du chemin ! Vous √™tes plus proche de votre objectif que de votre point de d√©part. Continuez !";
                } else if (pourcentageProgression >= 25) {
                    emoji = '‚≠ê';
                    message = "EXCELLENT ! Un quart du chemin d√©j√† parcouru ! Chaque kilo perdu est une victoire. Vous prouvez que vous pouvez le faire !";
                } else if (pourcentageProgression > 0) {
                    emoji = 'üöÄ';
                    message = "C'EST PARTI ! Vous avez commenc√© votre transformation ! Les premiers kilos sont toujours les plus difficiles, et vous l'avez fait !";
                } else if (pourcentageProgression < 0) {
                    emoji = 'üí≠';
                    message = "Petit contre-temps, mais ce n'est rien ! Le chemin vers la r√©ussite n'est jamais lin√©aire. Concentrez-vous sur aujourd'hui, pas sur hier.";
                }
            } else {
                emoji = 'üå±';
                message = "Bienvenue dans votre aventure sant√© ! Chaque grand voyage commence par un premier pas. Vous avez fait le plus dur : vous avez d√©cid√© de changer !";
            }

            const aujourdhui = new Date().toDateString();
            const repasAujourdhui = repasSauvegardes.filter(r => new Date(r.date).toDateString() === aujourdhui);
            const caloriesJour = repasAujourdhui.reduce((total, r) => total + r.totaux.calories, 0);
            const objectifCal = userData.calories || 2000;

            let badgeCalories = '';
            if (caloriesJour > 0 && caloriesJour <= objectifCal * 1.1) {
                badgeCalories = `
                    <div style="background: rgba(76, 175, 80, 0.2); border: 2px solid #4caf50; color: #2e7d32; padding: 12px; border-radius: 10px; text-align: center; margin-top: 15px;">
                        <div style="font-size: 1.8em; margin-bottom: 5px;">‚úÖ</div>
                        <div style="font-weight: bold;">Objectif calorique respect√© aujourd'hui !</div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 25px; border-radius: 15px; text-align: center;">
                    <div style="font-size: 4em; margin-bottom: 15px;">${emoji}</div>
                    <h3 style="color: #333; font-size: 1.5em; margin-bottom: 15px;">Message de motivation personnalis√©</h3>
                    <p style="color: #555; font-size: 1.15em; line-height: 1.7; font-weight: 500;">
                        ${message}
                    </p>
                    ${pourcentageProgression > 0 ? `
                        <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 10px; margin-top: 20px;">
                            <div style="font-size: 3em; font-weight: bold; color: #667eea;">${Math.round(pourcentageProgression)}%</div>
                            <div style="color: #666; font-size: 1.1em;">de progression vers votre objectif</div>
                        </div>
                    ` : ''}
                    ${badgeCalories}
                </div>
            `;
        }

        function analyserSemaine() {
            const container = document.getElementById('analyseSemaine');
            
            // Calculer la date d'il y a 7 jours
            const ilYa7Jours = new Date();
            ilYa7Jours.setDate(ilYa7Jours.getDate() - 7);

            // Filtrer les repas de la semaine
            const repasSemaine = repasSauvegardes.filter(r => new Date(r.date) >= ilYa7Jours);
            
            if (repasSemaine.length === 0) {
                container.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 15px;">üìä</div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">Analyse de la semaine</h3>
                        <p style="color: #999;">Pas encore de donn√©es cette semaine. Commencez √† enregistrer vos repas !</p>
                    </div>
                `;
                return;
            }

            // Calculer les moyennes
            const totalCal = repasSemaine.reduce((total, r) => total + r.totaux.calories, 0);
            const moyenneCal = Math.round(totalCal / 7);
            const moyenneProt = Math.round(repasSemaine.reduce((total, r) => total + r.totaux.proteines, 0) / repasSemaine.length);
            const moyenneGluc = Math.round(repasSemaine.reduce((total, r) => total + r.totaux.glucides, 0) / repasSemaine.length);
            const moyenneLip = Math.round(repasSemaine.reduce((total, r) => total + r.totaux.lipides, 0) / repasSemaine.length);

            const objectifCal = userData.calories || 2000;
            const ecartObjectif = moyenneCal - objectifCal;

            let commentaire = '';
            if (Math.abs(ecartObjectif) <= 100) {
                commentaire = "üéØ Parfait ! Vous respectez votre objectif calorique.";
            } else if (ecartObjectif < 0) {
                commentaire = `‚úÖ Vous √™tes ${Math.abs(ecartObjectif)} kcal en dessous de votre objectif. Bon √©quilibre !`;
            } else {
                commentaire = `‚ö†Ô∏è Vous d√©passez votre objectif de ${ecartObjectif} kcal/jour en moyenne.`;
            }

            container.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Analyse des 7 derniers jours</h3>
                    
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #e1bee7 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${moyenneCal}</div>
                                <div style="font-size: 0.85em; color: #666;">kcal/jour</div>
                            </div>
                            <div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #f5576c;">${moyenneProt}g</div>
                                <div style="font-size: 0.85em; color: #666;">prot√©ines</div>
                            </div>
                            <div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #00f2fe;">${moyenneGluc}g</div>
                                <div style="font-size: 0.85em; color: #666;">glucides</div>
                            </div>
                            <div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #38f9d7;">${moyenneLip}g</div>
                                <div style="font-size: 0.85em; color: #666;">lipides</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <p style="color: #333; font-size: 1.05em; font-weight: 500;">${commentaire}</p>
                        <p style="color: #666; font-size: 0.9em; margin-top: 8px;">
                            Vous avez enregistr√© ${repasSemaine.length} repas cette semaine, soit une moyenne de ${(repasSemaine.length / 7).toFixed(1)} repas par jour.
                        </p>
                    </div>
                </div>
            `;
        }

        function genererActionsRecommandees() {
            const container = document.getElementById('actionsRecommandees');
            
            const actions = [];

            // Actions bas√©es sur les donn√©es
            const aujourdhui = new Date().toDateString();
            const repasAujourdhui = repasSauvegardes.filter(r => new Date(r.date).toDateString() === aujourdhui);

            if (repasAujourdhui.length === 0) {
                actions.push({
                    titre: "Enregistrez votre premier repas",
                    description: "Commencez √† suivre votre alimentation d√®s maintenant",
                    action: "Aller au Calculateur",
                    onclick: "showTab('calculateur'); document.querySelector('.tab[onclick*=\"calculateur\"]').classList.add('active');",
                    icon: "üßÆ"
                });
            }

            if (pesees.length === 0) {
                actions.push({
                    titre: "Pesez-vous pour la premi√®re fois",
                    description: "√âtablissez votre point de d√©part pour suivre votre progression",
                    action: "Aller au Suivi du Poids",
                    onclick: "showTab('suivi'); document.querySelector('.tab[onclick*=\"suivi\"]').classList.add('active');",
                    icon: "üìà"
                });
            } else {
                const dernierePesee = new Date(pesees[pesees.length - 1].date);
                const joursDepuisPesee = Math.floor((new Date() - dernierePesee) / (1000 * 60 * 60 * 24));
                
                if (joursDepuisPesee >= 7) {
                    actions.push({
                        titre: "Pesez-vous cette semaine",
                        description: `Cela fait ${joursDepuisPesee} jours depuis votre derni√®re pes√©e`,
                        action: "Enregistrer mon poids",
                        onclick: "showTab('suivi'); document.querySelector('.tab[onclick*=\"suivi\"]').classList.add('active');",
                        icon: "‚öñÔ∏è"
                    });
                }
            }

            if (produitsPerso.length === 0) {
                actions.push({
                    titre: "Cr√©ez votre base personnelle",
                    description: "Ajoutez vos produits favoris pour un scan ultra-rapide",
                    action: "Cr√©er ma base",
                    onclick: "showTab('baseperso'); document.querySelector('.tab[onclick*=\"baseperso\"]').classList.add('active');",
                    icon: "üìù"
                });
            }

            actions.push({
                titre: "Consultez les menus types",
                description: "D√©couvrez des id√©es de repas √©quilibr√©s",
                action: "Voir les menus",
                onclick: "showTab('menus'); document.querySelector('.tab[onclick*=\"menus\"]').classList.add('active');",
                icon: "üçΩÔ∏è"
            });

            // Limiter √† 3 actions
            const actionsAffichees = actions.slice(0, 3);

            container.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Actions recommand√©es</h3>
                    
                    <div style="display: grid; gap: 12px;">
                        ${actionsAffichees.map(action => `
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: transform 0.2s;" onclick="${action.onclick}" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                                <div style="font-size: 2.5em; flex-shrink: 0;">${action.icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #333; margin-bottom: 5px; font-size: 1.05em;">${action.titre}</div>
                                    <div style="color: #666; font-size: 0.9em;">${action.description}</div>
                                </div>
                                <button class="btn" style="margin: 0; padding: 10px 20px; width: auto; font-size: 0.9em;">
                                    ${action.action} ‚Üí
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ========== FIN FONCTIONS COACH IA ==========

        // ========== FONCTIONS FRIGO & RECETTES ==========

        function demarrerScannerFrigo() {
            const container = document.getElementById('scannerFrigoContainer');
            const startBtn = document.getElementById('startScanFrigoBtn');
            const stopBtn = document.getElementById('stopScanFrigoBtn');
            const erreurDiv = document.getElementById('erreurCameraFrigo');

            // Cacher les erreurs pr√©c√©dentes
            if (erreurDiv) erreurDiv.style.display = 'none';

            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';

            dernierCodeDetecteFrigo = null;

            // D'abord demander l'acc√®s √† la cam√©ra explicitement
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { min: 640, ideal: 1280 },
                    height: { min: 480, ideal: 720 }
                },
                audio: false
            })
            .then(function(stream) {
                console.log("Acc√®s cam√©ra frigo autoris√©");
                
                // Arr√™ter le stream, Quagga va le g√©rer
                stream.getTracks().forEach(track => track.stop());

                container.style.display = 'block';

                // Initialiser Quagga
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#interactiveFrigo'),
                        constraints: {
                            width: { min: 640, ideal: 1280 },
                            height: { min: 480, ideal: 720 },
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: navigator.hardwareConcurrency ? Math.min(navigator.hardwareConcurrency, 4) : 2,
                    frequency: 10,
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader"]
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error("Erreur Quagga Frigo:", err);
                        arreterScannerFrigo();
                        
                        if (erreurDiv) {
                            erreurDiv.style.display = 'block';
                            erreurDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            alert("Erreur du scanner. Utilisez la saisie manuelle du code-barres.");
                        }
                        return;
                    }
                    
                    scannerFrigoActif = true;
                    Quagga.start();
                    console.log("Scanner frigo d√©marr√©");
                });

                Quagga.onDetected(function(result) {
                    if (!result || !result.codeResult || !result.codeResult.code) return;
                    
                    const code = result.codeResult.code;
                    
                    if (!/^\d{8,13}$/.test(code)) return;
                    if (code === dernierCodeDetecteFrigo) return;

                    dernierCodeDetecteFrigo = code;
                    console.log("Code frigo d√©tect√©:", code);

                    if (navigator.vibrate) {
                        navigator.vibrate([200, 100, 200]);
                    }

                    arreterScannerFrigo();
                    
                    timeoutDetectionFrigo = setTimeout(() => {
                        document.getElementById('codebarreFrigo').value = code;
                        ajouterProduitFrigo();
                    }, 200);
                });
            })
            .catch(function(err) {
                console.error("Erreur acc√®s cam√©ra frigo:", err);
                arreterScannerFrigo();
                
                // Afficher le message d'erreur d√©taill√©
                if (erreurDiv) {
                    erreurDiv.style.display = 'block';
                    erreurDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    alert("‚ùå Impossible d'acc√©der √† la cam√©ra.\n\nüí° Utilisez la saisie manuelle du code-barres ci-dessus, c'est plus fiable sur mobile !");
                }
            });
        }

        function arreterScannerFrigo() {
            const container = document.getElementById('scannerFrigoContainer');
            const startBtn = document.getElementById('startScanFrigoBtn');
            const stopBtn = document.getElementById('stopScanFrigoBtn');

            if (scannerFrigoActif) {
                try {
                    Quagga.stop();
                } catch (e) {
                    console.error("Erreur arr√™t scanner frigo:", e);
                }
                scannerFrigoActif = false;
            }

            container.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';

            dernierCodeDetecteFrigo = null;
            if (timeoutDetectionFrigo) {
                clearTimeout(timeoutDetectionFrigo);
                timeoutDetectionFrigo = null;
            }
        }

        async function ajouterProduitFrigo() {
            const codebarre = document.getElementById('codebarreFrigo').value.trim();

            if (!codebarre) {
                alert('‚ö†Ô∏è Veuillez saisir un code-barres');
                return;
            }

            if (!/^\d{8,13}$/.test(codebarre)) {
                alert('‚ö†Ô∏è Le code-barres doit contenir entre 8 et 13 chiffres');
                return;
            }

            // V√©rifier si d√©j√† dans le frigo
            if (produitsFrigo.find(p => p.barcode === codebarre)) {
                alert('‚ÑπÔ∏è Ce produit est d√©j√† dans votre frigo');
                document.getElementById('codebarreFrigo').value = '';
                return;
            }

            document.getElementById('loadingFrigo').style.display = 'block';

            // Chercher d'abord dans la base perso
            let produit = rechercherDansBasePerso(codebarre);
            
            if (produit) {
                ajouterAuFrigo({
                    barcode: codebarre,
                    nom: produit.nom,
                    marque: produit.marque,
                    image: produit.image,
                    calories: produit.calories,
                    proteines: produit.proteines,
                    glucides: produit.glucides,
                    lipides: produit.lipides,
                    source: 'personnel'
                });
                document.getElementById('loadingFrigo').style.display = 'none';
                return;
            }

            // Sinon chercher dans OpenFoodFacts
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${codebarre}.json`);
                const data = await response.json();

                document.getElementById('loadingFrigo').style.display = 'none';

                if (data.status === 1 && data.product) {
                    ajouterAuFrigo({
                        barcode: codebarre,
                        nom: data.product.product_name || 'Produit sans nom',
                        marque: data.product.brands || 'Marque inconnue',
                        image: data.product.image_url || data.product.image_front_url || '',
                        calories: data.product.nutriments?.['energy-kcal_100g'] || data.product.nutriments?.['energy-kcal'] || 0,
                        proteines: data.product.nutriments?.proteins_100g || data.product.nutriments?.proteins || 0,
                        glucides: data.product.nutriments?.carbohydrates_100g || data.product.nutriments?.carbohydrates || 0,
                        lipides: data.product.nutriments?.fat_100g || data.product.nutriments?.fat || 0,
                        source: 'openfoodfacts'
                    });
                } else {
                    alert('‚ùå Produit non trouv√©. Vous pouvez l\'ajouter dans "Ma Base Perso" puis le scanner √† nouveau.');
                }
            } catch (error) {
                document.getElementById('loadingFrigo').style.display = 'none';
                alert('‚ùå Erreur de connexion. V√©rifiez votre internet.');
            }
        }

        function ajouterAuFrigo(produit) {
            produitsFrigo.unshift({
                ...produit,
                dateAjout: new Date().toISOString()
            });
            localStorage.setItem('produitsFrigo', JSON.stringify(produitsFrigo));
            afficherProduitsFrigo();
            document.getElementById('codebarreFrigo').value = '';
            
            // Animation de succ√®s
            const btn = document.querySelector('button[onclick="ajouterProduitFrigo()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Ajout√© !';
            btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 1500);
        }

        function afficherProduitsFrigo() {
            const liste = document.getElementById('listeProduitsFrigo');
            const compteur = document.getElementById('compteurFrigo');

            compteur.textContent = produitsFrigo.length;

            if (produitsFrigo.length === 0) {
                liste.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 10px;">
                        <div style="font-size: 4em; margin-bottom: 15px;">üßä</div>
                        <p style="color: #999; font-size: 1.1em;">Votre frigo est vide</p>
                        <p style="color: #666; font-size: 0.95em; margin-top: 10px;">Scannez vos produits pour commencer !</p>
                    </div>
                `;
                return;
            }

            liste.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px;">
                    ${produitsFrigo.map((produit, index) => `
                        <div style="background: white; border-radius: 10px; padding: 12px; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <button onclick="retirerDuFrigo(${index})" style="position: absolute; top: 5px; right: 5px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; padding: 0; z-index: 1;">√ó</button>
                            
                            ${produit.image ? `
                                <img src="${produit.image}" style="width: 100%; height: 100px; object-fit: contain; border-radius: 8px; margin-bottom: 8px;">
                            ` : `
                                <div style="width: 100%; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2.5em; margin-bottom: 8px;">üì¶</div>
                            `}
                            
                            <div style="font-weight: bold; font-size: 0.9em; color: #333; margin-bottom: 3px; line-height: 1.2; height: 32px; overflow: hidden;">
                                ${produit.nom}
                            </div>
                            <div style="font-size: 0.8em; color: #667eea; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${produit.marque}
                            </div>
                            <div style="background: #f8f9fa; padding: 6px; border-radius: 5px; font-size: 0.75em; color: #666; text-align: center; margin-bottom: 8px;">
                                ${Math.round(produit.calories)} kcal/100g
                            </div>
                            <button onclick="ajouterProduitFrigoAuCalculateur(${index})" style="width: 100%; padding: 8px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.85em;">
                                üßÆ Calculateur
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function retirerDuFrigo(index) {
            if (confirm('Retirer ce produit du frigo ?')) {
                produitsFrigo.splice(index, 1);
                localStorage.setItem('produitsFrigo', JSON.stringify(produitsFrigo));
                afficherProduitsFrigo();
            }
        }

        function viderFrigo() {
            if (produitsFrigo.length === 0) return;
            
            if (confirm(`Voulez-vous vraiment vider votre frigo (${produitsFrigo.length} produits) ?`)) {
                produitsFrigo = [];
                localStorage.setItem('produitsFrigo', JSON.stringify(produitsFrigo));
                afficherProduitsFrigo();
            }
        }

        function genererRecettes() {
            if (produitsFrigo.length === 0) {
                alert('‚ö†Ô∏è Votre frigo est vide ! Ajoutez des produits d\'abord.');
                return;
            }

            const type = document.getElementById('typeRecette').value;
            const difficulte = document.getElementById('difficulteRecette').value;

            // Base de recettes avec ingr√©dients requis
            const basesRecettes = [
                {
                    nom: "Poulet R√¥ti au Citron",
                    type: "dejeuner",
                    difficulte: "moyen",
                    temps: 35,
                    ingredients: ["poulet", "citron", "huile"],
                    portions: 4,
                    emoji: "üçó",
                    instructions: [
                        "Pr√©chauffer le four √† 200¬∞C",
                        "Assaisonner le poulet avec sel, poivre et jus de citron",
                        "Arroser d'huile d'olive",
                        "Enfourner 30-35 minutes",
                        "Servir chaud avec des l√©gumes"
                    ]
                },
                {
                    nom: "Omelette aux L√©gumes",
                    type: "dejeuner",
                    difficulte: "facile",
                    temps: 15,
                    ingredients: ["≈ìuf", "tomate", "oignon"],
                    portions: 2,
                    emoji: "üç≥",
                    instructions: [
                        "Battre 3 ≈ìufs dans un bol",
                        "Couper les l√©gumes en petits d√©s",
                        "Faire revenir les l√©gumes dans une po√™le",
                        "Verser les ≈ìufs et cuire 5-7 minutes",
                        "Plier l'omelette et servir"
                    ]
                },
                {
                    nom: "Salade C√©sar Prot√©in√©e",
                    type: "dejeuner",
                    difficulte: "facile",
                    temps: 10,
                    ingredients: ["salade", "poulet", "fromage"],
                    portions: 2,
                    emoji: "ü•ó",
                    instructions: [
                        "Laver et couper la salade",
                        "√âmincer le poulet grill√©",
                        "R√¢per le fromage",
                        "M√©langer avec une vinaigrette l√©g√®re",
                        "Servir frais"
                    ]
                },
                {
                    nom: "Yaourt Bowl √ânerg√©tique",
                    type: "petit-dejeuner",
                    difficulte: "facile",
                    temps: 5,
                    ingredients: ["yaourt", "banane", "miel"],
                    portions: 1,
                    emoji: "ü•£",
                    instructions: [
                        "Verser le yaourt dans un bol",
                        "Trancher la banane",
                        "Ajouter une cuill√®re de miel",
                        "M√©langer d√©licatement",
                        "D√©guster imm√©diatement"
                    ]
                },
                {
                    nom: "Smoothie Vert D√©tox",
                    type: "collation",
                    difficulte: "facile",
                    temps: 5,
                    ingredients: ["√©pinard", "banane", "lait"],
                    portions: 1,
                    emoji: "ü•§",
                    instructions: [
                        "Mettre tous les ingr√©dients dans un blender",
                        "Mixer jusqu'√† obtenir une texture lisse",
                        "Ajouter des gla√ßons si d√©sir√©",
                        "Servir imm√©diatement"
                    ]
                },
                {
                    nom: "Saumon Grill√© aux Herbes",
                    type: "diner",
                    difficulte: "moyen",
                    temps: 20,
                    ingredients: ["saumon", "citron", "huile"],
                    portions: 2,
                    emoji: "üêü",
                    instructions: [
                        "Badigeonner le saumon d'huile d'olive",
                        "Assaisonner avec herbes, sel et poivre",
                        "Griller 6-8 minutes de chaque c√¥t√©",
                        "Arroser de jus de citron",
                        "Servir avec des l√©gumes vapeur"
                    ]
                },
                {
                    nom: "Riz Saut√© aux L√©gumes",
                    type: "dejeuner",
                    difficulte: "facile",
                    temps: 20,
                    ingredients: ["riz", "carotte", "oignon"],
                    portions: 3,
                    emoji: "üçö",
                    instructions: [
                        "Cuire le riz selon les instructions",
                        "Couper les l√©gumes en petits morceaux",
                        "Faire sauter les l√©gumes dans un wok",
                        "Ajouter le riz cuit et m√©langer",
                        "Assaisonner de sauce soja"
                    ]
                },
                {
                    nom: "Tarte aux Pommes Light",
                    type: "dessert",
                    difficulte: "moyen",
                    temps: 45,
                    ingredients: ["pomme", "farine", "≈ìuf"],
                    portions: 6,
                    emoji: "ü•ß",
                    instructions: [
                        "Pr√©parer la p√¢te avec farine, ≈ìuf et un peu d'eau",
                        "√âtaler dans un moule",
                        "Disposer les pommes tranch√©es",
                        "Saupoudrer de cannelle",
                        "Cuire 40 minutes √† 180¬∞C"
                    ]
                }
            ];

            // Filtrer selon le type et la difficult√©
            let recettesPossibles = basesRecettes.filter(recette => {
                if (type && recette.type !== type) return false;
                if (difficulte && recette.difficulte !== difficulte) return false;
                
                // V√©rifier si on a au moins 60% des ingr√©dients
                const ingredientsDisponibles = recette.ingredients.filter(ing => 
                    produitsFrigo.some(p => p.nom.toLowerCase().includes(ing.toLowerCase()))
                );
                
                return ingredientsDisponibles.length >= Math.ceil(recette.ingredients.length * 0.6);
            });

            if (recettesPossibles.length === 0) {
                document.getElementById('recettesGenerees').innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 30px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 3em; margin-bottom: 15px;">üòï</div>
                        <h3 style="color: #ff6b6b; margin-bottom: 10px;">Aucune recette possible</h3>
                        <p style="color: #666; font-size: 1.05em;">
                            Nous n'avons pas trouv√© de recettes avec vos produits actuels et vos filtres.
                        </p>
                        <p style="color: #999; margin-top: 10px;">
                            üí° Essayez de changer les filtres ou d'ajouter plus de produits √† votre frigo !
                        </p>
                    </div>
                `;
                document.getElementById('recettesGenerees').style.display = 'block';
                return;
            }

            // S√©lectionner 3 recettes al√©atoires
            const recettesSelectionnees = [];
            const recettesCopie = [...recettesPossibles];
            for (let i = 0; i < Math.min(3, recettesCopie.length); i++) {
                const index = Math.floor(Math.random() * recettesCopie.length);
                recettesSelectionnees.push(recettesCopie[index]);
                recettesCopie.splice(index, 1);
            }

            // G√©n√©rer les recettes avec calcul des calories
            const recettesHTML = recettesSelectionnees.map(recette => {
                // Calculer les calories bas√©es sur les produits du frigo
                let caloriesEstimees = 0;
                let protEstimees = 0;
                let glucEstimees = 0;
                let lipEstimees = 0;

                recette.ingredients.forEach(ing => {
                    const produit = produitsFrigo.find(p => p.nom.toLowerCase().includes(ing.toLowerCase()));
                    if (produit) {
                        // Estimer 100g par ingr√©dient
                        caloriesEstimees += produit.calories;
                        protEstimees += produit.proteines;
                        glucEstimees += produit.glucides;
                        lipEstimees += produit.lipides;
                    } else {
                        // Valeurs par d√©faut si produit pas trouv√©
                        caloriesEstimees += 50;
                        protEstimees += 2;
                        glucEstimees += 8;
                        lipEstimees += 1;
                    }
                });

                const caloriesParPortion = Math.round(caloriesEstimees / recette.portions);
                const protParPortion = Math.round((protEstimees / recette.portions) * 10) / 10;
                const glucParPortion = Math.round((glucEstimees / recette.portions) * 10) / 10;
                const lipParPortion = Math.round((lipEstimees / recette.portions) * 10) / 10;

                return `
                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <div style="font-size: 2.5em; margin-bottom: 10px;">${recette.emoji}</div>
                                <h3 style="color: #ff6b6b; font-size: 1.5em; margin-bottom: 5px;">${recette.nom}</h3>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 15px; font-size: 0.85em;">
                                        ‚è±Ô∏è ${recette.temps} min
                                    </span>
                                    <span style="background: #fff3e0; color: #f57c00; padding: 5px 12px; border-radius: 15px; font-size: 0.85em;">
                                        üë®‚Äçüç≥ ${recette.difficulte.charAt(0).toUpperCase() + recette.difficulte.slice(1)}
                                    </span>
                                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 5px 12px; border-radius: 15px; font-size: 0.85em;">
                                        üçΩÔ∏è ${recette.portions} portion(s)
                                    </span>
                                </div>
                            </div>
                            <button onclick="ajouterRecetteFavorite('${recette.nom.replace(/'/g, "\\'")}', ${caloriesParPortion}, ${protParPortion}, ${glucParPortion}, ${lipParPortion})" style="background: linear-gradient(135deg, #feca57 0%, #ff6b6b 100%); color: white; border: none; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; white-space: nowrap;">
                                ‚≠ê Favori
                            </button>
                        </div>

                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; font-size: 1.1em;">üìä Valeurs nutritionnelles par portion</h4>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${caloriesParPortion}</div>
                                    <div style="font-size: 0.8em; opacity: 0.9;">kcal</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${protParPortion}g</div>
                                    <div style="font-size: 0.8em; opacity: 0.9;">prot√©ines</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${glucParPortion}g</div>
                                    <div style="font-size: 0.8em; opacity: 0.9;">glucides</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${lipParPortion}g</div>
                                    <div style="font-size: 0.8em; opacity: 0.9;">lipides</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">üìù Ingr√©dients n√©cessaires</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                ${recette.ingredients.map(ing => {
                                    const disponible = produitsFrigo.some(p => p.nom.toLowerCase().includes(ing.toLowerCase()));
                                    return `
                                        <div style="padding: 6px 0; display: flex; align-items: center;">
                                            <span style="margin-right: 8px; font-size: 1.2em;">${disponible ? '‚úÖ' : '‚ùå'}</span>
                                            <span style="color: ${disponible ? '#4caf50' : '#ff4757'}; font-weight: ${disponible ? 'bold' : 'normal'};">
                                                ${ing.charAt(0).toUpperCase() + ing.slice(1)}
                                            </span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div>
                            <h4 style="color: #333; margin-bottom: 10px;">üë®‚Äçüç≥ Instructions</h4>
                            <ol style="line-height: 2; color: #555; padding-left: 20px;">
                                ${recette.instructions.map(inst => `<li>${inst}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recettesGenerees').innerHTML = `
                <div>
                    <h3 style="color: #ff6b6b; margin-bottom: 20px; font-size: 1.5em;">
                        ‚ú® ${recettesSelectionnees.length} recette(s) g√©n√©r√©e(s) pour vous !
                    </h3>
                    ${recettesHTML}
                </div>
            `;

            document.getElementById('recettesGenerees').style.display = 'block';
            document.getElementById('recettesGenerees').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function ajouterRecetteFavorite(nom, calories, proteines, glucides, lipides) {
            const recette = {
                id: Date.now(),
                nom: nom,
                calories: calories,
                proteines: proteines,
                glucides: glucides,
                lipides: lipides,
                dateAjout: new Date().toISOString()
            };

            // V√©rifier si d√©j√† en favoris
            if (recettesFavorites.find(r => r.nom === nom)) {
                alert('‚ÑπÔ∏è Cette recette est d√©j√† dans vos favoris !');
                return;
            }

            recettesFavorites.unshift(recette);
            localStorage.setItem('recettesFavorites', JSON.stringify(recettesFavorites));
            afficherRecettesFavorites();
            
            // Notification
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Ajout√© !';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        function afficherRecettesFavorites() {
            const container = document.getElementById('recettesFavorites');

            if (recettesFavorites.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-size: 2.5em; margin-bottom: 10px;">‚≠ê</div>
                        <p style="color: #999;">Aucune recette favorite pour le moment</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recettesFavorites.map((recette, index) => {
                const date = new Date(recette.dateAjout).toLocaleDateString('fr-FR');
                return `
                    <div style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; font-size: 1.1em; margin-bottom: 5px;">
                                ${recette.nom}
                            </div>
                            <div style="color: #666; font-size: 0.85em; margin-bottom: 8px;">
                                Ajout√© le ${date}
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <span style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">
                                    ${recette.calories} kcal
                                </span>
                                <span style="background: #ffebee; color: #c62828; padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">
                                    ${recette.proteines}g prot
                                </span>
                                <span style="background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">
                                    ${recette.glucides}g gluc
                                </span>
                                <span style="background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 12px; font-size: 0.8em;">
                                    ${recette.lipides}g lip
                                </span>
                            </div>
                        </div>
                        <button onclick="retirerRecetteFavorite(${index})" style="background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9em;">
                            üóëÔ∏è Retirer
                        </button>
                    </div>
                `;
            }).join('');
        }

        function retirerRecetteFavorite(index) {
            if (confirm('Retirer cette recette de vos favoris ?')) {
                recettesFavorites.splice(index, 1);
                localStorage.setItem('recettesFavorites', JSON.stringify(recettesFavorites));
                afficherRecettesFavorites();
            }
        }

        // ========== FIN FONCTIONS FRIGO & RECETTES ==========

        // ========== FONCTIONS DE C√âL√âBRATION ==========

        function verifierObjectifAtteint() {
            if (!userData.objectif || pesees.length === 0) return;

            const poidsActuel = pesees[pesees.length - 1].poids;
            const objectif = userData.objectif;

            // V√©rifier si objectif atteint (avec marge de 0.5kg)
            if (poidsActuel <= objectif + 0.5 && !objectifAtteintAffiche) {
                setTimeout(() => {
                    lancerCelebrationComplete();
                    objectifAtteintAffiche = true;
                    localStorage.setItem('objectifAtteintAffiche', 'true');
                }, 500);
            }
        }

        function lancerCelebrationComplete() {
            // Afficher l'overlay
            const overlay = document.getElementById('celebrationOverlay');
            const content = document.getElementById('celebrationContent');

            content.innerHTML = `
                <div style="font-size: 5em; margin-bottom: 20px; animation: bounce 1s infinite;">üèÜ</div>
                <h1 style="color: #667eea; font-size: 2.5em; margin-bottom: 15px;">OBJECTIF ATTEINT !</h1>
                <p style="color: #333; font-size: 1.3em; margin-bottom: 20px;">
                    <strong>${userData.nom || 'Champion'}</strong>, vous avez r√©ussi !
                </p>
                <p style="color: #666; font-size: 1.1em; line-height: 1.6; margin-bottom: 30px;">
                    Vous avez atteint votre objectif de <strong>${userData.objectif} kg</strong> !<br>
                    C'est une victoire incroyable ! üéâ
                </p>
                <button onclick="fermerCelebration()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border: none; border-radius: 25px; font-size: 1.2em; cursor: pointer; font-weight: bold;">
                    üéä Merci !
                </button>
            `;

            overlay.style.display = 'flex';

            // Lancer les animations
            lancerFeuxArtifice();
            lancerConfettis();
            jouerApplaudissements();
        }

        function lancerFeuxArtifice() {
            const colors = ['#ff006e', '#fb5607', '#ffbe0b', '#8338ec', '#3a86ff', '#06ffa5'];
            const container = document.body;

            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    // Position de d√©part al√©atoire
                    const startX = Math.random() * window.innerWidth;
                    const startY = window.innerHeight;

                    // Position d'arriv√©e al√©atoire
                    const endX = (Math.random() - 0.5) * 300;
                    const endY = -200 - Math.random() * 300;

                    // Cr√©er plusieurs particules pour chaque feu
                    for (let j = 0; j < 8; j++) {
                        const firework = document.createElement('div');
                        firework.className = 'firework';
                        firework.style.left = startX + 'px';
                        firework.style.top = startY + 'px';
                        firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                        
                        const angle = (j / 8) * Math.PI * 2;
                        const distance = 50 + Math.random() * 50;
                        const particleX = endX + Math.cos(angle) * distance;
                        const particleY = endY + Math.sin(angle) * distance;
                        
                        firework.style.setProperty('--x', particleX + 'px');
                        firework.style.setProperty('--y', particleY + 'px');
                        
                        container.appendChild(firework);

                        setTimeout(() => {
                            firework.remove();
                        }, 1500);
                    }
                }, i * 200);
            }
        }

        function lancerConfettis() {
            const colors = ['#ff006e', '#fb5607', '#ffbe0b', '#8338ec', '#3a86ff', '#06ffa5'];
            const shapes = ['‚óè', '‚ñ†', '‚ñ≤', '‚òÖ'];
            const container = document.body;

            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-20px';
                    confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                    confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                    confetti.style.fontSize = (10 + Math.random() * 20) + 'px';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';

                    container.appendChild(confetti);

                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }, i * 30);
            }
        }

        function jouerApplaudissements() {
            // Cr√©er un contexte audio
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Son d'applaudissements (simulation avec plusieurs notes)
                const notes = [
                    { freq: 150, time: 0 },
                    { freq: 180, time: 0.1 },
                    { freq: 150, time: 0.2 },
                    { freq: 200, time: 0.3 },
                    { freq: 150, time: 0.4 },
                    { freq: 180, time: 0.5 },
                    { freq: 220, time: 0.6 },
                    { freq: 150, time: 0.7 },
                    { freq: 180, time: 0.8 },
                    { freq: 200, time: 0.9 }
                ];

                notes.forEach(note => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = note.freq;
                        oscillator.type = 'sine';
                        gainNode.gain.value = 0.1;
                        
                        oscillator.start();
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
                        oscillator.stop(audioContext.currentTime + 0.08);
                    }, note.time * 1000);
                });

                // Son de c√©l√©bration (notes joyeuses)
                const celebrationNotes = [261.63, 329.63, 392.00, 523.25];
                celebrationNotes.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';
                        gainNode.gain.value = 0.2;
                        
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.3);
                    }, 1000 + (index * 100));
                });

            } catch (e) {
                console.log("Audio non support√©");
            }
        }

        function fermerCelebration() {
            document.getElementById('celebrationOverlay').style.display = 'none';
        }

        // Fonction de test pour la c√©l√©bration (accessible via console)
        window.testerCelebration = function() {
            objectifAtteintAffiche = false;
            localStorage.setItem('objectifAtteintAffiche', 'false');
            lancerCelebrationComplete();
        };

        // ========== FIN FONCTIONS DE C√âL√âBRATION ==========

        // ========== FONCTIONS DE CORRECTION ==========

        function ouvrirModalCorrection() {
            document.getElementById('correctionModal').style.display = 'flex';
            document.getElementById('compteurCorrections').textContent = corrections.length;
        }

        function fermerModalCorrection() {
            document.getElementById('correctionModal').style.display = 'none';
            // R√©initialiser le formulaire
            document.getElementById('typeErreur').value = '';
            document.getElementById('lieuErreur').value = '';
            document.getElementById('descriptionErreur').value = '';
            document.getElementById('correctionSuggeree').value = '';
        }

        function envoyerCorrection() {
            const type = document.getElementById('typeErreur').value;
            const lieu = document.getElementById('lieuErreur').value.trim();
            const description = document.getElementById('descriptionErreur').value.trim();
            const suggestion = document.getElementById('correctionSuggeree').value.trim();

            if (!type) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner le type d\'erreur');
                return;
            }

            if (!description) {
                alert('‚ö†Ô∏è Veuillez d√©crire l\'erreur');
                return;
            }

            const correction = {
                id: Date.now(),
                type: type,
                lieu: lieu,
                description: description,
                suggestion: suggestion,
                date: new Date().toISOString(),
                statut: 'envoy√©'
            };

            corrections.push(correction);
            localStorage.setItem('corrections', JSON.stringify(corrections));

            // Animation de succ√®s
            document.querySelector('.correction-content').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #4caf50; margin-bottom: 15px;">Merci pour votre retour !</h2>
                    <p style="color: #666; font-size: 1.1em; line-height: 1.6; margin-bottom: 25px;">
                        Votre signalement a √©t√© enregistr√© localement.<br>
                        Il nous aidera √† am√©liorer l'application !
                    </p>
                    <button onclick="fermerModalCorrection(); location.reload();" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        Fermer
                    </button>
                </div>
            `;

            setTimeout(() => {
                fermerModalCorrection();
                location.reload();
            }, 3000);
        }

        // ========== FIN FONCTIONS DE CORRECTION ==========

        // ========== CALENDRIER SAISONNIER ==========

        const calendrierSaisonnier = {
            fruits: {
                1: ["Citron", "Cl√©mentine", "Kiwi", "Mandarine", "Orange", "Pamplemousse", "Poire", "Pomme"],
                2: ["Citron", "Kiwi", "Mandarine", "Orange", "Pamplemousse", "Poire", "Pomme"],
                3: ["Citron", "Kiwi", "Orange", "Pamplemousse", "Pomme"],
                4: ["Citron", "Pomme"],
                5: ["Cerise", "Fraise", "Rhubarbe"],
                6: ["Abricot", "Cassis", "Cerise", "Fraise", "Framboise", "Groseille", "Melon", "Nectarine", "P√™che", "Prune"],
                7: ["Abricot", "Brugnon", "Cassis", "Cerise", "Figue", "Fraise", "Framboise", "Groseille", "Melon", "Mirabelle", "M√ªre", "Myrtille", "Nectarine", "Past√®que", "P√™che", "Prune"],
                8: ["Abricot", "Brugnon", "Cassis", "Figue", "Fraise", "Framboise", "Groseille", "Melon", "Mirabelle", "M√ªre", "Myrtille", "Nectarine", "Past√®que", "P√™che", "Poire", "Pomme", "Prune", "Raisin"],
                9: ["Figue", "Framboise", "Melon", "Mirabelle", "M√ªre", "Myrtille", "Nectarine", "P√™che", "Poire", "Pomme", "Prune", "Raisin"],
                10: ["Ch√¢taigne", "Coing", "Figue", "Framboise", "Kaki", "Kiwi", "Poire", "Pomme", "Raisin"],
                11: ["Ch√¢taigne", "Cl√©mentine", "Kaki", "Kiwi", "Mandarine", "Orange", "Poire", "Pomme"],
                12: ["Ch√¢taigne", "Cl√©mentine", "Kiwi", "Mandarine", "Orange", "Pamplemousse", "Poire", "Pomme"]
            },
            legumes: {
                1: ["Betterave", "Carotte", "C√©leri", "Chou", "Chou de Bruxelles", "Chou-fleur", "Courge", "Endive", "√âpinard", "M√¢che", "Navet", "Oignon", "Poireau", "Pomme de terre", "Topinambour"],
                2: ["Betterave", "Carotte", "C√©leri", "Chou", "Chou de Bruxelles", "Chou-fleur", "Endive", "√âpinard", "M√¢che", "Navet", "Oignon", "Poireau", "Pomme de terre"],
                3: ["Asperge", "Betterave", "Carotte", "Chou-fleur", "Endive", "√âpinard", "Navet", "Oignon", "Poireau", "Pomme de terre", "Radis"],
                4: ["Asperge", "Betterave", "Carotte", "Chou-fleur", "Concombre", "√âpinard", "Laitue", "Navet", "Oignon", "Petit pois", "Pomme de terre", "Radis"],
                5: ["Asperge", "Betterave", "Carotte", "Chou-fleur", "Concombre", "Courgette", "√âpinard", "Laitue", "Navet", "Oignon", "Petit pois", "Pomme de terre", "Radis", "Tomate"],
                6: ["Artichaut", "Asperge", "Aubergine", "Betterave", "Carotte", "Concombre", "Courgette", "Fenouil", "Haricot vert", "Laitue", "Petit pois", "Poivron", "Pomme de terre", "Radis", "Tomate"],
                7: ["Artichaut", "Aubergine", "Betterave", "Brocoli", "Carotte", "Concombre", "Courgette", "Fenouil", "Haricot vert", "Laitue", "Ma√Øs", "Petit pois", "Poivron", "Pomme de terre", "Radis", "Tomate"],
                8: ["Artichaut", "Aubergine", "Betterave", "Brocoli", "Carotte", "Concombre", "Courgette", "Fenouil", "Haricot vert", "Laitue", "Ma√Øs", "Poivron", "Pomme de terre", "Radis", "Tomate"],
                9: ["Artichaut", "Aubergine", "Betterave", "Brocoli", "Carotte", "C√©leri", "Chou", "Chou-fleur", "Concombre", "Courgette", "√âpinard", "Fenouil", "Haricot vert", "Laitue", "Ma√Øs", "Poireau", "Poivron", "Pomme de terre", "Potiron", "Radis", "Tomate"],
                10: ["Betterave", "Brocoli", "Carotte", "C√©leri", "Chou", "Chou de Bruxelles", "Chou-fleur", "Courge", "Endive", "√âpinard", "Fenouil", "Laitue", "M√¢che", "Navet", "Oignon", "Poireau", "Pomme de terre", "Potiron", "Radis", "Topinambour"],
                11: ["Betterave", "Carotte", "C√©leri", "Chou", "Chou de Bruxelles", "Chou-fleur", "Courge", "Endive", "√âpinard", "M√¢che", "Navet", "Oignon", "Poireau", "Pomme de terre", "Potiron", "Topinambour"],
                12: ["Betterave", "Carotte", "C√©leri", "Chou", "Chou de Bruxelles", "Chou-fleur", "Courge", "Endive", "√âpinard", "M√¢che", "Navet", "Oignon", "Poireau", "Pomme de terre", "Topinambour"]
            },
            feculents: {
                // Disponibles toute l'ann√©e
                touteAnnee: ["Riz blanc", "Riz complet", "P√¢tes", "Quinoa", "Boulgour", "Semoule", "Pain", "Pomme de terre", "Patate douce", "Lentilles", "Pois chiches", "Haricots blancs", "Haricots rouges", "Flageolets"],
                // F√©culents saisonniers
                1: ["Pomme de terre", "Lentilles", "Haricots blancs", "Pois cass√©s", "Ch√¢taigne"],
                2: ["Pomme de terre", "Lentilles", "Haricots blancs", "Pois cass√©s"],
                3: ["Pomme de terre", "Lentilles", "Pois cass√©s"],
                4: ["Pomme de terre nouvelle", "Petit pois frais"],
                5: ["Pomme de terre nouvelle", "Petit pois frais", "F√®ve"],
                6: ["Pomme de terre nouvelle", "Petit pois frais", "F√®ve", "Ma√Øs doux"],
                7: ["Pomme de terre", "Petit pois frais", "Ma√Øs doux"],
                8: ["Pomme de terre", "Ma√Øs doux", "Haricots verts"],
                9: ["Pomme de terre", "Ma√Øs doux", "Haricots verts", "Lentilles"],
                10: ["Pomme de terre", "Patate douce", "Ch√¢taigne", "Lentilles", "Haricots"],
                11: ["Pomme de terre", "Patate douce", "Ch√¢taigne", "Lentilles", "Haricots blancs"],
                12: ["Pomme de terre", "Ch√¢taigne", "Lentilles", "Haricots blancs", "Pois cass√©s"]
            }
        };

        const nomsDesaisons = {
            printemps: { nom: "Printemps", emoji: "üå∏", couleur: "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)", mois: [3, 4, 5] },
            ete: { nom: "√ât√©", emoji: "‚òÄÔ∏è", couleur: "linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%)", mois: [6, 7, 8] },
            automne: { nom: "Automne", emoji: "üçÇ", couleur: "linear-gradient(135deg, #fab1a0 0%, #e17055 100%)", mois: [9, 10, 11] },
            hiver: { nom: "Hiver", emoji: "‚ùÑÔ∏è", couleur: "linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)", mois: [12, 1, 2] }
        };

        const nomsMois = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];

        function afficherMoisActuel() {
            const moisActuel = new Date().getMonth() + 1;
            document.getElementById('selectMois').value = moisActuel;
            afficherMois(moisActuel);
        }

        function afficherSaisonActuelle() {
            const mois = new Date().getMonth() + 1;
            let saison;
            
            if (mois >= 3 && mois <= 5) saison = 'printemps';
            else if (mois >= 6 && mois <= 8) saison = 'ete';
            else if (mois >= 9 && mois <= 11) saison = 'automne';
            else saison = 'hiver';
            
            afficherSaison(saison);
        }

        function afficherMois(mois) {
            mois = parseInt(mois);
            const fruits = calendrierSaisonnier.fruits[mois] || [];
            const legumes = calendrierSaisonnier.legumes[mois] || [];
            const feculentsSaison = calendrierSaisonnier.feculents[mois] || [];
            const feculentsAnnee = calendrierSaisonnier.feculents.touteAnnee || [];

            let saisonInfo = '';
            for (let [key, value] of Object.entries(nomsDesaisons)) {
                if (value.mois.includes(mois)) {
                    saisonInfo = value;
                    break;
                }
            }

            const container = document.getElementById('resultatCalendrier');
            container.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <h2 style="color: #56ab2f; font-size: 2em; margin-bottom: 10px;">
                            ${saisonInfo.emoji} ${nomsMois[mois - 1]}
                        </h2>
                        <p style="color: #666; font-size: 1.1em;">Saison : ${saisonInfo.nom}</p>
                    </div>

                    <!-- Fruits -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">üçé</span>
                            Fruits de saison (${fruits.length})
                        </h3>
                        ${fruits.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                                ${fruits.map(fruit => `
                                    <div style="background: linear-gradient(135deg, #ffafbd 0%, #ffc3a0 100%); padding: 12px; border-radius: 10px; text-align: center; color: white; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                        ${fruit}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="color: #999; font-style: italic;">Peu de fruits frais ce mois-ci</p>'}
                    </div>

                    <!-- L√©gumes -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #4caf50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">ü•ï</span>
                            L√©gumes de saison (${legumes.length})
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                            ${legumes.map(legume => `
                                <div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); padding: 12px; border-radius: 10px; text-align: center; color: white; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                    ${legume}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- F√©culents -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #ff9800; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">üåæ</span>
                            F√©culents du mois (${feculentsSaison.length})
                        </h3>
                        ${feculentsSaison.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                ${feculentsSaison.map(feculent => `
                                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 10px; text-align: center; color: white; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                        ${feculent}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800;">
                            <div style="font-weight: bold; color: #ff9800; margin-bottom: 10px;">
                                üì¶ F√©culents disponibles toute l'ann√©e (${feculentsAnnee.length})
                            </div>
                            <div style="color: #666; font-size: 0.9em; line-height: 1.8;">
                                ${feculentsAnnee.join(' ‚Ä¢ ')}
                            </div>
                        </div>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 4px solid #4caf50; margin-top: 25px;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">üí° Astuce du mois</div>
                        <div style="color: #555; font-size: 0.95em; line-height: 1.6;">
                            ${getAstuceMois(mois)}
                        </div>
                    </div>
                </div>
            `;

            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function afficherSaison(saison) {
            const info = nomsDesaisons[saison];
            const moisSaison = info.mois;

            // Combiner les fruits, l√©gumes et f√©culents de tous les mois de la saison
            const fruitsSet = new Set();
            const legumesSet = new Set();
            const feculentsSet = new Set();

            moisSaison.forEach(mois => {
                (calendrierSaisonnier.fruits[mois] || []).forEach(f => fruitsSet.add(f));
                (calendrierSaisonnier.legumes[mois] || []).forEach(l => legumesSet.add(l));
                (calendrierSaisonnier.feculents[mois] || []).forEach(f => feculentsSet.add(f));
            });

            const fruits = Array.from(fruitsSet).sort();
            const legumes = Array.from(legumesSet).sort();
            const feculents = Array.from(feculentsSet).sort();
            const feculentsAnnee = calendrierSaisonnier.feculents.touteAnnee;

            const container = document.getElementById('resultatCalendrier');
            container.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <div style="background: ${info.couleur}; color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 25px;">
                        <h2 style="font-size: 2.5em; margin-bottom: 10px;">${info.emoji} ${info.nom}</h2>
                        <p style="font-size: 1.1em; opacity: 0.95;">
                            ${moisSaison.map(m => nomsMois[m - 1]).join(', ')}
                        </p>
                    </div>

                    <!-- Fruits -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">üçé</span>
                            Fruits de ${info.nom.toLowerCase()} (${fruits.length})
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                            ${fruits.map(fruit => `
                                <div style="background: linear-gradient(135deg, #ffafbd 0%, #ffc3a0 100%); padding: 12px; border-radius: 10px; text-align: center; color: white; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                    ${fruit}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- L√©gumes -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #4caf50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">ü•ï</span>
                            L√©gumes de ${info.nom.toLowerCase()} (${legumes.length})
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">
                            ${legumes.map(legume => `
                                <div style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); padding: 12px; border-radius: 10px; text-align: center; color: white; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                    ${legume}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- F√©culents -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #ff9800; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">üåæ</span>
                            F√©culents de ${info.nom.toLowerCase()} (${feculents.length})
                        </h3>
                        ${feculents.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                ${feculents.map(feculent => `
                                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 10px; text-align: center; color: white; font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                                        ${feculent}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #ff9800;">
                            <div style="font-weight: bold; color: #ff9800; margin-bottom: 10px;">
                                üì¶ F√©culents disponibles toute l'ann√©e (${feculentsAnnee.length})
                            </div>
                            <div style="color: #666; font-size: 0.9em; line-height: 1.8;">
                                ${feculentsAnnee.join(' ‚Ä¢ ')}
                            </div>
                        </div>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 4px solid #4caf50; margin-top: 25px;">
                        <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">üí° Astuce de ${info.nom.toLowerCase()}</div>
                        <div style="color: #555; font-size: 0.95em; line-height: 1.6;">
                            ${getAstuceSaison(saison)}
                        </div>
                    </div>
                </div>
            `;

            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function getAstuceMois(mois) {
            const astuces = {
                1: "En hiver, privil√©giez les agrumes riches en vitamine C pour booster votre syst√®me immunitaire !",
                2: "C'est le moment id√©al pour les soupes de l√©gumes d'hiver bien chaudes et r√©confortantes.",
                3: "Le printemps arrive ! Profitez des premi√®res asperges, d√©licieuses vapeur avec un filet de citron.",
                4: "Les radis et les petits pois frais sont excellents en salade pour des repas l√©gers et printaniers.",
                5: "C'est la pleine saison des fraises ! Privil√©giez-les locales et bio pour plus de saveur.",
                6: "L'√©t√© approche : abricots, cerises et melons sont parfaits pour des desserts frais et peu caloriques.",
                7: "Profitez de l'abondance estivale : tomates, courgettes et aubergines pour des ratatouilles savoureuses.",
                8: "Les p√™ches et nectarines sont √† leur apog√©e ! Excellentes nature ou en smoothies rafra√Æchissants.",
                9: "L'automne d√©bute : c'est la saison du raisin et des figues, riches en fibres et antioxydants.",
                10: "Les courges et potirons arrivent ! Parfaits pour des soupes onctueuses et des pur√©es r√©confortantes.",
                11: "Les champignons de saison sont d√©licieux po√™l√©s avec des herbes fra√Æches.",
                12: "En d√©cembre, les endives et m√¢che sont id√©ales pour des salades croquantes et vitamin√©es."
            };
            return astuces[mois] || "Mangez vari√© et de saison pour une sant√© optimale !";
        }

        function getAstuceSaison(saison) {
            const astuces = {
                printemps: "Le printemps est la saison du renouveau ! Profitez des l√©gumes verts frais pour d√©toxifier votre organisme apr√®s l'hiver. Les asperges sont diur√©tiques et les petits pois riches en prot√©ines v√©g√©tales.",
                ete: "L'√©t√© offre une explosion de couleurs et de saveurs ! Les fruits rouges sont riches en antioxydants, et les l√©gumes du soleil (tomates, courgettes, aubergines) se cuisinent facilement en plats l√©gers.",
                automne: "L'automne apporte les courges et les champignons ! C'est aussi la saison des fruits √† coque comme les ch√¢taignes, riches en fibres. Parfait pour pr√©parer son corps √† l'hiver.",
                hiver: "L'hiver est la saison des l√©gumes racines et des agrumes ! Les poireaux, choux et carottes se marient parfaitement en soupes chaudes. Les agrumes boostent votre immunit√©."
            };
            return astuces[saison] || "Mangez de saison pour une alimentation saine et √©conomique !";
        }

        // ========== FIN CALENDRIER SAISONNIER ==========

        // ========== FONCTIONS SCANNER - VERSION AM√âLIOR√âE ==========

        function addDebugLog(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(`[Scanner Debug] ${message}`);
        }

        function toggleDebug() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.classList.toggle('show');
        }

        function demarrerScanner() {
            addDebugLog('üé¨ D√©marrage du scanner demand√©');
            
            const placeholder = document.getElementById('scanPlaceholder');
            const interactive = document.getElementById('interactive');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');

            // Cacher les r√©sultats pr√©c√©dents
            document.getElementById('resultatScanner').style.display = 'none';
            document.getElementById('erreurScanner').style.display = 'none';
            document.getElementById('erreurPermission').style.display = 'none';

            // R√©initialiser les variables
            dernierCodeDetecte = null;
            if (timeoutDetection) {
                clearTimeout(timeoutDetection);
            }

            placeholder.style.display = 'none';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';

            addDebugLog('üì± Demande d\'acc√®s √† la cam√©ra...');

            // Configuration Quagga am√©lior√©e
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: "environment", // Cam√©ra arri√®re
                        aspectRatio: { min: 1, max: 2 }
                    },
                    area: { // Zone de scan optimis√©e
                        top: "25%",
                        right: "10%",
                        left: "10%",
                        bottom: "25%"
                    },
                    singleChannel: false // Am√©liore la d√©tection
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: navigator.hardwareConcurrency ? Math.min(navigator.hardwareConcurrency, 4) : 2,
                frequency: 10, // Fr√©quence de scan
                decoder: {
                    readers: [
                        "ean_reader",      // EAN-13, EAN-8
                        "ean_8_reader",
                        "code_128_reader",
                        "code_39_reader",
                        "upc_reader",      // UPC-A, UPC-E
                        "upc_e_reader"
                    ],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: false,
                        drawScanline: true,
                        showPattern: false
                    },
                    multiple: false
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error("Erreur Quagga:", err);
                    addDebugLog('‚ùå Erreur Quagga: ' + err.message);
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        addDebugLog('üö´ Permission cam√©ra refus√©e');
                        document.getElementById('erreurPermission').style.display = 'block';
                        document.getElementById('erreurPermission').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        alert("Erreur lors de l'initialisation du scanner: " + err.message + "\nVeuillez utiliser la saisie manuelle.");
                    }
                    
                    arreterScanner();
                    return;
                }
                
                addDebugLog('‚úÖ Quagga initialis√© avec succ√®s');
                addDebugLog('üé• D√©marrage de la capture vid√©o...');
                
                scannerActif = true;
                interactive.style.display = 'block';
                
                Quagga.start();
                addDebugLog('üîç Scanner actif - En attente de code-barres');
                
                // Am√©lioration visuelle du canvas
                setTimeout(() => {
                    const canvas = Quagga.canvas.dom.overlay;
                    if (canvas) {
                        canvas.style.position = 'absolute';
                        canvas.style.top = '0';
                        canvas.style.left = '0';
                        canvas.style.width = '100%';
                        canvas.style.height = '100%';
                        addDebugLog('üé® Canvas configur√©');
                    }
                }, 100);
            });

            // Gestion de la d√©tection
            Quagga.onProcessed(function(result) {
                if (!result) return;
                
                const drawingCtx = Quagga.canvas.ctx.overlay;
                const drawingCanvas = Quagga.canvas.dom.overlay;

                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    
                    // Dessiner les zones de d√©tection potentielles
                    result.boxes.filter(box => box !== result.box).forEach(box => {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "yellow", lineWidth: 2});
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "blue", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'green', lineWidth: 3});
                }
            });

            Quagga.onDetected(function(result) {
                if (!result || !result.codeResult || !result.codeResult.code) return;
                
                const code = result.codeResult.code;
                const format = result.codeResult.format;
                
                addDebugLog(`üìä Code d√©tect√©: ${code} (${format})`);
                
                // V√©rifier que c'est un code valide (8 ou 13 chiffres)
                if (!/^\d{8,13}$/.test(code)) {
                    addDebugLog(`‚ö†Ô∏è Code invalide (format incorrect): ${code}`);
                    return;
                }

                // √âviter les d√©tections multiples du m√™me code
                if (code === dernierCodeDetecte) {
                    return;
                }

                dernierCodeDetecte = code;
                addDebugLog(`‚úÖ Code valid√©: ${code}`);

                // Vibration
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                    addDebugLog('üì≥ Vibration d√©clench√©e');
                }

                // Son de confirmation (optionnel)
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.3;
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    addDebugLog('üîî Son de confirmation jou√©');
                } catch (e) {
                    // Ignorer les erreurs audio
                }

                // Arr√™ter le scanner
                addDebugLog('‚è∏Ô∏è Arr√™t du scanner pour traitement');
                arreterScanner();
                
                // Rechercher le produit apr√®s un court d√©lai
                timeoutDetection = setTimeout(() => {
                    addDebugLog(`üîç Recherche du produit ${code} dans l'API...`);
                    rechercherProduitAPI(code);
                }, 200);
            });
        }

        function arreterScanner() {
            addDebugLog('üõë Arr√™t du scanner');
            
            const placeholder = document.getElementById('scanPlaceholder');
            const interactive = document.getElementById('interactive');
            const startBtn = document.getElementById('startScanBtn');
            const stopBtn = document.getElementById('stopScanBtn');

            if (scannerActif) {
                try {
                    Quagga.stop();
                    addDebugLog('‚úÖ Quagga arr√™t√©');
                } catch (e) {
                    addDebugLog('‚ö†Ô∏è Erreur lors de l\'arr√™t: ' + e.message);
                    console.error("Erreur arr√™t scanner:", e);
                }
                scannerActif = false;
            }

            interactive.style.display = 'none';
            placeholder.style.display = 'block';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';

            // R√©initialiser les variables
            dernierCodeDetecte = null;
            if (timeoutDetection) {
                clearTimeout(timeoutDetection);
                timeoutDetection = null;
            }
        }

        function rechercherCodeBarre() {
            const code = document.getElementById('manualBarcode').value.trim();
            
            addDebugLog(`‚å®Ô∏è Saisie manuelle: ${code}`);
            
            if (!code) {
                alert('Veuillez saisir un code-barres');
                return;
            }

            if (!/^\d{8,13}$/.test(code)) {
                alert('Le code-barres doit contenir entre 8 et 13 chiffres');
                addDebugLog(`‚ùå Code invalide: ${code}`);
                return;
            }

            addDebugLog(`‚úÖ Code valid√©: ${code}`);
            rechercherProduitAPI(code);
        }

        async function rechercherProduitAPI(barcode) {
            addDebugLog(`üåê Recherche du code-barres: ${barcode}`);
            
            // D'abord chercher dans la base personnelle
            const produitPerso = rechercherDansBasePerso(barcode);
            
            if (produitPerso) {
                addDebugLog(`‚úÖ Produit trouv√© dans la base personnelle: ${produitPerso.nom}`);
                document.getElementById('loadingScanner').style.display = 'none';
                afficherProduit({
                    product_name: produitPerso.nom,
                    brands: produitPerso.marque,
                    quantity: produitPerso.quantite,
                    image_url: produitPerso.image,
                    nutriments: {
                        'energy-kcal_100g': produitPerso.calories,
                        proteins_100g: produitPerso.proteines,
                        carbohydrates_100g: produitPerso.glucides,
                        fat_100g: produitPerso.lipides
                    }
                }, barcode);
                return;
            }
            
            addDebugLog(`üîç Produit non trouv√© dans la base perso, recherche sur OpenFoodFacts...`);
            
            document.getElementById('loadingScanner').style.display = 'block';
            document.getElementById('resultatScanner').style.display = 'none';
            document.getElementById('erreurScanner').style.display = 'none';

            try {
                const url = `https://world.openfoodfacts.org/api/v2/product/${barcode}.json`;
                addDebugLog(`üì° URL: ${url}`);
                
                const response = await fetch(url);
                addDebugLog(`üì• R√©ponse re√ßue: ${response.status} ${response.statusText}`);
                
                const data = await response.json();

                document.getElementById('loadingScanner').style.display = 'none';

                if (data.status === 1 && data.product) {
                    addDebugLog(`‚úÖ Produit trouv√© sur OpenFoodFacts: ${data.product.product_name || 'Sans nom'}`);
                    afficherProduit(data.product, barcode);
                } else {
                    addDebugLog(`‚ùå Produit non trouv√© sur OpenFoodFacts`);
                    document.getElementById('erreurScanner').style.display = 'block';
                    document.getElementById('erreurScanner').innerHTML = `
                        <h4 style="margin-bottom: 10px;">‚ùå Produit non trouv√©</h4>
                        <p style="margin-bottom: 15px;">Ce code-barres (${barcode}) n'a pas √©t√© trouv√© dans OpenFoodFacts ni dans votre base personnelle.</p>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <p style="color: #1565c0; font-weight: bold; margin-bottom: 10px;">üí° Conseil :</p>
                            <p style="color: #1565c0;">Vous pouvez ajouter ce produit manuellement dans l'onglet <strong>"Ma Base Perso"</strong> pour le retrouver facilement la prochaine fois !</p>
                            <button class="btn" onclick="allerVersBasePerso('${barcode}')" style="margin-top: 15px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                                üìù Ajouter √† ma base perso
                            </button>
                        </div>
                    `;
                    document.getElementById('erreurScanner').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } catch (error) {
                addDebugLog(`üí• Erreur API: ${error.message}`);
                console.error('Erreur API:', error);
                document.getElementById('loadingScanner').style.display = 'none';
                document.getElementById('erreurScanner').style.display = 'block';
                document.getElementById('erreurScanner').innerHTML = `
                    <h4 style="margin-bottom: 10px;">‚ùå Erreur de connexion</h4>
                    <p>Impossible de se connecter √† la base de donn√©es. V√©rifiez votre connexion internet et r√©essayez.</p>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #999;">D√©tails: ${error.message}</p>
                `;
            }
        }

        function allerVersBasePerso(barcode = '') {
            showTab('baseperso');
            document.querySelector('.tab[onclick*="baseperso"]').classList.add('active');
            
            if (barcode) {
                setTimeout(() => {
                    document.getElementById('codebarreProduitPerso').value = barcode;
                    document.getElementById('nomProduitPerso').focus();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
            }
        }

        function afficherProduit(product, barcode) {
            addDebugLog(`üì¶ Affichage des informations du produit`);
            
            dernierProduit = {
                barcode: barcode,
                nom: product.product_name || 'Nom non disponible',
                marque: product.brands || 'Marque inconnue',
                quantite: product.quantity || '',
                image: product.image_url || product.image_front_url || '',
                calories: product.nutriments?.['energy-kcal_100g'] || product.nutriments?.['energy-kcal'] || 0,
                proteines: product.nutriments?.proteins_100g || product.nutriments?.proteins || 0,
                glucides: product.nutriments?.carbohydrates_100g || product.nutriments?.carbohydrates || 0,
                lipides: product.nutriments?.fat_100g || product.nutriments?.fat || 0,
                nutriscore: product.nutriscore_grade || null,
                date: new Date().toISOString()
            };

            document.getElementById('productName').textContent = dernierProduit.nom;
            document.getElementById('productBrand').textContent = dernierProduit.marque;
            document.getElementById('productQuantity').textContent = dernierProduit.quantite;
            document.getElementById('productBarcode').textContent = `Code-barres: ${barcode}`;

            // Image
            const imgElement = document.getElementById('productImage');
            if (dernierProduit.image) {
                imgElement.src = dernierProduit.image;
                imgElement.style.display = 'block';
                addDebugLog(`üñºÔ∏è Image charg√©e`);
            } else {
                imgElement.style.display = 'none';
                addDebugLog(`‚ö†Ô∏è Pas d'image disponible`);
            }

            // Valeurs nutritionnelles
            document.getElementById('productCalories').textContent = Math.round(dernierProduit.calories);
            document.getElementById('productProteines').textContent = dernierProduit.proteines.toFixed(1);
            document.getElementById('productGlucides').textContent = dernierProduit.glucides.toFixed(1);
            document.getElementById('productLipides').textContent = dernierProduit.lipides.toFixed(1);

            addDebugLog(`üìä Nutrition - Cal: ${dernierProduit.calories}, Prot: ${dernierProduit.proteines}g, Gluc: ${dernierProduit.glucides}g, Lip: ${dernierProduit.lipides}g`);

            // Nutri-Score
            const nutriscoreContainer = document.getElementById('nutriscoreContainer');
            if (dernierProduit.nutriscore) {
                nutriscoreContainer.style.display = 'block';
                const nutriscoreImg = document.getElementById('nutriscoreImage');
                nutriscoreImg.src = `https://static.openfoodfacts.org/images/misc/nutriscore-${dernierProduit.nutriscore}.svg`;
                addDebugLog(`üèÜ Nutri-Score: ${dernierProduit.nutriscore.toUpperCase()}`);
            } else {
                nutriscoreContainer.style.display = 'none';
            }

            document.getElementById('resultatScanner').style.display = 'block';
            document.getElementById('resultatScanner').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            addDebugLog(`‚úÖ Produit affich√© avec succ√®s`);
        }

        function sauvegarderProduit() {
            if (!dernierProduit) return;

            addDebugLog(`üíæ Sauvegarde du produit: ${dernierProduit.nom}`);

            const index = produitsSauvegardes.findIndex(p => p.barcode === dernierProduit.barcode);
            
            if (index !== -1) {
                if (confirm('Ce produit est d√©j√† dans vos favoris. Voulez-vous mettre √† jour la date ?')) {
                    produitsSauvegardes[index] = dernierProduit;
                    addDebugLog(`üîÑ Produit mis √† jour`);
                } else {
                    return;
                }
            } else {
                produitsSauvegardes.unshift(dernierProduit);
                addDebugLog(`‚ûï Produit ajout√© aux favoris`);
            }

            localStorage.setItem('produits', JSON.stringify(produitsSauvegardes));
            afficherHistoriqueProduits();
            
            alert('‚úÖ Produit sauvegard√© avec succ√®s !');
            addDebugLog(`‚úÖ Produit sauvegard√© (total: ${produitsSauvegardes.length})`);
        }

        function afficherHistoriqueProduits() {
            const liste = document.getElementById('listeProduits');
            
            if (produitsSauvegardes.length === 0) {
                liste.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucun produit sauvegard√©</p>';
                return;
            }

            liste.innerHTML = produitsSauvegardes.map((produit, index) => `
                <div class="weight-item" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; font-size: 1.1em;">${produit.nom}</div>
                            <div style="color: #667eea; font-size: 0.9em;">${produit.marque}</div>
                            <div style="color: #999; font-size: 0.85em; margin-top: 3px;">
                                ${new Date(produit.date).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                        <button class="delete" onclick="supprimerProduit(${index})">Supprimer</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #667eea;">${Math.round(produit.calories)}</div>
                            <div style="font-size: 0.8em; color: #666;">kcal</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #f5576c;">${produit.proteines.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">prot√©ines</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #00f2fe;">${produit.glucides.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">glucides</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #38f9d7;">${produit.lipides.toFixed(1)}g</div>
                            <div style="font-size: 0.8em; color: #666;">lipides</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function supprimerProduit(index) {
            if (confirm('Voulez-vous vraiment supprimer ce produit ?')) {
                const produit = produitsSauvegardes[index];
                addDebugLog(`üóëÔ∏è Suppression du produit: ${produit.nom}`);
                produitsSauvegardes.splice(index, 1);
                localStorage.setItem('produits', JSON.stringify(produitsSauvegardes));
                afficherHistoriqueProduits();
            }
        }

        // ========== FIN FONCTIONS SCANNER ==========

        // ========== FONCTION DE LIAISON SCANNER -> CALCULATEUR ==========

        function ajouterProduitScanneAuCalculateur() {
            if (!dernierProduit) {
                alert('‚ö†Ô∏è Aucun produit scann√©');
                return;
            }

            // Demander la quantit√©
            const quantite = prompt(`üí° Quelle quantit√© de "${dernierProduit.nom}" voulez-vous ajouter ?\n\nEntrez le poids en grammes :`, '100');
            
            if (!quantite || isNaN(quantite) || quantite <= 0) {
                if (quantite !== null) {
                    alert('‚ö†Ô∏è Veuillez entrer une quantit√© valide en grammes');
                }
                return;
            }

            const quantiteNum = parseFloat(quantite);

            // Calculer les valeurs proportionnelles
            const ratio = quantiteNum / 100;
            const alimentCalcule = {
                nom: dernierProduit.nom,
                quantite: quantiteNum,
                calories: dernierProduit.calories * ratio,
                proteines: dernierProduit.proteines * ratio,
                glucides: dernierProduit.glucides * ratio,
                lipides: dernierProduit.lipides * ratio
            };

            // Ajouter au repas actuel
            repasActuel.push(alimentCalcule);
            
            // Afficher dans le calculateur
            afficherRepasActuel();

            // Afficher une notification de succ√®s
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                color: white;
                padding: 25px 40px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10002;
                text-align: center;
                font-size: 1.2em;
                font-weight: bold;
                animation: fadeIn 0.3s;
            `;
            notification.innerHTML = `
                <div style="font-size: 2.5em; margin-bottom: 10px;">‚úÖ</div>
                <div>Produit ajout√© au calculateur !</div>
                <div style="font-size: 0.85em; margin-top: 8px; opacity: 0.9;">${dernierProduit.nom} (${quantiteNum}g)</div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);

            // Proposer d'aller au calculateur
            setTimeout(() => {
                if (confirm('‚úÖ Produit ajout√© !\n\nüí° Voulez-vous aller au Calculateur de Calories pour voir votre repas ?')) {
                    showTab('calculateur');
                    document.querySelector('.tab[onclick*="calculateur"]').classList.add('active');
                }
            }, 2500);
        }

        // ========== FIN FONCTION DE LIAISON ==========

        // ========== FONCTION DE LIAISON HISTORIQUE -> CALCULATEUR ==========

        function ajouterProduitHistoriqueAuCalculateur(index) {
            const produit = produitsSauvegardes[index];
            
            if (!produit) {
                alert('‚ö†Ô∏è Produit introuvable');
                return;
            }

            // Demander la quantit√©
            const quantite = prompt(`üí° Quelle quantit√© de "${produit.nom}" voulez-vous ajouter ?\n\nEntrez le poids en grammes :`, '100');
            
            if (!quantite || isNaN(quantite) || quantite <= 0) {
                if (quantite !== null) {
                    alert('‚ö†Ô∏è Veuillez entrer une quantit√© valide en grammes');
                }
                return;
            }

            const quantiteNum = parseFloat(quantite);

            // Calculer les valeurs proportionnelles
            const ratio = quantiteNum / 100;
            const alimentCalcule = {
                nom: produit.nom,
                quantite: quantiteNum,
                calories: produit.calories * ratio,
                proteines: produit.proteines * ratio,
                glucides: produit.glucides * ratio,
                lipides: produit.lipides * ratio
            };

            // Ajouter au repas actuel
            repasActuel.push(alimentCalcule);
            
            // Afficher dans le calculateur
            afficherRepasActuel();

            // Notification de succ√®s
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                color: white;
                padding: 25px 40px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10002;
                text-align: center;
                font-size: 1.2em;
                font-weight: bold;
                animation: fadeIn 0.3s;
            `;
            notification.innerHTML = `
                <div style="font-size: 2.5em; margin-bottom: 10px;">‚úÖ</div>
                <div>Produit ajout√© au calculateur !</div>
                <div style="font-size: 0.85em; margin-top: 8px; opacity: 0.9;">${produit.nom} (${quantiteNum}g)</div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);

            // Proposer d'aller au calculateur
            setTimeout(() => {
                if (confirm('‚úÖ Produit ajout√© !\n\nüí° Voulez-vous aller au Calculateur de Calories pour voir votre repas ?')) {
                    showTab('calculateur');
                    document.querySelector('.tab[onclick*="calculateur"]').classList.add('active');
                }
            }, 2500);
        }

        // ========== FIN FONCTION DE LIAISON HISTORIQUE ==========

        // ========== FONCTIONS DE LIAISON FRIGO -> CALCULATEUR ==========

        function ajouterProduitFrigoAuCalculateur(index) {
            const produit = produitsFrigo[index];
            
            if (!produit) {
                alert('‚ö†Ô∏è Produit introuvable');
                return;
            }

            // Demander la quantit√©
            const quantite = prompt(`üí° Quelle quantit√© de "${produit.nom}" voulez-vous ajouter ?\n\nEntrez le poids en grammes :`, '100');
            
            if (!quantite || isNaN(quantite) || quantite <= 0) {
                if (quantite !== null) {
                    alert('‚ö†Ô∏è Veuillez entrer une quantit√© valide en grammes');
                }
                return;
            }

            const quantiteNum = parseFloat(quantite);

            // Calculer les valeurs proportionnelles
            const ratio = quantiteNum / 100;
            const alimentCalcule = {
                nom: produit.nom,
                quantite: quantiteNum,
                calories: produit.calories * ratio,
                proteines: produit.proteines * ratio,
                glucides: produit.glucides * ratio,
                lipides: produit.lipides * ratio
            };

            // Ajouter au repas actuel
            repasActuel.push(alimentCalcule);
            
            // Afficher dans le calculateur
            afficherRepasActuel();

            // Notification de succ√®s
            afficherNotificationAjout(produit.nom, quantiteNum);

            // Proposer d'aller au calculateur
            setTimeout(() => {
                if (confirm('‚úÖ Produit ajout√© !\n\nüí° Voulez-vous aller au Calculateur de Calories pour voir votre repas ?')) {
                    showTab('calculateur');
                    document.querySelector('.tab[onclick*="calculateur"]').classList.add('active');
                }
            }, 2500);
        }

        function ajouterProduitPersoAuCalculateur(index) {
            const produit = produitsPerso[index];
            
            if (!produit) {
                alert('‚ö†Ô∏è Produit introuvable');
                return;
            }

            // Demander la quantit√©
            const quantite = prompt(`üí° Quelle quantit√© de "${produit.nom}" voulez-vous ajouter ?\n\nEntrez le poids en grammes :`, '100');
            
            if (!quantite || isNaN(quantite) || quantite <= 0) {
                if (quantite !== null) {
                    alert('‚ö†Ô∏è Veuillez entrer une quantit√© valide en grammes');
                }
                return;
            }

            const quantiteNum = parseFloat(quantite);

            // Calculer les valeurs proportionnelles
            const ratio = quantiteNum / 100;
            const alimentCalcule = {
                nom: produit.nom,
                quantite: quantiteNum,
                calories: produit.calories * ratio,
                proteines: produit.proteines * ratio,
                glucides: produit.glucides * ratio,
                lipides: produit.lipides * ratio
            };

            // Ajouter au repas actuel
            repasActuel.push(alimentCalcule);
            
            // Afficher dans le calculateur
            afficherRepasActuel();

            // Notification de succ√®s
            afficherNotificationAjout(produit.nom, quantiteNum);

            // Proposer d'aller au calculateur
            setTimeout(() => {
                if (confirm('‚úÖ Produit ajout√© !\n\nüí° Voulez-vous aller au Calculateur de Calories pour voir votre repas ?')) {
                    showTab('calculateur');
                    document.querySelector('.tab[onclick*="calculateur"]').classList.add('active');
                }
            }, 2500);
        }

        // Fonction utilitaire pour afficher la notification
        function afficherNotificationAjout(nomProduit, quantite) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                color: white;
                padding: 25px 40px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10002;
                text-align: center;
                font-size: 1.2em;
                font-weight: bold;
                animation: fadeIn 0.3s;
            `;
            notification.innerHTML = `
                <div style="font-size: 2.5em; margin-bottom: 10px;">‚úÖ</div>
                <div>Produit ajout√© au calculateur !</div>
                <div style="font-size: 0.85em; margin-top: 8px; opacity: 0.9;">${nomProduit} (${quantite}g)</div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // ========== FIN FONCTIONS DE LIAISON FRIGO/BASE PERSO ==========

        // ========== FONCTION D'AJOUT RAPIDE DEPUIS LA BASE DE DONN√âES ==========

        function ajouterAlimentRapide(nomAliment) {
            const aliment = baseAliments.find(a => a.nom === nomAliment);
            
            if (!aliment) {
                alert('‚ö†Ô∏è Aliment introuvable');
                return;
            }

            // Ajouter directement 100g
            const alimentCalcule = {
                nom: aliment.nom,
                quantite: 100,
                calories: aliment.calories,
                proteines: aliment.proteines,
                glucides: aliment.glucides,
                lipides: aliment.lipides
            };

            repasActuel.push(alimentCalcule);
            afficherRepasActuel();
            
            // Fermer les suggestions
            document.getElementById('suggestionsAliments').style.display = 'none';
            document.getElementById('searchAliment').value = '';

            // Mini notification discr√®te
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
                z-index: 10002;
                font-size: 1em;
                font-weight: 600;
                animation: slideInRight 0.3s;
            `;
            notification.innerHTML = `‚úÖ ${aliment.nom} ajout√© (100g)`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // ========== FIN FONCTION D'AJOUT RAPIDE ==========

        // ========== SYST√àME DE NAVIGATION INTELLIGENTE ET SYNCHRONISATION ==========

        function actionRapide(action) {
            switch(action) {
                case 'scanner':
                    showTab('scanner');
                    document.querySelector('.tab[onclick*="scanner"]').classList.add('active');
                    setTimeout(() => {
                        alert('üí° Astuce : Apr√®s avoir scann√© un produit, cliquez sur "üßÆ Ajouter au Calculateur" pour construire votre repas !');
                    }, 500);
                    break;
                    
                case 'calculateur':
                    showTab('calculateur');
                    document.querySelector('.tab[onclick*="calculateur"]').classList.add('active');
                    document.getElementById('searchAliment').focus();
                    setTimeout(() => {
                        alert('üí° Astuce : Vous pouvez aussi ajouter des produits depuis le Scanner, le Frigo ou votre Base Perso !');
                    }, 500);
                    break;
                    
                case 'frigo':
                    if (produitsFrigo.length === 0) {
                        if (confirm('Votre frigo est vide ! Voulez-vous scanner des produits maintenant ?')) {
                            showTab('frigo');
                            document.querySelector('.tab[onclick*="frigo"]').classList.add('active');
                        }
                    } else {
                        showTab('frigo');
                        document.querySelector('.tab[onclick*="frigo"]').classList.add('active');
                        setTimeout(() => {
                            const genererBtn = document.querySelector('button[onclick="genererRecettes()"]');
                            if (genererBtn) {
                                genererBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                genererBtn.style.animation = 'pulse 1s 3';
                            }
                        }, 500);
                    }
                    break;
                    
                case 'coach':
                    actualiserCoachIA();
                    showTab('coachai');
                    document.querySelector('.tab[onclick*="coachai"]').classList.add('active');
                    break;
                    
                case 'progression':
                    showTab('suivi');
                    document.querySelector('.tab[onclick*="suivi"]').classList.add('active');
                    setTimeout(() => {
                        if (pesees.length < 2) {
                            alert('üí° Astuce : Enregistrez r√©guli√®rement votre poids pour suivre votre progression !');
                        }
                    }, 500);
                    break;
            }
        }

        // Fonction de synchronisation globale - appel√©e apr√®s chaque action importante
        function synchroniserDonnees() {
            // Actualiser le Coach IA si des donn√©es ont chang√©
            if (document.getElementById('coachai').classList.contains('active')) {
                actualiserCoachIA();
            }
            
            // Actualiser le calculateur si actif
            if (document.getElementById('calculateur').classList.contains('active')) {
                afficherRepasActuel();
                calculerCaloriesJour();
            }
            
            // Actualiser le graphique si actif
            if (document.getElementById('suivi').classList.contains('active')) {
                dessinerGraphique();
            }
        }

        // Syst√®me de suggestions contextuelles
        function afficherSuggestionContextuelle() {
            const maintenant = new Date().getHours();
            const aujourdhui = new Date().toDateString();
            const repasAujourdhui = repasSauvegardes.filter(r => new Date(r.date).toDateString() === aujourdhui);
            
            let suggestion = '';
            
            // Suggestions selon l'heure
            if (maintenant >= 6 && maintenant < 10 && repasAujourdhui.length === 0) {
                suggestion = '‚òÄÔ∏è Bon matin ! C\'est l\'heure du petit-d√©jeuner. Scannez ou ajoutez vos aliments dans le Calculateur !';
            } else if (maintenant >= 11 && maintenant < 14 && repasAujourdhui.length < 2) {
                suggestion = 'üçΩÔ∏è C\'est l\'heure du d√©jeuner ! N\'oubliez pas d\'enregistrer votre repas pour suivre vos calories.';
            } else if (maintenant >= 15 && maintenant < 17) {
                const caloriesJour = repasAujourdhui.reduce((total, r) => total + r.totaux.calories, 0);
                const objectifCal = userData.calories || 2000;
                if (caloriesJour < objectifCal * 0.7) {
                    suggestion = 'üçé Besoin d\'une collation ? Le Coach IA peut vous sugg√©rer des options adapt√©es √† vos calories restantes !';
                }
            } else if (maintenant >= 18 && maintenant < 21 && repasAujourdhui.length < 3) {
                suggestion = 'üåô C\'est bient√¥t l\'heure du d√Æner ! Consultez votre Frigo & Recettes pour des id√©es de repas √©quilibr√©s.';
            }
            
            // Suggestion si frigo vide mais pas utilis√© depuis longtemps
            if (produitsFrigo.length === 0 && produitsPerso.length === 0) {
                suggestion = 'üì¶ Cr√©ez votre base personnelle ou scannez vos produits pour g√©n√©rer des recettes automatiquement !';
            }
            
            return suggestion;
        }

        // Afficher une suggestion au chargement si pertinent
        function verifierEtAfficherSuggestion() {
            const derniereSuggestion = localStorage.getItem('derniereSuggestion');
            const aujourdhui = new Date().toDateString();
            
            if (derniereSuggestion !== aujourdhui) {
                const suggestion = afficherSuggestionContextuelle();
                if (suggestion) {
                    setTimeout(() => {
                        const afficher = confirm(suggestion + '\n\nVoulez-vous y acc√©der maintenant ?');
                        if (afficher) {
                            const heure = new Date().getHours();
                            if (heure >= 6 && heure < 10) actionRapide('calculateur');
                            else if (heure >= 11 && heure < 14) actionRapide('calculateur');
                            else if (heure >= 15 && heure < 17) actionRapide('coach');
                            else if (heure >= 18 && heure < 21) actionRapide('frigo');
                            else actionRapide('scanner');
                        }
                        localStorage.setItem('derniereSuggestion', aujourdhui);
                    }, 2000);
                }
            }
        }

        // Syst√®me de raccourcis clavier
        document.addEventListener('keydown', function(e) {
            // Alt + S = Scanner
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                actionRapide('scanner');
            }
            // Alt + C = Calculateur
            else if (e.altKey && e.key === 'c') {
                e.preventDefault();
                actionRapide('calculateur');
            }
            // Alt + F = Frigo
            else if (e.altKey && e.key === 'f') {
                e.preventDefault();
                actionRapide('frigo');
            }
            // Alt + P = Progression
            else if (e.altKey && e.key === 'p') {
                e.preventDefault();
                actionRapide('progression');
            }
        });

        // ========== FIN SYST√àME DE NAVIGATION INTELLIGENTE ==========

        // Redessiner le graphique lors du redimensionnement
        window.addEventListener('resize', () => {
            if (document.getElementById('suivi').classList.contains('active')) {
                dessinerGraphique();
            }
        });

        // Nettoyer Quagga si l'utilisateur quitte la page
        window.addEventListener('beforeunload', () => {
            if (scannerActif) {
                try {
                    Quagga.stop();
                } catch (e) {
                    // Ignorer
                }
            }
        });
    </script>
</body>
</html>
